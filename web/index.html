<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineVault</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.8.0/dist/mpegts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a1929 0%, #1a2332 50%, #0d1b2a 100%);
            background-attachment: fixed;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        .app-container { display: flex; height: 100vh; }

        /* ── Sidebar ── */
        .sidebar {
            width: 260px; min-width: 260px;
            background: linear-gradient(180deg, rgba(13,27,42,0.95) 0%, rgba(10,25,41,0.98) 100%);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0,217,255,0.15);
            padding: 25px 0; display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.3); overflow-y: auto;
        }

        .logo {
            padding: 0 25px 30px; font-size: 1.9rem; font-weight: 700;
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; display: flex; align-items: center; gap: 12px;
        }
        .logo::before {
            content: "\25B6"; font-size: 1.6rem;
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(0,217,255,0.5));
        }

        .nav-label {
            padding: 8px 25px; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 1.5px; color: #5a6a7f; font-weight: 600; margin-top: 8px;
        }
        .nav-section { margin-bottom: 8px; }

        .nav-item {
            padding: 12px 25px; margin: 2px 12px; color: #b8c5d6; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            display: flex; align-items: center; gap: 14px;
            font-size: 0.9rem; border-radius: 12px; position: relative;
        }
        .nav-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(180deg, #00D9FF 0%, #0099CC 100%);
            border-radius: 0 4px 4px 0; opacity: 0; transition: opacity 0.3s;
        }
        .nav-item:hover {
            background: linear-gradient(135deg, rgba(0,217,255,0.12) 0%, rgba(0,153,204,0.08) 100%);
            color: #00D9FF; transform: translateX(4px);
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(0,217,255,0.18) 0%, rgba(0,153,204,0.12) 100%);
            color: #00D9FF; box-shadow: 0 4px 12px rgba(0,217,255,0.2);
        }
        .nav-item.active::before { opacity: 1; }
        .nav-icon { width: 22px; text-align: center; font-size: 1rem; }
        .nav-badge {
            background: linear-gradient(135deg, rgba(0,217,255,0.25) 0%, rgba(0,153,204,0.2) 100%);
            color: #00D9FF; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;
        }

        /* ── Sidebar Library Context Menu ── */
        .nav-item-lib .nav-lib-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .nav-lib-dots {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; cursor: pointer; color: #5a6a7f; font-size: 1rem; font-weight: 700;
            opacity: 0; transition: all 0.2s; flex-shrink: 0; margin-left: auto;
            letter-spacing: 1px; line-height: 1;
        }
        .nav-item-lib:hover .nav-lib-dots,
        .nav-item-lib .nav-lib-dots.active { opacity: 1; }
        .nav-lib-dots:hover { background: rgba(0,217,255,0.15); color: #00D9FF; }
        .nav-item-lib:hover .nav-badge { display: none !important; }

        .lib-ctx-menu {
            position: fixed; z-index: 9999; display: none;
            background: linear-gradient(135deg, #1a2332 0%, #0d1b2a 100%);
            border: 1px solid rgba(0,217,255,0.25); border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,217,255,0.08);
            min-width: 200px; padding: 6px 0;
            animation: ctxFadeIn 0.15s ease;
        }
        .lib-ctx-menu.open { display: block; }
        @keyframes ctxFadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .lib-ctx-item {
            padding: 10px 16px; color: #b8c5d6; font-size: 0.82rem; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: all 0.15s;
        }
        .lib-ctx-item:first-child { border-radius: 10px 10px 0 0; }
        .lib-ctx-item:last-child { border-radius: 0 0 10px 10px; }
        .lib-ctx-item:hover { background: rgba(0,217,255,0.1); color: #00D9FF; }
        .lib-ctx-item .ctx-icon { width: 18px; text-align: center; font-size: 0.9rem; }
        .lib-ctx-sep { height: 1px; background: rgba(0,217,255,0.1); margin: 4px 12px; }

        /* ── Main Content ── */
        .main-content { flex: 1; overflow-y: auto; padding: 35px 45px; }

        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
        .section-title {
            font-size: 1.5rem; font-weight: 700;
            background: linear-gradient(135deg, #00D9FF 0%, #00B8DB 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .view-all { color: #8a9bae; font-size: 0.9rem; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.3s; }
        .view-all:hover { color: #00D9FF; background: rgba(0,217,255,0.1); }

        /* ── Media Grid ── */
        .media-grid-wrapper { display: flex; gap: 0; position: relative; }
        .media-grid-wrapper .media-grid { flex: 1; min-width: 0; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 22px; margin-bottom: 40px; }

        /* ── Alpha Jump Bar ── */
        .alpha-jump {
            position: sticky; top: 0; right: 0; align-self: flex-start;
            display: flex; flex-direction: column; align-items: center;
            padding: 6px 2px; margin-left: 4px; z-index: 10;
            background: rgba(13,27,42,0.85); backdrop-filter: blur(8px);
            border-radius: 12px; border: 1px solid rgba(0,217,255,0.1);
            user-select: none; min-width: 28px;
        }
        .alpha-jump-letter {
            font-size: 0.65rem; font-weight: 600; color: #4a6274;
            padding: 2px 6px; cursor: pointer; border-radius: 4px;
            transition: all 0.15s; line-height: 1.4; text-align: center;
        }
        .alpha-jump-letter:hover { color: #00D9FF; background: rgba(0,217,255,0.12); }
        .alpha-jump-letter.active { color: #00D9FF; background: rgba(0,217,255,0.18); }
        .alpha-jump-letter.disabled { color: #2a3a4a; cursor: default; }
        .alpha-jump-letter.disabled:hover { background: none; color: #2a3a4a; }

        /* ── Load More / Scroll Sentinel ── */
        .load-more-sentinel { grid-column: 1 / -1; display: flex; justify-content: center; padding: 20px; }
        .load-more-sentinel .spinner { width: 28px; height: 28px; }
        .media-card { cursor: pointer; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position: relative; }
        .media-card:hover { transform: translateY(-8px); }

        .media-poster {
            width: 100%; aspect-ratio: 2/3;
            background: linear-gradient(135deg, rgba(26,35,50,0.8) 0%, rgba(13,27,42,0.9) 100%);
            border-radius: 16px; overflow: hidden; position: relative;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,217,255,0.1);
            transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
        }
        .media-card:hover .media-poster { box-shadow: 0 12px 32px rgba(0,217,255,0.3), 0 0 0 2px rgba(0,217,255,0.3); }
        .media-poster img { width: 100%; height: 100%; object-fit: cover; }

        .quality-badge {
            position: absolute; top: 10px; right: 10px;
            background: linear-gradient(135deg, rgba(0,217,255,0.95) 0%, rgba(0,153,204,0.95) 100%);
            color: #0a1929; padding: 4px 9px; border-radius: 8px; font-size: 0.7rem; font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,217,255,0.4);
        }

        .progress-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 5px;
            background: rgba(255,255,255,0.15); border-radius: 0 0 16px 16px; overflow: hidden;
        }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00D9FF 0%, #0099CC 100%); box-shadow: 0 0 10px rgba(0,217,255,0.6); }

        .play-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(0,217,255,0.15) 0%, rgba(10,25,41,0.8) 100%);
            backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; border-radius: 16px;
        }
        .media-card:hover .play-overlay { opacity: 1; }

        .play-button {
            width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #0a1929; box-shadow: 0 8px 24px rgba(0,217,255,0.5);
        }

        .media-info { padding: 10px 2px; }
        .media-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #e5e5e5; }
        .media-meta { font-size: 0.78rem; color: #8a9bae; }

        /* ── Top Bar ── */
        .top-bar {
            position: sticky; top: 0;
            background: linear-gradient(180deg, rgba(10,25,41,0.95) 0%, rgba(13,27,42,0.9) 100%);
            backdrop-filter: blur(20px); padding: 18px 45px;
            border-bottom: 1px solid rgba(0,217,255,0.15);
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .search-box { position: relative; width: 420px; }
        .search-box input {
            width: 100%; padding: 12px 18px;
            background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(13,27,42,0.8) 100%);
            border: 1px solid rgba(0,217,255,0.2); border-radius: 12px;
            color: #e5e5e5; font-size: 0.9rem; transition: all 0.3s;
        }
        .search-box input:focus { outline: none; border-color: #00D9FF; background: linear-gradient(135deg, rgba(26,35,50,0.8) 0%, rgba(13,27,42,0.95) 100%); box-shadow: 0 0 20px rgba(0,217,255,0.2); }

        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #0a1929; cursor: pointer;
            box-shadow: 0 4px 16px rgba(0,217,255,0.4); transition: all 0.3s; font-size: 0.95rem;
        }
        .user-avatar:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,217,255,0.6); }

        /* ── Empty State ── */
        .empty-state { text-align: center; padding: 60px 25px; color: #8a9bae; background: linear-gradient(135deg, rgba(26,35,50,0.4) 0%, rgba(13,27,42,0.6) 100%); border-radius: 20px; border: 1px solid rgba(0,217,255,0.1); margin: 10px 0 30px; }
        .empty-state-icon { font-size: 3.5rem; margin-bottom: 18px; }
        .empty-state-title { font-size: 1.2rem; margin-bottom: 8px; color: #b8c5d6; font-weight: 600; }

        /* ── Buttons ── */
        .btn-primary {
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            color: #0a1929; padding: 12px 24px; border: none; border-radius: 12px;
            font-weight: 600; cursor: pointer; font-size: 0.9rem;
            box-shadow: 0 6px 20px rgba(0,217,255,0.3); transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,217,255,0.5); }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(0,217,255,0.15) 0%, rgba(0,153,204,0.1) 100%);
            color: #00D9FF; padding: 10px 20px; border: 1px solid rgba(0,217,255,0.3);
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;
        }
        .btn-secondary:hover { background: linear-gradient(135deg, rgba(0,217,255,0.25) 0%, rgba(0,153,204,0.2) 100%); box-shadow: 0 4px 16px rgba(0,217,255,0.3); }

        .btn-danger {
            background: linear-gradient(135deg, rgba(255,59,48,0.15) 0%, rgba(255,59,48,0.1) 100%);
            color: #ff6b6b; padding: 10px 20px; border: 1px solid rgba(255,59,48,0.3);
            border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: all 0.3s;
        }
        .btn-danger:hover { background: linear-gradient(135deg, rgba(255,59,48,0.25) 0%, rgba(255,59,48,0.2) 100%); }

        .btn-small { padding: 6px 14px; font-size: 0.78rem; }

        /* ── Modal ── */
        .modal {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, rgba(10,25,41,0.95) 0%, rgba(13,27,42,0.97) 100%);
            backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, rgba(26,35,50,0.95) 0%, rgba(13,27,42,0.98) 100%);
            border: 1px solid rgba(0,217,255,0.3); border-radius: 20px;
            padding: 40px; max-width: 600px; width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,217,255,0.2);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-title {
            font-size: 1.6rem;
            background: linear-gradient(135deg, #00D9FF 0%, #00B8DB 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 30px; text-align: center; font-weight: 700;
        }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; color: #b8c5d6; font-size: 0.85rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px 14px;
            background: linear-gradient(135deg, rgba(10,25,41,0.6) 0%, rgba(13,27,42,0.8) 100%);
            border: 1px solid rgba(0,217,255,0.2); border-radius: 12px;
            color: #e5e5e5; font-size: 0.9rem; transition: all 0.3s; font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #00D9FF; box-shadow: 0 0 20px rgba(0,217,255,0.2); }
        .form-group select option { background: #1a2332; color: #e5e5e5; }

        .message { padding: 12px; border-radius: 12px; margin-bottom: 18px; font-size: 0.85rem; }
        .message.error { background: linear-gradient(135deg, rgba(255,59,48,0.15) 0%, rgba(255,59,48,0.1) 100%); border: 1px solid rgba(255,59,48,0.4); color: #ff6b6b; }
        .message.success { background: linear-gradient(135deg, rgba(52,199,89,0.15) 0%, rgba(52,199,89,0.1) 100%); border: 1px solid rgba(52,199,89,0.4); color: #51cf66; }

        /* ── Cards ── */
        .library-card {
            padding: 22px;
            background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(13,27,42,0.8) 100%);
            border: 1px solid rgba(0,217,255,0.2); border-radius: 16px; margin-bottom: 14px;
            transition: all 0.3s; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: flex; justify-content: space-between; align-items: center;
        }
        .library-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,217,255,0.2); border-color: rgba(0,217,255,0.4); }
        .scan-progress { margin-top: 8px; display: none; }
        .scan-progress.active { display: block; }
        .scan-progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .scan-progress-fill { height: 100%; background: linear-gradient(90deg, #00D9FF 0%, #0099CC 100%); box-shadow: 0 0 8px rgba(0,217,255,0.5); border-radius: 3px; width: 0%; transition: width 0.3s ease; }
        .scan-progress-text { color: #8a9bae; font-size: 0.75rem; margin-top: 4px; display: flex; justify-content: space-between; }
        .scan-progress-text .filename { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .library-card h3 {
            background: linear-gradient(135deg, #00D9FF 0%, #00B8DB 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 8px; font-size: 1.1rem;
        }
        .library-actions { display: flex; gap: 10px; align-items: center; }

        .group-card {
            padding: 20px;
            background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(13,27,42,0.8) 100%);
            border: 1px solid rgba(0,217,255,0.15); border-radius: 16px;
            margin-bottom: 12px; transition: all 0.3s;
        }
        .group-card:hover { border-color: rgba(0,217,255,0.35); box-shadow: 0 4px 16px rgba(0,217,255,0.15); }
        .group-card h4 { color: #00D9FF; margin-bottom: 6px; }
        .group-card p { color: #8a9bae; font-size: 0.85rem; }

        .tag { display: inline-block; padding: 3px 10px; border-radius: 8px; font-size: 0.72rem; font-weight: 600; margin-right: 6px; margin-top: 8px; }
        .tag-cyan { background: rgba(0,217,255,0.15); color: #00D9FF; border: 1px solid rgba(0,217,255,0.3); }
        .tag-purple { background: rgba(168,85,247,0.15); color: #a78bfa; border: 1px solid rgba(168,85,247,0.3); }
        .tag-green { background: rgba(52,199,89,0.15); color: #51cf66; border: 1px solid rgba(52,199,89,0.3); }
        .tag-orange { background: rgba(255,159,64,0.15); color: #ffa94d; border: 1px solid rgba(255,159,64,0.3); }
        .tag-red { background: rgba(255,59,48,0.15); color: #ff6b6b; border: 1px solid rgba(255,59,48,0.3); }

        /* ── Toast ── */
        .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 14px 24px; border-radius: 12px; font-size: 0.9rem; animation: slideInRight 0.3s ease-out; box-shadow: 0 8px 24px rgba(0,0,0,0.5); backdrop-filter: blur(20px); }
        .toast.success { background: rgba(10,25,41,0.95); border: 1px solid rgba(52,199,89,0.5); color: #51cf66; }
        .toast.error { background: rgba(10,25,41,0.95); border: 1px solid rgba(255,59,48,0.5); color: #ff6b6b; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* ── Continue Watching ── */
        .continue-row { display: flex; gap: 18px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 30px; }
        .continue-row .media-card { min-width: 180px; flex-shrink: 0; }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(13,27,42,0.5); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(0,217,255,0.4) 0%, rgba(0,153,204,0.4) 100%); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, rgba(0,217,255,0.6) 0%, rgba(0,153,204,0.6) 100%); }

        .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(0,217,255,0.3); border-top: 2px solid #00D9FF; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Video Player ── */
        .video-player-overlay {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: none; flex-direction: column;
        }
        .video-player-overlay.active { display: flex; }

        .player-top-bar {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px 30px;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 5010; display: flex; justify-content: space-between; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .video-player-overlay:hover .player-top-bar { opacity: 1; }

        .player-title { color: #fff; font-size: 1.2rem; font-weight: 600; }
        .player-close { color: #fff; font-size: 1.5rem; cursor: pointer; padding: 8px 14px; border-radius: 8px; background: rgba(255,255,255,0.1); border: none; transition: all 0.3s; }
        .player-close:hover { background: rgba(255,59,48,0.4); }

        #videoPlayer { width: 100%; height: 100%; background: #000; }

        .player-controls {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 16px 30px 24px;
            background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            z-index: 5010; opacity: 0; transition: opacity 0.3s;
        }
        .video-player-overlay:hover .player-controls { opacity: 1; }

        .player-progress { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; cursor: pointer; margin-bottom: 14px; position: relative; }
        .player-progress-fill { height: 100%; background: linear-gradient(90deg, #00D9FF, #0099CC); border-radius: 3px; width: 0; transition: width 0.1s; }

        .player-btns { display: flex; align-items: center; gap: 18px; }
        .player-btn { background: none; border: none; color: #fff; font-size: 1.3rem; cursor: pointer; padding: 6px; transition: color 0.2s; }
        .player-btn:hover { color: #00D9FF; }
        .player-time { color: #ccc; font-size: 0.85rem; }
        .player-quality-select { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; padding: 4px 10px; font-size: 0.8rem; margin-left: auto; }

        /* ── Detail Page ── */
        .detail-hero {
            display: flex; gap: 35px; margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(26,35,50,0.4) 0%, rgba(13,27,42,0.6) 100%);
            border-radius: 20px; padding: 30px; border: 1px solid rgba(0,217,255,0.1);
        }
        .detail-poster { width: 220px; min-width: 220px; height: 330px; border-radius: 16px; overflow: hidden; box-shadow: 0 12px 32px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 4rem; background: linear-gradient(135deg, rgba(26,35,50,0.8) 0%, rgba(13,27,42,0.9) 100%); flex-shrink: 0; }
        .detail-poster img { width: 100%; height: 100%; object-fit: cover; }
        .detail-info { flex: 1; min-width: 0; overflow: hidden; }
        .detail-info h1 { font-size: 2rem; margin-bottom: 8px; color: #fff; }
        .detail-info .meta-row { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; color: #8a9bae; font-size: 0.95rem; }
        .detail-info .description { color: #b8c5d6; line-height: 1.7; margin-bottom: 20px; }
        .detail-actions { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .detail-tabs { display: flex; gap: 4px; margin-bottom: 20px; }
        .detail-tab { padding: 10px 20px; border-radius: 10px; cursor: pointer; color: #8a9bae; font-size: 0.9rem; transition: all 0.2s; border: none; background: none; }
        .detail-tab.active { color: #00D9FF; background: rgba(0,217,255,0.12); }
        .detail-tab:hover { color: #00D9FF; }
        .detail-tab-content { min-height: 100px; overflow: hidden; }

        /* ── Person Grid ── */
        .person-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 18px; }
        .person-card { text-align: center; cursor: pointer; transition: transform 0.2s; }
        .person-card:hover { transform: translateY(-4px); }
        .person-avatar { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 10px; background: linear-gradient(135deg, rgba(0,217,255,0.2) 0%, rgba(0,153,204,0.15) 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem; border: 2px solid rgba(0,217,255,0.2); overflow: hidden; }
        .person-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .person-name { font-size: 0.85rem; color: #e5e5e5; font-weight: 500; }
        .person-role { font-size: 0.75rem; color: #5a6a7f; }
        .cast-row { position: relative; overflow: hidden; }
        .cast-row-scroll { display: flex; gap: 24px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; max-width: 100%; }
        .cast-row-scroll::-webkit-scrollbar { display: none; }
        .cast-row-arrow { position: absolute; top: 40%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 1px solid rgba(0,217,255,0.3); color: #fff; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2; transition: background 0.2s; }
        .cast-row-arrow:hover { background: rgba(0,217,255,0.3); }
        .cast-row-arrow.left { left: -12px; }
        .cast-row-arrow.right { right: -12px; }
        .cast-card { text-align: center; flex: 0 0 110px; cursor: pointer; }
        .cast-card .person-avatar { width: 90px; height: 90px; margin: 0 auto 8px; }
        .cast-card .person-name { font-size: 0.82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cast-card .person-role { font-size: 0.72rem; color: #8a9bae; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ── Settings / Admin Grid ── */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .settings-card {
            padding: 25px; border-radius: 16px;
            background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(13,27,42,0.8) 100%);
            border: 1px solid rgba(0,217,255,0.15);
        }
        .settings-card h3 { color: #00D9FF; margin-bottom: 16px; font-size: 1.1rem; }

        /* ── Status indicator ── */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-dot.green { background: #51cf66; box-shadow: 0 0 8px rgba(52,199,89,0.5); }
        .status-dot.red { background: #ff6b6b; box-shadow: 0 0 8px rgba(255,59,48,0.5); }
        .status-dot.yellow { background: #ffa94d; box-shadow: 0 0 8px rgba(255,159,64,0.5); }

        /* ── Job list ── */
        .job-item { display: flex; align-items: center; gap: 14px; padding: 12px 16px; border-radius: 10px; background: rgba(0,0,0,0.2); margin-bottom: 8px; }
        .job-progress-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .job-progress-fill { height: 100%; background: linear-gradient(90deg, #00D9FF, #0099CC); border-radius: 3px; transition: width 0.3s; }

        /* ── Ratings Row ── */
        .ratings-row { display: flex; gap: 16px; flex-wrap: wrap; margin: 12px 0; }
        .rating-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 12px; font-size: 0.82rem; font-weight: 600; }
        .rating-tmdb { background: rgba(1,180,228,0.15); color: #01b4e4; border: 1px solid rgba(1,180,228,0.3); }
        .rating-imdb { background: rgba(245,197,24,0.15); color: #f5c518; border: 1px solid rgba(245,197,24,0.3); }
        .rating-rt { background: rgba(250,50,10,0.15); color: #fa320a; border: 1px solid rgba(250,50,10,0.3); }
        .rating-audience { background: rgba(100,200,100,0.15); color: #64c864; border: 1px solid rgba(100,200,100,0.3); }
        .rating-badge .rating-icon { font-size: 1rem; }
        .rating-badge .rating-value { font-size: 0.95rem; font-weight: 700; }
        .rating-badge .rating-label { font-size: 0.72rem; color: #8a9bae; font-weight: 400; }

        /* ── Genre Tags ── */
        .genre-tags { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
        .genre-tag { padding: 4px 12px; border-radius: 20px; font-size: 0.78rem; font-weight: 500; background: rgba(168,85,247,0.15); color: #c084fc; border: 1px solid rgba(168,85,247,0.25); cursor: default; }

        /* ── Duplicate Review ── */
        .dup-group { padding: 24px; border-radius: 16px; background: linear-gradient(135deg, rgba(26,35,50,0.6) 0%, rgba(13,27,42,0.8) 100%); border: 1px solid rgba(0,217,255,0.15); margin-bottom: 20px; }
        .dup-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .dup-type-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .dup-type-exact { background: rgba(255,107,107,0.2); color: #ff6b6b; border: 1px solid rgba(255,107,107,0.3); }
        .dup-type-potential { background: rgba(255,169,77,0.2); color: #ffa94d; border: 1px solid rgba(255,169,77,0.3); }
        .dup-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px; }
        .dup-card { padding: 16px; border-radius: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.06); }
        .dup-card-header { display: flex; gap: 12px; margin-bottom: 12px; }
        .dup-card-poster { width: 80px; height: 120px; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3); flex-shrink: 0; }
        .dup-card-poster img { width: 100%; height: 100%; object-fit: cover; }
        .dup-card-meta { flex: 1; }
        .dup-card-meta h4 { color: #00D9FF; margin-bottom: 6px; font-size: 1rem; }
        .dup-card-meta p { color: #8a9bae; font-size: 0.82rem; margin-bottom: 4px; }
        .dup-match-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 600; }
        .dup-match-md5 { background: rgba(255,107,107,0.15); color: #ff6b6b; }
        .dup-match-phash { background: rgba(255,169,77,0.15); color: #ffa94d; }
        .dup-decisions { padding: 10px 14px; border-radius: 8px; background: rgba(0,0,0,0.15); margin-bottom: 16px; font-size: 0.82rem; color: #8a9bae; }
        .dup-decisions strong { color: #e5e5e5; }
        .dup-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .dup-actions .btn-edit { background: linear-gradient(135deg, #00D9FF, #00B8DB); color: #0a1929; border: none; }
        .dup-actions .btn-edition { background: linear-gradient(135deg, #a855f7, #7c3aed); color: #fff; border: none; }
        .nav-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; border-radius: 10px; background: #ff6b6b; color: #fff; font-size: 0.7rem; font-weight: 700; margin-left: auto; }
        .edition-badge { position: absolute; bottom: 8px; left: 8px; padding: 2px 8px; border-radius: 8px; background: rgba(168,85,247,0.85); color: #fff; font-size: 0.7rem; font-weight: 600; backdrop-filter: blur(4px); }
        /* ── Merge Edition Modal ── */
        .merge-modal-overlay {
            position: fixed; inset: 0; z-index: 3100;
            background: rgba(10,25,41,0.92); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
        }
        .merge-modal-overlay.active { display: flex; }
        .merge-modal {
            background: linear-gradient(135deg, rgba(26,35,50,0.97) 0%, rgba(13,27,42,0.99) 100%);
            border: 1px solid rgba(168,85,247,0.3); border-radius: 20px;
            padding: 32px; width: 90%; max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        .merge-modal-title {
            font-size: 1.3rem; font-weight: 700; margin-bottom: 20px;
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .merge-option { padding: 12px 16px; border-radius: 10px; background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.06); margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .merge-option:hover { border-color: rgba(168,85,247,0.4); }
        .merge-option.selected { border-color: #a855f7; background: rgba(168,85,247,0.1); }
        .merge-option label { cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .merge-option input[type="radio"] { accent-color: #a855f7; }

        /* ── WS status ── */
        .ws-status { font-size: 0.7rem; padding: 4px 10px; border-radius: 8px; }

        /* ── Task Activity Indicator ── */
        .task-indicator {
            position: relative; width: 36px; height: 36px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .task-indicator.active { animation: task-pulse 2s ease-in-out infinite; border-radius: 50%; }
        @keyframes task-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0,217,255,0.3); }
            50% { box-shadow: 0 0 0 8px rgba(0,217,255,0); }
        }
        .task-ring { width: 36px; height: 36px; }
        .task-ring-bg { fill: none; stroke: rgba(0,217,255,0.15); stroke-width: 3; }
        .task-ring-fill { fill: none; stroke: #00D9FF; stroke-width: 3; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .task-count {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.72rem; font-weight: 700; color: #00D9FF; pointer-events: none;
        }
        .task-tooltip {
            display: none; position: absolute; top: calc(100% + 10px); right: 0;
            background: linear-gradient(135deg, rgba(13,27,42,0.98) 0%, rgba(10,20,35,0.98) 100%);
            border: 1px solid rgba(0,217,255,0.25); border-radius: 12px;
            padding: 14px 16px; min-width: 280px; max-width: 340px; z-index: 200;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6); backdrop-filter: blur(20px);
        }
        .task-indicator:hover .task-tooltip { display: block; }
        .task-tooltip-header {
            font-size: 0.72rem; color: #5a6a7f; text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,217,255,0.1);
        }
        .task-tooltip-item { padding: 8px 0; border-bottom: 1px solid rgba(0,217,255,0.06); }
        .task-tooltip-item:last-child { border-bottom: none; }
        .task-tooltip-name { font-size: 0.82rem; color: #e5e5e5; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-tooltip-progress { display: flex; align-items: center; gap: 10px; }
        .task-tooltip-bar {
            flex: 1; height: 4px; background: rgba(0,217,255,0.12); border-radius: 2px; overflow: hidden;
        }
        .task-tooltip-bar-fill {
            height: 100%; background: linear-gradient(90deg, #00D9FF, #0099CC); border-radius: 2px;
            transition: width 0.4s ease;
        }
        .task-tooltip-pct { font-size: 0.72rem; color: #00D9FF; min-width: 36px; text-align: right; font-weight: 600; }

        /* ── Library Folders ── */
        .folder-list { display: flex; flex-direction: column; gap: 8px; }
        .folder-row {
            display: flex; gap: 8px; align-items: center;
            padding: 8px 12px; border-radius: 10px;
            background: rgba(0,0,0,0.2); border: 1px solid rgba(0,217,255,0.1);
        }
        .folder-row input { flex: 1; }
        .folder-remove {
            background: none; border: none; color: #ff6b6b; cursor: pointer;
            font-size: 1.1rem; padding: 4px 8px; border-radius: 6px; transition: background 0.2s;
        }
        .folder-remove:hover { background: rgba(255,59,48,0.15); }
        .folder-add-btn {
            display: inline-flex; align-items: center; gap: 6px;
            color: #00D9FF; background: none; border: 1px dashed rgba(0,217,255,0.3);
            padding: 8px 14px; border-radius: 10px; cursor: pointer;
            font-size: 0.85rem; margin-top: 4px; transition: all 0.2s;
        }
        .folder-add-btn:hover { background: rgba(0,217,255,0.08); border-color: rgba(0,217,255,0.5); }

        /* ── Option Toggle Row ── */
        .option-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border-radius: 12px; margin-bottom: 10px;
            background: linear-gradient(135deg, rgba(26,35,50,0.5) 0%, rgba(13,27,42,0.7) 100%);
            border: 1px solid rgba(0,217,255,0.08);
        }
        .option-row-info { flex: 1; }
        .option-row-label { color: #e5e5e5; font-size: 0.9rem; font-weight: 600; }
        .option-row-desc { color: #8a9bae; font-size: 0.78rem; margin-top: 2px; }
        .toggle-btns { display: flex; gap: 0; }
        .toggle-btns label {
            padding: 6px 16px; cursor: pointer; font-size: 0.82rem; font-weight: 600;
            color: #8a9bae; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,217,255,0.15);
            transition: all 0.2s;
        }
        .toggle-btns label:first-child { border-radius: 8px 0 0 8px; }
        .toggle-btns label:last-child { border-radius: 0 8px 8px 0; border-left: none; }
        .toggle-btns input[type="radio"] { display: none; }
        .toggle-btns input[type="radio"]:checked + span {
            color: #0a1929;
        }
        .toggle-btns label:has(input:checked) {
            background: linear-gradient(135deg, #00D9FF 0%, #0099CC 100%);
            color: #0a1929; border-color: #00D9FF;
        }
        .toggle-btns label:has(input:checked) span { color: #0a1929; }

        /* ── Library Settings Tags ── */
        .lib-settings-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }

        /* ── Edit Media Modal ── */
        .edit-modal-overlay {
            position: fixed; inset: 0; z-index: 3000;
            background: rgba(10,25,41,0.92); backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center;
        }
        .edit-modal-overlay.active { display: flex; }
        .edit-modal {
            background: linear-gradient(135deg, rgba(26,35,50,0.97) 0%, rgba(13,27,42,0.99) 100%);
            border: 1px solid rgba(0,217,255,0.3); border-radius: 20px;
            padding: 36px 40px; width: 560px; max-width: 95vw;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,217,255,0.15);
        }
        .edit-modal-title {
            font-size: 1.4rem; font-weight: 700; margin-bottom: 24px;
            background: linear-gradient(135deg, #00D9FF 0%, #00B8DB 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .edit-modal-actions {
            display: flex; gap: 10px; justify-content: flex-end;
            margin-top: 24px; padding-top: 18px;
            border-top: 1px solid rgba(0,217,255,0.1);
        }
        .edit-field-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
        }
        .lock-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;
        }
        .lock-badge.locked {
            background: rgba(255,159,64,0.15); color: #ffa94d;
            border: 1px solid rgba(255,159,64,0.3);
        }
        .lock-badge.unlocked {
            background: rgba(52,199,89,0.15); color: #51cf66;
            border: 1px solid rgba(52,199,89,0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">CineVault</div>

            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-view="home"><span class="nav-icon">&#127968;</span><span>Home</span></div>
            </div>

            <div class="nav-section" id="librariesNav">
                <div class="nav-label">Libraries</div>
            </div>

            <div class="nav-section">
                <div class="nav-label">Organize</div>
                <div class="nav-item" data-view="collections"><span class="nav-icon">&#11088;</span><span>Collections</span></div>
                <div class="nav-item" data-view="performers"><span class="nav-icon">&#128100;</span><span>Performers</span></div>
                <div class="nav-item" data-view="tags"><span class="nav-icon">&#127991;</span><span>Tags</span></div>
                <div class="nav-item" data-view="studios"><span class="nav-icon">&#127980;</span><span>Studios</span></div>
            </div>

            <div class="nav-section">
                <div class="nav-label">Manage</div>
                <div class="nav-item" data-view="duplicates"><span class="nav-icon">&#128257;</span><span>Duplicate Review</span><span class="nav-badge" id="dupBadge" style="display:none;">0</span></div>
            </div>

            <div class="nav-section">
                <div class="nav-label">System</div>
                <div class="nav-item" id="settingsNavItem"><span class="nav-icon">&#9881;</span><span>Settings</span></div>
                <div class="nav-item" data-view="admin"><span class="nav-icon">&#128736;</span><span>Admin</span></div>
            </div>

            <div style="margin-top: auto; padding: 15px 0;">
                <div class="nav-item" id="logoutBtn" style="color: #ff6b6b;"><span class="nav-icon">&#128682;</span><span>Logout</span></div>
            </div>
        </div>

        <!-- Main Content -->
        <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
            <div class="top-bar">
                <div class="search-box">
                    <input type="text" placeholder="Search your media..." id="searchInput">
                </div>
                <div class="user-menu">
                    <div class="task-indicator" id="taskIndicator" style="display:none;">
                        <svg class="task-ring" viewBox="0 0 36 36">
                            <circle class="task-ring-bg" cx="18" cy="18" r="15.9155"/>
                            <circle class="task-ring-fill" id="taskRingFill" cx="18" cy="18" r="15.9155"
                                stroke-dasharray="100" stroke-dashoffset="100"
                                transform="rotate(-90 18 18)"/>
                        </svg>
                        <span class="task-count" id="taskCount"></span>
                        <div class="task-tooltip" id="taskTooltip"></div>
                    </div>
                    <span class="ws-status" id="wsStatus" style="display:none;"></span>
                    <div class="user-avatar" id="userAvatar">?</div>
                </div>
            </div>
            <div class="main-content" id="mainContent"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <h2 class="modal-title">Welcome to CineVault</h2>
            <div id="authMessage"></div>
            <form id="loginForm">
                <div class="form-group"><label>Username</label><input type="text" id="loginUsername" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
            </form>
        </div>
    </div>

    <!-- Video Player Overlay -->
    <div class="video-player-overlay" id="playerOverlay">
        <div class="player-top-bar">
            <span class="player-title" id="playerTitle"></span>
            <button class="player-close" onclick="closePlayer()">&#10005;</button>
        </div>
        <video id="videoPlayer"></video>
        <div class="player-controls">
            <div class="player-progress" id="playerProgress" onclick="seekPlayer(event)">
                <div class="player-progress-fill" id="playerProgressFill"></div>
            </div>
            <div class="player-btns">
                <button class="player-btn" onclick="togglePlay()">&#9654;&#10074;&#10074;</button>
                <button class="player-btn" onclick="skipBack()">&#9194;</button>
                <button class="player-btn" onclick="skipForward()">&#9193;</button>
                <span class="player-time" id="playerTime">0:00 / 0:00</span>
                <button class="player-btn" onclick="toggleMute()">&#128266;</button>
                <select class="player-quality-select" id="qualitySelect" onchange="changeQuality(this.value)"></select>
                <button class="player-btn" onclick="toggleFullscreen()" style="margin-left:auto;">&#9974;</button>
            </div>
        </div>
    </div>

    <!-- Edit Media Modal -->
    <div class="edit-modal-overlay" id="editMediaOverlay">
        <div class="edit-modal">
            <div class="edit-modal-title">Edit Media Item</div>
            <input type="hidden" id="editMediaId">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="editTitle">
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Sort Title</label>
                    <input type="text" id="editSortTitle" placeholder="Leave blank to use title">
                </div>
                <div class="form-group">
                    <label>Original Title</label>
                    <input type="text" id="editOriginalTitle" placeholder="Original language title">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editDescription" rows="4" placeholder="Synopsis or description"></textarea>
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="editYear" min="1800" max="2100" placeholder="e.g. 2024">
                </div>
                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="editReleaseDate">
                </div>
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Rating</label>
                    <input type="number" id="editRating" min="0" max="10" step="0.1" placeholder="0.0 – 10.0">
                </div>
                <div class="form-group">
                    <label>Edition</label>
                    <select id="editEditionType">
                        <option value="Theatrical">Theatrical</option>
                        <option value="Director's Cut">Director's Cut</option>
                        <option value="Extended">Extended</option>
                        <option value="Extended Edition">Extended Edition</option>
                        <option value="Unrated">Unrated</option>
                        <option value="Remastered">Remastered</option>
                        <option value="IMAX">IMAX</option>
                        <option value="4K Remaster">4K Remaster</option>
                        <option value="Special Edition">Special Edition</option>
                        <option value="Alternate">Alternate</option>
                    </select>
                </div>
            </div>
            <div id="editLockStatus" style="margin-top:8px;"></div>
            <div class="edit-modal-actions">
                <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-danger" id="editResetBtn" style="display:none;" onclick="resetMediaMeta()">&#8635; Reset Lock</button>
                <button class="btn-primary" onclick="saveMediaEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Merge as Edition Modal -->
    <div class="merge-modal-overlay" id="mergeEditionOverlay">
        <div class="merge-modal">
            <div class="merge-modal-title">Merge as Edition</div>
            <input type="hidden" id="mergeItemA">
            <input type="hidden" id="mergeItemB">
            <div class="form-group">
                <label>Edition Label</label>
                <select id="mergeEditionLabel">
                    <option value="Theatrical">Theatrical</option>
                    <option value="Director's Cut">Director's Cut</option>
                    <option value="Extended">Extended</option>
                    <option value="Unrated">Unrated</option>
                    <option value="IMAX">IMAX</option>
                    <option value="4K Remaster">4K Remaster</option>
                    <option value="Special Edition">Special Edition</option>
                    <option value="Alternate">Alternate</option>
                </select>
            </div>
            <div class="form-group">
                <label>Select Primary Item</label>
                <div id="mergePrimaryOptions"></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button class="btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn-primary" onclick="submitMergeEdition()" style="background:linear-gradient(135deg,#a855f7,#7c3aed);">Merge</button>
            </div>
        </div>
    </div>

    <!-- Library Context Menu (shared, fixed-position) -->
    <div class="lib-ctx-menu" id="libCtxMenu"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const API = '/api/v1';
    let currentUser = null;
    let allLibraries = [];
    let ws = null;
    let hlsPlayer = null;
    let mpegtsPlayer = null;
    let currentMediaId = null;
    const activeTasks = {};
    let taskFadeTimer = null;

    function headers() { return { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' }; }

    async function api(method, path, body) {
        const opts = { method, headers: headers() };
        if (body) opts.body = JSON.stringify(body);
        try { const res = await fetch(API + path, opts); return res.json(); } catch(e) { return { success: false, error: e.message }; }
    }

    function toast(msg, type='success') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast message ' + type;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    const MEDIA_ICONS = { movies:'&#127916;', adult_movies:'&#128274;', tv_shows:'&#128250;', music:'&#127925;', music_videos:'&#127911;', home_videos:'&#127909;', other_videos:'&#128253;', images:'&#128247;', audiobooks:'&#128214;' };
    const MEDIA_LABELS = { movies:'Movies', adult_movies:'Adult Movies', tv_shows:'TV Shows', music:'Music', music_videos:'Music Videos', home_videos:'Home Videos', other_videos:'Other Videos', images:'Photos', audiobooks:'Audiobooks' };
    function mediaIcon(type) { return MEDIA_ICONS[type] || '&#128191;'; }
    function formatDuration(sec) { if (!sec) return ''; const m = Math.floor(sec/60); const s = sec%60; return m + ':' + String(s).padStart(2,'0'); }
    function formatTime(sec) { const h = Math.floor(sec/3600); const m = Math.floor((sec%3600)/60); const s = Math.floor(sec%60); return (h>0?h+':':'')+String(m).padStart(h>0?2:1,'0')+':'+String(s).padStart(2,'0'); }

    // ──── Task Activity Tracker ────
    function handleTaskUpdate(data) {
        const taskId = data.task_id;
        if (!taskId) return;
        if (data.status === 'complete' || data.status === 'failed') {
            delete activeTasks[taskId];
            // Keep indicator visible briefly after last task completes
            if (Object.keys(activeTasks).length === 0) {
                clearTimeout(taskFadeTimer);
                taskFadeTimer = setTimeout(() => updateTaskIndicator(), 2000);
                // Show 100% momentarily
                const ring = document.getElementById('taskRingFill');
                if (ring) ring.setAttribute('stroke-dashoffset', '0');
                return;
            }
        } else {
            clearTimeout(taskFadeTimer);
            activeTasks[taskId] = {
                type: data.task_type || 'unknown',
                description: data.description || data.task_type || 'Task',
                progress: data.progress || 0,
                status: data.status || 'running'
            };
        }
        updateTaskIndicator();
    }

    function updateTaskIndicator() {
        const indicator = document.getElementById('taskIndicator');
        const tasks = Object.values(activeTasks);
        const count = tasks.length;
        if (count === 0) {
            indicator.style.display = 'none';
            indicator.classList.remove('active');
            return;
        }
        indicator.style.display = '';
        indicator.classList.add('active');
        // Aggregate progress (average across all active tasks)
        const avgProgress = tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / count;
        const ring = document.getElementById('taskRingFill');
        if (ring) ring.setAttribute('stroke-dashoffset', String(100 - avgProgress));
        // Task count
        const countEl = document.getElementById('taskCount');
        if (countEl) countEl.textContent = count;
        // Tooltip
        const tooltip = document.getElementById('taskTooltip');
        if (tooltip) {
            tooltip.innerHTML = '<div class="task-tooltip-header">Active Tasks</div>' +
                tasks.map(t => `<div class="task-tooltip-item">
                    <div class="task-tooltip-name">${t.description}</div>
                    <div class="task-tooltip-progress">
                        <div class="task-tooltip-bar"><div class="task-tooltip-bar-fill" style="width:${Math.round(t.progress)}%"></div></div>
                        <span class="task-tooltip-pct">${Math.round(t.progress)}%</span>
                    </div>
                </div>`).join('');
        }
    }

    // ──── WebSocket ────
    function connectWS() {
        if (ws) ws.close();
        const token = localStorage.getItem('token');
        if (!token) return;
        const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${proto}//${location.host}/api/v1/ws?token=${token}`);
        const badge = document.getElementById('wsStatus');
        ws.onopen = () => { badge.style.display=''; badge.className='ws-status tag tag-green'; badge.textContent='Live'; };
        ws.onclose = () => { badge.className='ws-status tag tag-red'; badge.textContent='Offline'; setTimeout(connectWS, 5000); };
        ws.onmessage = (e) => {
            try {
                const msg = JSON.parse(e.data);
                handleWSEvent(msg);
            } catch {}
        };
    }

    function handleWSEvent(msg) {
        switch(msg.event) {
            case 'scan:start': {
                toast('Scanning: ' + (msg.data?.name || ''), 'success');
                const libId = msg.data?.library_id;
                if (libId) {
                    const prog = document.getElementById('scan-progress-' + libId);
                    if (prog) prog.classList.add('active');
                    const btn = document.getElementById('scan-btn-' + libId);
                    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Scanning...'; }
                }
                break;
            }
            case 'scan:progress': {
                const libId = msg.data?.library_id;
                if (!libId) break;
                const current = msg.data.current || 0;
                const total = msg.data.total || 0;
                const filename = msg.data.filename || '';
                const pct = total > 0 ? Math.round((current / total) * 100) : 0;
                const fill = document.getElementById('scan-fill-' + libId);
                if (fill) fill.style.width = pct + '%';
                const fileEl = document.getElementById('scan-file-' + libId);
                if (fileEl) fileEl.textContent = filename;
                const countEl = document.getElementById('scan-count-' + libId);
                if (countEl) countEl.textContent = current + ' / ' + total + ' (' + pct + '%)';
                const prog = document.getElementById('scan-progress-' + libId);
                if (prog && !prog.classList.contains('active')) prog.classList.add('active');
                break;
            }
            case 'scan:complete': {
                const r = msg.data?.result;
                toast(`Scan complete: ${r?.files_added||0} added, ${r?.files_found||0} found`);
                loadSidebarCounts();
                const libId = msg.data?.library_id;
                if (libId) {
                    const fill = document.getElementById('scan-fill-' + libId);
                    if (fill) fill.style.width = '100%';
                    const btn = document.getElementById('scan-btn-' + libId);
                    if (btn) { btn.disabled = false; btn.innerHTML = '&#128269; Scan'; }
                    setTimeout(() => {
                        const prog = document.getElementById('scan-progress-' + libId);
                        if (prog) prog.classList.remove('active');
                        if (fill) fill.style.width = '0%';
                    }, 3000);
                    loadLibrariesView();
                }
                break;
            }
            case 'task:update':
                handleTaskUpdate(msg.data);
                break;
            case 'job:progress': break;
            default: break;
        }
    }

    // ──── Auth ────
    function checkAuth() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
            currentUser = JSON.parse(user);
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
            loadHomeView();
            loadSidebarCounts();
            connectWS();
        } else {
            document.getElementById('loginModal').classList.add('active');
        }
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msgDiv = document.getElementById('authMessage');
        try {
            const data = await api('POST', '/auth/login', { username: document.getElementById('loginUsername').value, password: document.getElementById('loginPassword').value });
            if (data.success) { localStorage.setItem('token', data.data.token); localStorage.setItem('user', JSON.stringify(data.data.user)); msgDiv.innerHTML='<div class="message success">Login successful!</div>'; setTimeout(checkAuth, 400); }
            else msgDiv.innerHTML='<div class="message error">'+(data.error||'Login failed')+'</div>';
        } catch { msgDiv.innerHTML='<div class="message error">Connection error</div>'; }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.clear(); currentUser=null; if(ws)ws.close(); document.getElementById('loginModal').classList.add('active'); });

    // ──── Sidebar Libraries ────
    async function loadSidebarCounts() {
        try {
            const data = await api('GET', '/libraries');
            if (!data.success) return;
            allLibraries = data.data || [];
            const nav = document.getElementById('librariesNav');
            // Keep the label, rebuild items
            nav.innerHTML = '<div class="nav-label">Libraries</div>';
            for (const lib of allLibraries) {
                const icon = MEDIA_ICONS[lib.media_type] || '&#128218;';
                const item = document.createElement('div');
                item.className = 'nav-item nav-item-lib';
                item.dataset.view = 'library';
                item.dataset.id = lib.id;
                item.innerHTML = `<span class="nav-icon">${icon}</span><span class="nav-lib-name">${lib.name}</span><span class="nav-badge" id="badge-lib-${lib.id}" style="display:none;"></span><span class="nav-lib-dots" data-lib-id="${lib.id}" title="Library options">&#8943;</span>`;
                item.querySelector('.nav-lib-name').addEventListener('click', () => navigate('library', lib.id));
                item.querySelector('.nav-icon').addEventListener('click', () => navigate('library', lib.id));
                const dotsBtn = item.querySelector('.nav-lib-dots');
                dotsBtn.addEventListener('click', (e) => { e.stopPropagation(); openLibCtxMenu(lib.id, dotsBtn); });
                nav.appendChild(item);
            }
            // Load counts
            for (const lib of allLibraries) {
                const countData = await api('GET', '/libraries/' + lib.id + '/media');
                if (countData.success) {
                    const badge = document.getElementById('badge-lib-' + lib.id);
                    if (badge) {
                        const total = countData.data.total || 0;
                        if (total > 0) { badge.textContent = total; badge.style.display = ''; }
                    }
                }
            }
            // Load duplicate count badge
            try {
                const dupData = await api('GET', '/duplicates/count');
                if (dupData.success && dupData.data && dupData.data.count > 0) {
                    const dupBadge = document.getElementById('dupBadge');
                    if (dupBadge) { dupBadge.textContent = dupData.data.count; dupBadge.style.display = ''; }
                }
            } catch {}
        } catch {}
    }

    // ──── Sidebar Library Context Menu ────
    function openLibCtxMenu(libId, dotsEl) {
        const menu = document.getElementById('libCtxMenu');
        const wasOpen = menu.classList.contains('open') && menu.dataset.libId === libId;
        closeLibCtxMenu();
        if (wasOpen) return;

        const isAdmin = currentUser && currentUser.role === 'admin';
        let html = '';
        if (isAdmin) html += `<div class="lib-ctx-item" onclick="showEditLibraryForm('${libId}')"><span class="ctx-icon">&#9998;</span> Edit Library</div><div class="lib-ctx-sep"></div>`;
        html += `<div class="lib-ctx-item" onclick="sidebarScanLibrary('${libId}')"><span class="ctx-icon">&#128269;</span> Scan Library</div>`;
        html += `<div class="lib-ctx-item" onclick="sidebarMetadataRefresh('${libId}')"><span class="ctx-icon">&#8635;</span> Metadata Refresh</div>`;
        menu.innerHTML = html;
        menu.dataset.libId = libId;

        // Position relative to the dots button
        const rect = dotsEl.getBoundingClientRect();
        menu.style.left = (rect.right - 4) + 'px';
        menu.style.top = rect.top + 'px';
        menu.classList.add('open');
        dotsEl.classList.add('active');

        // Adjust if menu goes off-screen bottom
        requestAnimationFrame(() => {
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight - 10) {
                menu.style.top = Math.max(10, window.innerHeight - menuRect.height - 10) + 'px';
            }
        });
    }
    function closeLibCtxMenu() {
        const menu = document.getElementById('libCtxMenu');
        menu.classList.remove('open');
        menu.dataset.libId = '';
        document.querySelectorAll('.nav-lib-dots.active').forEach(d => d.classList.remove('active'));
    }
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-lib-dots') && !e.target.closest('.lib-ctx-menu')) closeLibCtxMenu();
    });

    function sidebarScanLibrary(libId) {
        closeLibCtxMenu();
        toast('Scan started...');
        api('POST', '/libraries/' + libId + '/scan').then(data => {
            if (data.success) {
                if (data.data.job_id) { /* progress via WebSocket */ }
                else { toast(`Scan: ${data.data.files_added} added, ${data.data.files_found} total`); loadSidebarCounts(); }
            } else toast('Scan failed: ' + (data.error || 'Unknown'), 'error');
        }).catch(e => toast('Scan error: ' + e.message, 'error'));
    }

    function sidebarMetadataRefresh(libId) {
        closeLibCtxMenu();
        const lib = allLibraries.find(l => l.id === libId);
        if (lib && !lib.retrieve_metadata) { toast('Metadata retrieval is disabled for this library', 'error'); return; }
        toast('Metadata refresh started — unlocked items will be updated...');
        api('POST', '/libraries/' + libId + '/auto-match').then(data => {
            if (data.success) toast('Metadata refresh queued');
            else toast('Failed: ' + (data.error || 'Unknown'), 'error');
        }).catch(e => toast('Error: ' + e.message, 'error'));
    }

    async function showEditLibraryForm(libId) {
        closeLibCtxMenu();
        const data = await api('GET', '/libraries/' + libId);
        if (!data.success) { toast('Failed to load library', 'error'); return; }
        const lib = data.data;
        const mc = document.getElementById('mainContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}" ${k===lib.media_type?'selected':''}>${v}</option>`).join('');
        const folders = (lib.folders && lib.folders.length > 0) ? lib.folders : [{ folder_path: lib.path }];
        const folderRows = folders.map((f, i) => `<div class="folder-row" data-idx="${i}">
            <input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;" value="${f.folder_path || ''}">
            <button class="btn-secondary" onclick="openFolderBrowser(${i})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            ${i > 0 ? '<button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>' : ''}
        </div>`).join('');

        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Edit Library</h2></div>
        <div style="max-width:560px;">
            <input type="hidden" id="editLibId" value="${lib.id}">
            <div class="form-group"><label>Name</label><input type="text" id="libName" value="${lib.name}"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" disabled>${types}</select>
                <p style="color:#5a6a7f;font-size:0.75rem;margin-top:4px;">Media type cannot be changed after creation</p>
            </div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">${folderRows}</div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="${lib.media_type === 'tv_shows' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" ${lib.season_grouping?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no" ${!lib.season_grouping?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="${lib.media_type === 'adult_movies' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" ${(!lib.adult_content_type || lib.adult_content_type === 'movies')?'checked':''}><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips" ${lib.adult_content_type === 'clips'?'checked':''}><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone" ${lib.access_level==='everyone'?'selected':''}>Everyone</option>
                    <option value="select_users" ${lib.access_level==='select_users'?'selected':''}>Select People</option>
                    <option value="admin_only" ${lib.access_level==='admin_only'?'selected':''}>Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="${lib.access_level==='select_users'?'':'display:none;'}margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" ${lib.include_in_homepage?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no" ${!lib.include_in_homepage?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" ${lib.include_in_search?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no" ${!lib.include_in_search?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" ${lib.retrieve_metadata?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no" ${!lib.retrieve_metadata?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="saveEditLibrary()">Save Changes</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesView()">Cancel</button>
        </div>`;

        // Load user checkboxes if select_users
        if (lib.access_level === 'select_users') {
            const usersData = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            const allowed = lib.allowed_users ? lib.allowed_users.map(u => u.toString()) : [];
            if (usersData.success && usersData.data && usersData.data.length > 0) {
                list.innerHTML = usersData.data.filter(u => u.role !== 'admin').map(u =>
                    `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}" ${allowed.includes(u.id)?'checked':''}>
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`
                ).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            }
        }
    }

    async function saveEditLibrary() {
        const id = document.getElementById('editLibId').value;
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const d = await api('PUT', '/libraries/' + id, {
            name, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type
        });
        if (d.success) { toast('Library updated!'); loadLibrariesView(); loadSidebarCounts(); }
        else toast('Failed: ' + d.error, 'error');
    }

    // ──── Navigation ────
    function navigate(view, extra) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if (view === 'library' && extra) {
            const navItem = document.querySelector(`.nav-item[data-view="library"][data-id="${extra}"]`);
            if (navItem) navItem.classList.add('active');
        } else {
            const navItem = document.querySelector(`.nav-item[data-view="${view}"]`);
            if (navItem) navItem.classList.add('active');
        }
        switch(view) {
            case 'home': loadHomeView(); break;
            case 'libraries': loadLibrariesView(); break;
            case 'library': loadLibraryView(extra); break;
            case 'media': loadMediaTypeView(extra); break;
            case 'collections': loadCollectionsView(); break;
            case 'performers': loadPerformersView(); break;
            case 'tags': loadTagsView(); break;
            case 'studios': loadStudiosView(); break;
            case 'duplicates': loadDuplicatesView(); break;
            case 'settings': window.location.href = 'settings.html'; break;
            case 'admin': loadAdminView(); break;
        }
    }

    document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', () => navigate(item.dataset.view, item.dataset.type));
    });

    document.getElementById('settingsNavItem').addEventListener('click', () => { window.location.href = 'settings.html'; });

    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { if (e.target.value.length >= 2) loadSearchView(e.target.value); }, 400);
    });

    // ──── Media Card ────
    function renderMediaCard(item) {
        const dur = item.duration_seconds ? Math.floor(item.duration_seconds/60)+'min' : '';
        const year = item.year || '';
        const res = item.resolution || '';
        const meta = [year, dur, res].filter(Boolean).join(' \u00b7 ');
        const edBadge = item.edition_count && item.edition_count > 1 ? `<span class="edition-badge">${item.edition_count} editions</span>` : '';
        return `<div class="media-card" onclick="loadMediaDetail('${item.id}')">
            <div class="media-poster" style="position:relative;">
                ${item.poster_path ? '<img src="'+item.poster_path+'" alt="">' : mediaIcon(item.media_type)}
                ${res ? '<span class="quality-badge">'+res+'</span>' : ''}
                ${edBadge}
                <div class="play-overlay"><div class="play-button">&#9654;</div></div>
            </div>
            <div class="media-info"><div class="media-title">${item.title}</div><div class="media-meta">${meta}</div></div>
        </div>`;
    }

    // ──── Home View ────
    async function loadHomeView() {
        const mc = document.getElementById('mainContent');
        mc.innerHTML = `
            <div class="section-header"><h2 class="section-title">Continue Watching</h2></div>
            <div id="continueRow" class="continue-row"></div>
            <div class="section-header"><h2 class="section-title">Recently Added</h2></div>
            <div class="media-grid" id="recentGrid"></div>`;
        try {
            const cw = await api('GET', '/watch/continue');
            const row = document.getElementById('continueRow');
            if (cw.success && cw.data && cw.data.length > 0) {
                row.innerHTML = cw.data.map(wh => {
                    const item = wh.media_item || {};
                    const pct = wh.duration_seconds ? Math.round(wh.progress_seconds/wh.duration_seconds*100) : 0;
                    return `<div class="media-card" onclick="playMedia('${item.id}','${item.title||''}')">
                        <div class="media-poster">
                            ${item.poster_path ? '<img src="'+item.poster_path+'">' : mediaIcon(item.media_type||'movies')}
                            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                            <div class="play-overlay"><div class="play-button">&#9654;</div></div>
                        </div>
                        <div class="media-info"><div class="media-title">${item.title||'Unknown'}</div><div class="media-meta">${Math.floor(wh.progress_seconds/60)}/${wh.duration_seconds?Math.floor(wh.duration_seconds/60):'?'} min</div></div>
                    </div>`;
                }).join('');
            } else row.innerHTML = '<div style="color:#5a6a7f;padding:20px;">No items in progress</div>';
        } catch { document.getElementById('continueRow').innerHTML = ''; }
        try {
            const libs = await api('GET', '/libraries');
            const grid = document.getElementById('recentGrid');
            if (libs.success && libs.data) {
                // Only show libraries that have include_in_homepage enabled
                const homepageLibs = libs.data.filter(lib => lib.include_in_homepage !== false);
                let allItems = [];
                for (const lib of homepageLibs.slice(0,5)) {
                    const m = await api('GET', '/libraries/'+lib.id+'/media');
                    if (m.success && m.data && m.data.items) allItems = allItems.concat(m.data.items);
                }
                allItems.sort((a,b) => new Date(b.added_at) - new Date(a.added_at));
                grid.innerHTML = allItems.length > 0
                    ? allItems.slice(0,12).map(renderMediaCard).join('')
                    : `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">&#128253;</div><div class="empty-state-title">No media yet</div><p>Add libraries and scan them to populate your media</p><button class="btn-primary" style="margin-top:18px;" onclick="navigate('libraries')">Manage Libraries</button></div>`;
            }
        } catch {}
    }

    // ──── Media Detail ────
    var _detailMediaId = null;

    async function loadMediaDetail(id) {
        _detailMediaId = id;
        const mc = document.getElementById('mainContent');
        mc.innerHTML = '<div class="spinner"></div> Loading...';
        const data = await api('GET', '/media/' + id);
        if (!data.success) { mc.innerHTML = '<div class="empty-state"><div class="empty-state-title">Media not found</div></div>'; return; }
        const m = data.data;
        const dur = m.duration_seconds ? formatDuration(m.duration_seconds) : '';
        const meta = [m.year, dur, m.resolution, m.codec].filter(Boolean).join(' \u00b7 ');

        // Build ratings row
        let ratingsHTML = '';
        const hasAnyRating = m.rating || m.imdb_rating || m.rt_rating != null || m.audience_score != null;
        if (hasAnyRating) {
            ratingsHTML = '<div class="ratings-row">';
            if (m.rating) ratingsHTML += `<div class="rating-badge rating-tmdb"><span class="rating-icon">&#11088;</span><span class="rating-value">${m.rating.toFixed(1)}</span><span class="rating-label">TMDB</span></div>`;
            if (m.imdb_rating) ratingsHTML += `<div class="rating-badge rating-imdb"><span class="rating-icon">&#127902;</span><span class="rating-value">${m.imdb_rating.toFixed(1)}</span><span class="rating-label">IMDb</span></div>`;
            if (m.rt_rating != null) ratingsHTML += `<div class="rating-badge rating-rt"><span class="rating-icon">&#127813;</span><span class="rating-value">${m.rt_rating}%</span><span class="rating-label">Rotten Tomatoes</span></div>`;
            if (m.audience_score != null) ratingsHTML += `<div class="rating-badge rating-audience"><span class="rating-icon">&#128101;</span><span class="rating-value">${m.audience_score}%</span><span class="rating-label">Audience</span></div>`;
            ratingsHTML += '</div>';
        }

        mc.innerHTML = `
            <div class="detail-hero">
                <div class="detail-poster">${m.poster_path ? '<img src="'+m.poster_path+'">' : mediaIcon(m.media_type)}</div>
                <div class="detail-info">
                    <h1>${m.title}</h1>
                    <div class="meta-row">${meta}</div>
                    ${m.description ? '<p class="description">'+m.description+'</p>' : ''}
                    <div id="detailGenreTags" class="genre-tags"></div>
                    ${ratingsHTML}
                    <div class="detail-actions">
                        <button class="btn-primary" onclick="playMedia('${m.id}','${m.title.replace(/'/g,"\\'")}')">&#9654; Play</button>
                        <button class="btn-secondary" onclick="playDirect('${m.id}','${m.title.replace(/'/g,"\\'")}')">&#128190; Direct Play</button>
                        <button class="btn-secondary" onclick="openEditModal('${m.id}')">&#9998; Edit</button>
                        <button class="btn-secondary" onclick="identifyMedia('${m.id}')">&#128270; Identify</button>
                    </div>
                    <div style="margin-bottom:10px;">
                        ${m.metadata_locked ? '<span class="lock-badge locked">&#128274; Metadata Locked</span>' : ''}
                        <span class="tag tag-cyan">${MEDIA_LABELS[m.media_type]||m.media_type}</span>
                        ${m.file_size ? '<span class="tag tag-purple">'+(m.file_size/1024/1024).toFixed(0)+' MB</span>' : ''}
                        ${m.audio_codec ? '<span class="tag tag-green">'+m.audio_codec+'</span>' : ''}
                        ${m.bitrate ? '<span class="tag tag-orange">'+(m.bitrate/1000).toFixed(0)+' kbps</span>' : ''}
                    </div>
                    <div class="detail-tabs">
                        <button class="detail-tab active" onclick="showDetailTab(this,'info','${m.id}')">Info</button>
                        <button class="detail-tab" onclick="showDetailTab(this,'cast','${m.id}')">Cast</button>
                        <button class="detail-tab" onclick="showDetailTab(this,'tags-tab','${m.id}')">Tags</button>
                        <button class="detail-tab" onclick="showDetailTab(this,'file','${m.id}')">File</button>
                    </div>
                    <div class="detail-tab-content" id="detailTabContent">
                        <table style="width:100%;font-size:0.85rem;">
                            <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">File</td><td>${m.file_name}</td></tr>
                            <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Path</td><td style="word-break:break-all;">${m.file_path}</td></tr>
                            ${m.width ? '<tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Resolution</td><td>'+m.width+'x'+m.height+'</td></tr>' : ''}
                            ${m.codec ? '<tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Video Codec</td><td>'+m.codec+'</td></tr>' : ''}
                            <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Added</td><td>${new Date(m.added_at).toLocaleString()}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <button class="btn-secondary" onclick="navigate('home')">&#8592; Back</button>`;

        // Load genre tags for this item
        loadMediaGenreTags(id);
    }

    async function loadMediaGenreTags(mediaId) {
        const tagData = await api('GET', '/media/' + mediaId + '/tags');
        const container = document.getElementById('detailGenreTags');
        if (!container) return;
        if (tagData.success && tagData.data && tagData.data.length > 0) {
            const genreTags = tagData.data.filter(t => t.category === 'genre');
            if (genreTags.length > 0) {
                container.innerHTML = genreTags.map(t => `<span class="genre-tag">${t.name}</span>`).join('');
            }
        }
    }

    async function showDetailTab(btn, tab, mediaId) {
        btn.parentElement.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        const tc = document.getElementById('detailTabContent');
        if (!tc) return;
        if (tab === 'tags-tab') {
            tc.innerHTML = '<div class="spinner"></div>';
            // Fetch tags for this media item
            const res = await api('GET', '/media/' + mediaId + '/tags');
            if (res.success && res.data && res.data.length > 0) {
                tc.innerHTML = '<div class="genre-tags">' + res.data.map(t =>
                    `<span class="genre-tag">${t.name}</span>`
                ).join('') + '</div>';
            } else {
                tc.innerHTML = '<p style="color:#5a6a7f;">No tags assigned</p>';
            }
        } else if (tab === 'info') {
            loadMediaDetail(mediaId);
        } else if (tab === 'cast') {
            tc.innerHTML = '<div class="spinner"></div>';
            const castRes = await api('GET', '/media/' + mediaId + '/cast');
            if (castRes.success && castRes.data && castRes.data.length > 0) {
                const all = castRes.data.map(c => {
                    const subtitle = c.role === 'actor' ? (c.character_name || '') : c.role;
                    return `<div class="cast-card" onclick="loadPerformerDetail('${c.performer_id}')"><div class="person-avatar">${c.photo_path ? '<img src="'+c.photo_path+'">' : '&#128100;'}</div><div class="person-name">${c.name}</div><div class="person-role">${subtitle}</div></div>`;
                }).join('');
                tc.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;"><h4 style="color:#e5e5e5;margin:0;">Cast &amp; Crew</h4></div><div class="cast-row"><button class="cast-row-arrow left" onclick="document.getElementById('castScroll').scrollLeft-=400">&#8249;</button><div class="cast-row-scroll" id="castScroll">${all}</div><button class="cast-row-arrow right" onclick="document.getElementById('castScroll').scrollLeft+=400">&#8250;</button></div>`;
            } else {
                tc.innerHTML = '<p style="color:#5a6a7f;">No cast information available</p>';
            }
        } else if (tab === 'file') {
            tc.innerHTML = '<p style="color:#5a6a7f;">Loading file info...</p>';
            const data = await api('GET', '/media/' + mediaId);
            if (data.success) {
                const m = data.data;
                tc.innerHTML = `<table style="width:100%;font-size:0.85rem;">
                    <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">File</td><td>${m.file_name}</td></tr>
                    <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Path</td><td style="word-break:break-all;">${m.file_path}</td></tr>
                    ${m.width ? '<tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Resolution</td><td>'+m.width+'x'+m.height+'</td></tr>' : ''}
                    ${m.codec ? '<tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Video Codec</td><td>'+m.codec+'</td></tr>' : ''}
                    ${m.file_hash ? '<tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">MD5 Hash</td><td style="font-family:monospace;font-size:0.78rem;">'+m.file_hash+'</td></tr>' : ''}
                    <tr><td style="color:#5a6a7f;padding:4px 16px 4px 0;">Added</td><td>${new Date(m.added_at).toLocaleString()}</td></tr>
                </table>`;
            }
        }
    }

    // ──── Paginated Media Grid with Alpha Jump ────
    let _gridState = { libraryId: null, offset: 0, total: 0, loading: false, done: false, observer: null, letterIndex: [] };

    function teardownGrid() {
        if (_gridState.observer) { _gridState.observer.disconnect(); _gridState.observer = null; }
        _gridState = { libraryId: null, offset: 0, total: 0, loading: false, done: false, observer: null, letterIndex: [] };
    }

    async function loadMoreMedia() {
        if (_gridState.loading || _gridState.done) return;
        _gridState.loading = true;
        const m = await api('GET', '/libraries/' + _gridState.libraryId + '/media?limit=200&offset=' + _gridState.offset);
        const items = (m.success && m.data && m.data.items) ? m.data.items : [];
        _gridState.total = m.data ? m.data.total : _gridState.total;

        const grid = document.getElementById('libGrid');
        if (!grid) { _gridState.loading = false; return; }

        // Remove sentinel before appending
        const sentinel = document.getElementById('gridSentinel');
        if (sentinel) sentinel.remove();

        if (items.length === 0 && _gridState.offset === 0) {
            const type = (allLibraries.find(l => l.id === _gridState.libraryId) || {}).media_type || '';
            grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">${mediaIcon(type)}</div><div class="empty-state-title">No items in this library</div><p>Scan the library to populate it with media</p></div>`;
            _gridState.done = true;
            _gridState.loading = false;
            return;
        }

        grid.insertAdjacentHTML('beforeend', items.map(renderMediaCard).join(''));
        _gridState.offset += items.length;

        // Check if we've loaded everything
        if (_gridState.offset >= _gridState.total || items.length < 200) {
            _gridState.done = true;
            updateAlphaCount();
        } else {
            // Add sentinel for infinite scroll
            grid.insertAdjacentHTML('beforeend', '<div id="gridSentinel" class="load-more-sentinel"><div class="spinner"></div></div>');
            const newSentinel = document.getElementById('gridSentinel');
            if (newSentinel && _gridState.observer) _gridState.observer.observe(newSentinel);
        }
        _gridState.loading = false;
        updateAlphaCount();
    }

    function setupScrollObserver() {
        _gridState.observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadMoreMedia();
        }, { root: document.getElementById('mainContent'), rootMargin: '800px' });
        const sentinel = document.getElementById('gridSentinel');
        if (sentinel) _gridState.observer.observe(sentinel);
    }

    function buildAlphaJump(letterIndex) {
        const allLetters = ['#','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
        const indexMap = {};
        letterIndex.forEach(e => { indexMap[e.letter] = e; });
        return `<div class="alpha-jump" id="alphaJump">${allLetters.map(l => {
            const entry = indexMap[l];
            if (entry) {
                return `<div class="alpha-jump-letter" data-letter="${l}" data-offset="${entry.offset}" onclick="jumpToLetter(this)">${l}</div>`;
            }
            return `<div class="alpha-jump-letter disabled">${l}</div>`;
        }).join('')}</div>`;
    }

    function updateAlphaCount() {
        // Highlight the current visible letter based on scroll position
        const grid = document.getElementById('libGrid');
        const jump = document.getElementById('alphaJump');
        if (!grid || !jump) return;
        const cards = grid.querySelectorAll('.media-card');
        if (cards.length === 0) return;

        // Find the first visible card
        const container = document.getElementById('mainContent');
        const containerTop = container.getBoundingClientRect().top;
        let activeLetter = '';
        for (const card of cards) {
            const rect = card.getBoundingClientRect();
            if (rect.top >= containerTop - 50) {
                const title = card.querySelector('.media-title');
                if (title) {
                    const first = title.textContent.trim().charAt(0).toUpperCase();
                    activeLetter = (first >= 'A' && first <= 'Z') ? first : '#';
                }
                break;
            }
        }
        jump.querySelectorAll('.alpha-jump-letter').forEach(el => {
            el.classList.toggle('active', el.dataset.letter === activeLetter);
        });
    }

    async function jumpToLetter(el) {
        const targetOffset = parseInt(el.dataset.offset);
        const letter = el.dataset.letter;
        // Load batches until we have enough items to reach this letter
        if (targetOffset >= _gridState.offset && !_gridState.done) {
            while (_gridState.offset <= targetOffset && !_gridState.done) {
                await loadMoreMedia();
            }
        }
        // Find the first card starting with this letter and scroll to it
        const grid = document.getElementById('libGrid');
        if (!grid) return;
        const cards = grid.querySelectorAll('.media-card');
        for (const card of cards) {
            const title = card.querySelector('.media-title');
            if (title) {
                const first = title.textContent.trim().charAt(0).toUpperCase();
                const cardLetter = (first >= 'A' && first <= 'Z') ? first : '#';
                if (cardLetter === letter) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }
        document.querySelectorAll('.alpha-jump-letter').forEach(l => l.classList.remove('active'));
        el.classList.add('active');
    }

    async function loadMediaTypeView(mediaType) {
        teardownGrid();
        const mc = document.getElementById('mainContent');
        const label = MEDIA_LABELS[mediaType] || mediaType;

        // Find all libraries of this type
        const libs = await api('GET', '/libraries');
        const matchingLibs = (libs.success && libs.data) ? libs.data.filter(l => l.media_type === mediaType) : [];

        if (matchingLibs.length === 1) {
            // Single library — use paginated view
            return loadLibraryView(matchingLibs[0].id);
        }

        // Multiple libraries — load all (with pagination for each)
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">${label}</h2></div>
            <div class="media-grid" id="typeGrid"><div class="spinner"></div> Loading...</div>`;
        let items = [];
        for (const lib of matchingLibs) {
            let off = 0;
            while (true) {
                const m = await api('GET', '/libraries/'+lib.id+'/media?limit=500&offset='+off);
                if (m.success && m.data && m.data.items && m.data.items.length > 0) {
                    items = items.concat(m.data.items);
                    off += m.data.items.length;
                    if (off >= m.data.total) break;
                } else break;
            }
        }
        const grid = document.getElementById('typeGrid');
        grid.innerHTML = items.length > 0
            ? items.map(renderMediaCard).join('')
            : `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">${mediaIcon(mediaType)}</div><div class="empty-state-title">No ${label.toLowerCase()} yet</div><p>Add a ${label.toLowerCase()} library and scan it</p></div>`;
    }

    async function loadLibraryView(libraryId) {
        teardownGrid();
        const mc = document.getElementById('mainContent');
        const lib = allLibraries.find(l => l.id === libraryId);
        const label = lib ? lib.name : 'Library';
        const type = lib ? lib.media_type : '';

        // TV show library with season grouping → show TV shows instead of flat episodes
        if (lib && lib.media_type === 'tv_shows' && lib.season_grouping) {
            mc.innerHTML = `<div class="section-header"><h2 class="section-title">${label}</h2><span class="tag tag-cyan" style="margin-left:12px;">TV Shows</span></div>
                <div class="media-grid" id="libGrid"><div class="spinner"></div> Loading...</div>`;
            const data = await api('GET', '/libraries/' + libraryId + '/shows');
            const shows = (data.success && data.data) ? data.data : [];
            const grid = document.getElementById('libGrid');
            grid.innerHTML = shows.length > 0
                ? shows.map(renderShowCard).join('')
                : `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">&#128250;</div><div class="empty-state-title">No TV shows yet</div><p>Scan the library to detect shows</p></div>`;
            return;
        }

        // Fetch letter index for jump bar
        const idxData = await api('GET', '/libraries/' + libraryId + '/media/index');
        const letterIndex = (idxData.success && idxData.data) ? idxData.data : [];
        _gridState.libraryId = libraryId;
        _gridState.letterIndex = letterIndex;

        const totalCount = letterIndex.reduce((s, e) => s + e.count, 0);

        mc.innerHTML = `<div class="section-header"><h2 class="section-title">${label}</h2><span class="tag tag-cyan" style="margin-left:12px;">${MEDIA_LABELS[type]||type}</span><span class="tag" style="margin-left:8px;">${totalCount.toLocaleString()} items</span></div>
            <div class="media-grid-wrapper">
                <div class="media-grid" id="libGrid"><div id="gridSentinel" class="load-more-sentinel"><div class="spinner"></div></div></div>
                ${buildAlphaJump(letterIndex)}
            </div>`;

        setupScrollObserver();
        loadMoreMedia();

        // Update active letter on scroll
        const container = document.getElementById('mainContent');
        container.addEventListener('scroll', () => { requestAnimationFrame(updateAlphaCount); });
    }

    function renderShowCard(show) {
        const year = show.year || '';
        const desc = show.description ? show.description.substring(0, 100) + '...' : '';
        return `<div class="media-card" onclick="loadShowView('${show.id}')">
            <div class="media-poster">
                ${show.poster_path ? '<img src="'+show.poster_path+'" alt="">' : '&#128250;'}
            </div>
            <div class="media-info"><div class="media-title">${show.title}</div><div class="media-meta">${year}</div></div>
        </div>`;
    }

    async function loadShowView(showId) {
        const mc = document.getElementById('mainContent');
        mc.innerHTML = '<div class="spinner"></div> Loading...';
        const data = await api('GET', '/tv/shows/' + showId);
        if (!data.success) { mc.innerHTML = '<div class="empty-state"><div class="empty-state-title">Show not found</div></div>'; return; }
        const show = data.data.show;
        const seasons = data.data.seasons || [];
        const totalEps = seasons.reduce((sum, s) => sum + (s.episode_count || 0), 0);

        const heroHTML = `
            <div class="detail-hero">
                <div class="detail-poster">${show.poster_path ? '<img src="'+show.poster_path+'">' : '&#128250;'}</div>
                <div class="detail-info">
                    <h1>${show.title}</h1>
                    <div class="meta-row">${show.year ? show.year + ' \u00b7 ' : ''}${seasons.length} Season${seasons.length !== 1 ? 's' : ''} \u00b7 ${totalEps} Episode${totalEps !== 1 ? 's' : ''}</div>
                    ${show.description ? '<p class="description">'+show.description+'</p>' : ''}
                </div>
            </div>`;

        if (seasons.length === 1) {
            // Single season: show episodes directly (like Plex single-season view)
            mc.innerHTML = heroHTML + `
                <h3 style="color:#e5e5e5;margin:24px 0 16px;">${totalEps} Episode${totalEps !== 1 ? 's' : ''}</h3>
                <div class="media-grid" id="season-${seasons[0].id}"><div class="spinner"></div></div>
                <button class="btn-secondary" onclick="history.back(); return false;" style="margin-top:20px;">&#8592; Back</button>`;
            loadSeasonEpisodes(seasons[0].id);
        } else {
            // Multiple seasons: show season cards (like Plex multi-season view)
            mc.innerHTML = heroHTML + `
                <h3 style="color:#e5e5e5;margin:24px 0 16px;">Seasons</h3>
                <div class="media-grid" id="seasonsGrid">
                    ${seasons.map(s => `<div class="media-card" onclick="loadSeasonView('${showId}','${s.id}', ${s.season_number})">
                        <div class="media-poster">
                            ${s.poster_path ? '<img src="'+s.poster_path+'" alt="">' : (show.poster_path ? '<img src="'+show.poster_path+'" alt="">' : '&#128250;')}
                        </div>
                        <div class="media-info">
                            <div class="media-title">${s.title || 'Season ' + s.season_number}</div>
                            <div class="media-meta">${s.episode_count} episode${s.episode_count !== 1 ? 's' : ''}</div>
                        </div>
                    </div>`).join('')}
                </div>
                <button class="btn-secondary" onclick="history.back(); return false;" style="margin-top:20px;">&#8592; Back</button>`;
        }
    }

    async function loadSeasonView(showId, seasonId, seasonNum) {
        const mc = document.getElementById('mainContent');
        mc.innerHTML = '<div class="spinner"></div> Loading...';
        // Get show info for the hero
        const showData = await api('GET', '/tv/shows/' + showId);
        if (!showData.success) { mc.innerHTML = '<div class="empty-state"><div class="empty-state-title">Show not found</div></div>'; return; }
        const show = showData.data.show;
        const seasons = showData.data.seasons || [];
        const season = seasons.find(s => s.id === seasonId);
        const epCount = season ? season.episode_count : 0;

        mc.innerHTML = `
            <div class="detail-hero">
                <div class="detail-poster">${season && season.poster_path ? '<img src="'+season.poster_path+'">' : (show.poster_path ? '<img src="'+show.poster_path+'">' : '&#128250;')}</div>
                <div class="detail-info">
                    <h1>${show.title}</h1>
                    <div class="meta-row">Season ${seasonNum} \u00b7 ${epCount} Episode${epCount !== 1 ? 's' : ''}</div>
                    ${season && season.description ? '<p class="description">'+season.description+'</p>' : (show.description ? '<p class="description">'+show.description+'</p>' : '')}
                </div>
            </div>
            <h3 style="color:#e5e5e5;margin:24px 0 16px;">${epCount} Episode${epCount !== 1 ? 's' : ''}</h3>
            <div class="media-grid" id="season-${seasonId}"><div class="spinner"></div></div>
            <button class="btn-secondary" onclick="loadShowView('${showId}')" style="margin-top:20px;">&#8592; Back to ${show.title}</button>`;
        loadSeasonEpisodes(seasonId);
    }

    async function loadSeasonEpisodes(seasonId) {
        const container = document.getElementById('season-' + seasonId);
        if (!container) return;
        const data = await api('GET', '/tv/seasons/' + seasonId + '/episodes');
        const episodes = (data.success && data.data) ? data.data : [];
        container.innerHTML = episodes.length > 0
            ? episodes.map(ep => {
                const epNum = ep.episode_number ? 'Episode ' + ep.episode_number : '';
                const dur = ep.duration_seconds ? Math.floor(ep.duration_seconds/60)+'min' : '';
                const res = ep.resolution || '';
                const meta = [epNum, dur, res].filter(Boolean).join(' \u00b7 ');
                return `<div class="media-card" onclick="loadMediaDetail('${ep.id}')">
                    <div class="media-poster">
                        ${ep.poster_path ? '<img src="'+ep.poster_path+'" alt="">' : '&#128250;'}
                        ${res ? '<span class="quality-badge">'+res+'</span>' : ''}
                        <div class="play-overlay"><div class="play-button">&#9654;</div></div>
                    </div>
                    <div class="media-info"><div class="media-title">${ep.title}</div><div class="media-meta">${meta}</div></div>
                </div>`;
            }).join('')
            : '<p style="color:#5a6a7f;">No episodes found</p>';
    }

    async function loadSearchView(query) {
        const mc = document.getElementById('mainContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Search: "${query}"</h2></div><div class="media-grid" id="searchGrid"><div class="spinner"></div> Searching...</div>`;
        const data = await api('GET', '/media/search?q=' + encodeURIComponent(query));
        const grid = document.getElementById('searchGrid');
        grid.innerHTML = (data.success && data.data && data.data.length > 0) ? data.data.map(renderMediaCard).join('') : '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-title">No results</div></div>';
    }

    // ──── Libraries ────
    async function loadLibrariesView() {
        const mc = document.getElementById('mainContent');
        const isAdmin = currentUser && currentUser.role === 'admin';
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Libraries</h2>${isAdmin?'<button class="btn-primary" onclick="showCreateLibrary()">+ Add Library</button>':''}</div><div id="libList"><div class="spinner"></div> Loading...</div>`;
        const data = await api('GET', '/libraries');
        const div = document.getElementById('libList');
        if (data.success && data.data && data.data.length > 0) {
            div.innerHTML = data.data.map(lib => {
                const accessLabel = {everyone:'Everyone',select_users:'Select People',admin_only:'Admin Only'}[lib.access_level]||'Everyone';
                const accessColor = {everyone:'tag-green',select_users:'tag-purple',admin_only:'tag-red'}[lib.access_level]||'tag-green';
                const folderPaths = (lib.folders && lib.folders.length > 0) ? lib.folders.map(f => f.folder_path).join(', ') : lib.path;
                const folderCount = (lib.folders && lib.folders.length > 1) ? `<span class="tag tag-orange" style="margin-left:6px;">${lib.folders.length} folders</span>` : '';
                let settingsTags = '';
                if (!lib.include_in_homepage) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Home</span>';
                if (!lib.include_in_search) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Search</span>';
                if (!lib.retrieve_metadata) settingsTags += '<span class="tag tag-orange" style="margin-left:4px;">No Metadata</span>';
                if (lib.media_type === 'adult_movies' && lib.adult_content_type) settingsTags += `<span class="tag tag-purple" style="margin-left:4px;">${lib.adult_content_type === 'clips' ? 'Clips' : 'Movies'}</span>`;
                return `<div class="library-card" id="lib-card-${lib.id}"><div style="flex:1;"><h3>${lib.name}</h3><p style="color:#8a9bae;font-size:0.85rem;"><span class="tag tag-cyan">${MEDIA_LABELS[lib.media_type]||lib.media_type}</span>${lib.season_grouping?'<span class="tag tag-purple" style="margin-left:6px;">Season Grouping</span>':''}<span class="tag ${accessColor}" style="margin-left:6px;">${accessLabel}</span>${folderCount}<span style="margin-left:8px;">${folderPaths}</span></p><div class="lib-settings-tags">${settingsTags}</div><p style="color:#5a6a7f;font-size:0.78rem;margin-top:6px;">${lib.last_scan_at?'Last scan: '+new Date(lib.last_scan_at).toLocaleString():'Never scanned'}</p><div class="scan-progress" id="scan-progress-${lib.id}"><div class="scan-progress-bar"><div class="scan-progress-fill" id="scan-fill-${lib.id}"></div></div><div class="scan-progress-text"><span class="filename" id="scan-file-${lib.id}"></span><span id="scan-count-${lib.id}"></span></div></div></div><div class="library-actions">${isAdmin?`<button class="btn-secondary" id="scan-btn-${lib.id}" onclick="scanLibrary('${lib.id}',this)">&#128269; Scan</button><button class="btn-danger btn-small" onclick="deleteLibrary('${lib.id}')">Delete</button>`:''}</div></div>`;
            }).join('');
        } else div.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#128218;</div><div class="empty-state-title">No libraries configured</div><p>Create your first library to start organizing media</p></div>`;
    }

    async function scanLibrary(id, btn) {
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Scanning...';
        const prog = document.getElementById('scan-progress-' + id);
        if (prog) prog.classList.add('active');
        const countEl = document.getElementById('scan-count-' + id);
        if (countEl) countEl.textContent = 'Counting files...';
        try {
            const data = await api('POST', '/libraries/'+id+'/scan');
            if (data.success) {
                if (data.data.job_id) { /* progress handled by WebSocket events */ }
                else {
                    // Synchronous scan fallback (no job queue)
                    const r = data.data;
                    toast(`Scan: ${r.files_added} added, ${r.files_found} total`);
                    loadLibrariesView(); loadSidebarCounts();
                    btn.disabled = false; btn.innerHTML = '&#128269; Scan';
                    if (prog) prog.classList.remove('active');
                }
            } else {
                toast('Scan failed: '+(data.error||'Unknown'), 'error');
                btn.disabled = false; btn.innerHTML = '&#128269; Scan';
                if (prog) prog.classList.remove('active');
            }
        } catch(e) {
            toast('Scan error: '+e.message, 'error');
            btn.disabled = false; btn.innerHTML = '&#128269; Scan';
            if (prog) prog.classList.remove('active');
        }
    }

    async function deleteLibrary(id) { if (!confirm('Delete this library and all its media?')) return; const d=await api('DELETE','/libraries/'+id); if(d.success){toast('Library deleted');loadLibrariesView();}else toast('Failed: '+d.error,'error'); }

    function showCreateLibrary() {
        const mc = document.getElementById('mainContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Create Library</h2></div>
        <div style="max-width:560px;">
            <div class="form-group"><label>Name</label><input type="text" id="libName" placeholder="My Movies"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" onchange="onLibTypeChange()">${types}</select></div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">
                    <div class="folder-row" data-idx="0">
                        <input type="text" class="lib-folder-input" placeholder="/media/movies" style="flex:1;">
                        <button class="btn-secondary" onclick="openFolderBrowser(0)" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
                    </div>
                </div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no"><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" checked><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips"><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone">Everyone</option>
                    <option value="select_users">Select People</option>
                    <option value="admin_only">Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no"><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="createLibrary()">Create Library</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesView()">Cancel</button>
        </div>`;
        onLibTypeChange();
    }

    let activeFolderIdx = null;

    function addFolderRow() {
        const list = document.getElementById('folderList');
        const idx = list.children.length;
        const row = document.createElement('div');
        row.className = 'folder-row';
        row.dataset.idx = idx;
        row.innerHTML = `<input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;">
            <button class="btn-secondary" onclick="openFolderBrowser(${idx})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            <button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>`;
        list.appendChild(row);
    }

    function removeFolderRow(btn) {
        const row = btn.closest('.folder-row');
        const list = document.getElementById('folderList');
        if (list.children.length <= 1) { toast('At least one folder is required', 'error'); return; }
        row.remove();
    }

    function openFolderBrowser(idx) {
        activeFolderIdx = idx;
        const inputs = document.querySelectorAll('.lib-folder-input');
        const currentPath = inputs[idx]?.value || '/media';
        openPathBrowser(currentPath);
    }

    function onLibTypeChange() {
        const type = document.getElementById('libType').value;
        const seasonOpt = document.getElementById('seasonGroupingOpt');
        const adultOpt = document.getElementById('adultContentOpt');
        if (seasonOpt) seasonOpt.style.display = (type === 'tv_shows') ? '' : 'none';
        if (adultOpt) adultOpt.style.display = (type === 'adult_movies') ? '' : 'none';
    }

    async function onAccessChange() {
        const val = document.getElementById('libAccess').value;
        const panel = document.getElementById('userSelectPanel');
        if (val === 'select_users') {
            panel.style.display = '';
            const data = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            if (data.success && data.data && data.data.length > 0) {
                list.innerHTML = data.data
                    .filter(u => u.role !== 'admin')
                    .map(u => `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}">
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            } else {
                list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No users found</p>';
            }
        } else {
            panel.style.display = 'none';
        }
    }

    async function openPathBrowser(path) {
        const browser = document.getElementById('pathBrowser');
        browser.style.display = 'block';
        await loadPathEntries(path || '/media');
    }

    async function loadPathEntries(path) {
        const browser = document.getElementById('pathBrowser');
        browser.innerHTML = '<div class="spinner" style="margin:10px auto;"></div>';
        const data = await api('GET', '/browse?path=' + encodeURIComponent(path));
        if (!data.success) { browser.innerHTML = '<p style="color:#ff5555;">Failed to browse</p>'; return; }
        const d = data.data;
        let html = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(0,217,255,0.1);">
            <span style="color:#00D9FF;font-size:0.8rem;font-weight:600;">&#128194; ${d.path}</span>
            <button class="btn-secondary" style="margin-left:auto;padding:4px 12px;font-size:0.75rem;" onclick="selectBrowsePath('${d.path}')">&#10003; Select This</button>
        </div>`;
        if (d.parent) {
            html += `<div onclick="loadPathEntries('${d.parent}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#8a9bae;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#11168; ..</div>`;
        }
        if (d.entries && d.entries.length > 0) {
            d.entries.forEach(e => {
                html += `<div onclick="loadPathEntries('${e.path}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#e5e5e5;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#128193; ${e.name}</div>`;
            });
        } else if (!d.parent) {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">No subdirectories</p>';
        } else {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">Empty folder</p>';
        }
        browser.innerHTML = html;
    }

    function selectBrowsePath(path) {
        // Multi-folder mode: set the active folder input
        if (activeFolderIdx !== null) {
            const inputs = document.querySelectorAll('.lib-folder-input');
            if (inputs[activeFolderIdx]) {
                inputs[activeFolderIdx].value = path;
            }
            activeFolderIdx = null;
        } else {
            // Fallback for single-path mode (legacy)
            const libPath = document.getElementById('libPath');
            if (libPath) libPath.value = path;
        }
        document.getElementById('pathBrowser').style.display = 'none';
    }

    async function createLibrary() {
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        // Collect folders
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const d = await api('POST', '/libraries', {
            name, media_type, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type
        });
        if (d.success) { toast('Library created!'); loadLibrariesView(); loadSidebarCounts(); }
        else toast('Failed: ' + d.error, 'error');
    }

    // ──── Collections ────
    async function loadCollectionsView(){const mc=document.getElementById('mainContent');mc.innerHTML=`<div class="section-header"><h2 class="section-title">Collections</h2><button class="btn-primary" onclick="showCreateCollection()">+ New</button></div><div id="collList"><div class="spinner"></div></div>`;const data=await api('GET','/collections');const div=document.getElementById('collList');if(data.success&&data.data&&data.data.length>0){div.innerHTML=data.data.map(c=>`<div class="group-card"><div style="display:flex;justify-content:space-between;"><div><h4>${c.name}</h4>${c.description?'<p>'+c.description+'</p>':''}<span class="tag tag-green">${c.item_count||0} items</span><span class="tag tag-cyan">${c.visibility}</span></div><button class="btn-danger btn-small" onclick="deleteCollection('${c.id}')">Delete</button></div></div>`).join('');}else div.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#11088;</div><div class="empty-state-title">No collections</div></div>';}
    function showCreateCollection(){const mc=document.getElementById('mainContent');mc.innerHTML=`<div class="section-header"><h2 class="section-title">New Collection</h2></div><div style="max-width:500px;"><div class="form-group"><label>Name</label><input type="text" id="collName"></div><div class="form-group"><label>Description</label><input type="text" id="collDesc"></div><div class="form-group"><label>Visibility</label><select id="collVis"><option value="private">Private</option><option value="shared">Shared</option><option value="public">Public</option></select></div><button class="btn-primary" onclick="createCollection()">Create</button><button class="btn-secondary" style="margin-left:12px;" onclick="loadCollectionsView()">Cancel</button></div>`;}
    async function createCollection(){const n=document.getElementById('collName').value,d=document.getElementById('collDesc').value||null,v=document.getElementById('collVis').value;if(!n){toast('Name required','error');return;}const r=await api('POST','/collections',{name:n,description:d,visibility:v});if(r.success){toast('Created!');loadCollectionsView();}else toast(r.error,'error');}
    async function deleteCollection(id){if(!confirm('Delete?'))return;const d=await api('DELETE','/collections/'+id);if(d.success){toast('Deleted');loadCollectionsView();}else toast(d.error,'error');}

    // ──── Performers ────
    async function loadPerformersView() {
        const mc=document.getElementById('mainContent'); const isAdmin=currentUser&&currentUser.role==='admin';
        mc.innerHTML=`<div class="section-header"><h2 class="section-title">Performers</h2>${isAdmin?'<button class="btn-primary" onclick="showCreatePerformer()">+ Add Performer</button>':''}</div><div class="person-grid" id="performerGrid"><div class="spinner"></div></div>`;
        const data=await api('GET','/performers');
        const grid=document.getElementById('performerGrid');
        if(data.success&&data.data&&data.data.length>0){
            grid.innerHTML=data.data.map(p=>`<div class="person-card" onclick="loadPerformerDetail('${p.id}')"><div class="person-avatar">${p.photo_path?'<img src="'+p.photo_path+'">':'&#128100;'}</div><div class="person-name">${p.name}</div><div class="person-role">${p.performer_type} \u00b7 ${p.media_count||0} media</div></div>`).join('');
        } else grid.innerHTML='<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">&#128100;</div><div class="empty-state-title">No performers</div><p>Add performers to link them to your media</p></div>';
    }

    async function loadPerformerDetail(id) {
        const mc=document.getElementById('mainContent');
        mc.innerHTML='<div class="spinner"></div> Loading...';
        const data=await api('GET','/performers/'+id);
        if(!data.success){mc.innerHTML='<div class="empty-state"><div class="empty-state-title">Performer not found</div></div>';return;}
        const p=data.data.performer; const media=data.data.media||[];
        mc.innerHTML=`<div class="detail-hero"><div class="detail-poster">${p.photo_path?'<img src="'+p.photo_path+'">':'&#128100;'}</div><div class="detail-info"><h1>${p.name}</h1><div class="meta-row">${p.performer_type}${p.birth_date?' \u00b7 Born: '+new Date(p.birth_date).toLocaleDateString():''}</div>${p.bio?'<p class="description">'+p.bio+'</p>':''}<span class="tag tag-cyan">${p.media_count||0} media items</span></div></div>
        ${media.length>0?'<h3 style="color:#00D9FF;margin-bottom:16px;">Linked Media</h3><div class="media-grid">'+media.map(renderMediaCard).join('')+'</div>':''}
        <button class="btn-secondary" onclick="loadPerformersView()">&#8592; Back</button>`;
    }

    function showCreatePerformer(){const mc=document.getElementById('mainContent');mc.innerHTML=`<div class="section-header"><h2 class="section-title">Add Performer</h2></div><div style="max-width:500px;"><div class="form-group"><label>Name</label><input type="text" id="perfName"></div><div class="form-group"><label>Type</label><select id="perfType"><option value="actor">Actor</option><option value="director">Director</option><option value="producer">Producer</option><option value="musician">Musician</option><option value="narrator">Narrator</option><option value="adult_performer">Adult Performer</option><option value="other">Other</option></select></div><div class="form-group"><label>Bio</label><textarea id="perfBio" rows="3"></textarea></div><button class="btn-primary" onclick="createPerformer()">Create</button><button class="btn-secondary" style="margin-left:12px;" onclick="loadPerformersView()">Cancel</button></div>`;}
    async function createPerformer(){const n=document.getElementById('perfName').value,t=document.getElementById('perfType').value,b=document.getElementById('perfBio').value||null;if(!n){toast('Name required','error');return;}const d=await api('POST','/performers',{name:n,performer_type:t,bio:b});if(d.success){toast('Created!');loadPerformersView();}else toast(d.error,'error');}

    // ──── Tags ────
    async function loadTagsView() {
        const mc=document.getElementById('mainContent'); const isAdmin=currentUser&&currentUser.role==='admin';
        mc.innerHTML=`<div class="section-header"><h2 class="section-title">Tags & Genres</h2>${isAdmin?'<button class="btn-primary" onclick="showCreateTag()">+ Add Tag</button>':''}</div><div id="tagsList"><div class="spinner"></div></div>`;
        const data=await api('GET','/tags?tree=true');
        const div=document.getElementById('tagsList');
        if(data.success&&data.data&&data.data.length>0){
            div.innerHTML=data.data.map(t=>renderTag(t,0)).join('');
        } else div.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#127991;</div><div class="empty-state-title">No tags</div></div>';
    }

    function renderTag(tag, depth) {
        const indent = depth * 24;
        let html = `<div class="group-card" style="margin-left:${indent}px;display:flex;justify-content:space-between;align-items:center;"><div><h4>${tag.name}</h4><span class="tag tag-${tag.category==='genre'?'purple':tag.category==='custom'?'orange':'cyan'}">${tag.category}</span><span class="tag tag-green">${tag.media_count||0} media</span></div><button class="btn-danger btn-small" onclick="deleteTag('${tag.id}')">Delete</button></div>`;
        if (tag.children) tag.children.forEach(c => html += renderTag(c, depth+1));
        return html;
    }

    function showCreateTag(){const mc=document.getElementById('mainContent');mc.innerHTML=`<div class="section-header"><h2 class="section-title">Add Tag</h2></div><div style="max-width:500px;"><div class="form-group"><label>Name</label><input type="text" id="tagName"></div><div class="form-group"><label>Category</label><select id="tagCat"><option value="genre">Genre</option><option value="tag">Tag</option><option value="custom">Custom</option></select></div><div class="form-group"><label>Description</label><input type="text" id="tagDesc"></div><button class="btn-primary" onclick="createTag()">Create</button><button class="btn-secondary" style="margin-left:12px;" onclick="loadTagsView()">Cancel</button></div>`;}
    async function createTag(){const n=document.getElementById('tagName').value,c=document.getElementById('tagCat').value,d=document.getElementById('tagDesc').value||null;if(!n){toast('Name required','error');return;}const r=await api('POST','/tags',{name:n,category:c,description:d});if(r.success){toast('Created!');loadTagsView();}else toast(r.error,'error');}
    async function deleteTag(id){if(!confirm('Delete?'))return;const d=await api('DELETE','/tags/'+id);if(d.success){toast('Deleted');loadTagsView();}else toast(d.error,'error');}

    // ──── Studios ────
    async function loadStudiosView() {
        const mc=document.getElementById('mainContent'); const isAdmin=currentUser&&currentUser.role==='admin';
        mc.innerHTML=`<div class="section-header"><h2 class="section-title">Studios / Labels</h2>${isAdmin?'<button class="btn-primary" onclick="showCreateStudio()">+ Add Studio</button>':''}</div><div id="studiosList"><div class="spinner"></div></div>`;
        const data=await api('GET','/studios');
        const div=document.getElementById('studiosList');
        if(data.success&&data.data&&data.data.length>0){
            div.innerHTML=data.data.map(s=>`<div class="group-card"><div style="display:flex;justify-content:space-between;align-items:center;"><div><h4>${s.name}</h4><span class="tag tag-cyan">${s.studio_type}</span><span class="tag tag-green">${s.media_count||0} media</span></div>${isAdmin?`<button class="btn-danger btn-small" onclick="deleteStudio('${s.id}')">Delete</button>`:''}</div></div>`).join('');
        } else div.innerHTML='<div class="empty-state"><div class="empty-state-icon">&#127980;</div><div class="empty-state-title">No studios</div></div>';
    }
    function showCreateStudio(){const mc=document.getElementById('mainContent');mc.innerHTML=`<div class="section-header"><h2 class="section-title">Add Studio</h2></div><div style="max-width:500px;"><div class="form-group"><label>Name</label><input type="text" id="studioName"></div><div class="form-group"><label>Type</label><select id="studioType"><option value="studio">Studio</option><option value="label">Label</option><option value="publisher">Publisher</option><option value="network">Network</option><option value="distributor">Distributor</option></select></div><div class="form-group"><label>Website</label><input type="text" id="studioWeb"></div><button class="btn-primary" onclick="createStudio()">Create</button><button class="btn-secondary" style="margin-left:12px;" onclick="loadStudiosView()">Cancel</button></div>`;}
    async function createStudio(){const n=document.getElementById('studioName').value,t=document.getElementById('studioType').value,w=document.getElementById('studioWeb').value||null;if(!n){toast('Name required','error');return;}const d=await api('POST','/studios',{name:n,studio_type:t,website:w});if(d.success){toast('Created!');loadStudiosView();}else toast(d.error,'error');}
    async function deleteStudio(id){if(!confirm('Delete?'))return;const d=await api('DELETE','/studios/'+id);if(d.success){toast('Deleted');loadStudiosView();}else toast(d.error,'error');}

    // ──── Duplicates ────
    async function loadDuplicatesView() {
        const mc = document.getElementById('mainContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Duplicate Review</h2></div>
            <p style="color:#8a9bae;margin-bottom:20px;">Review media items flagged as exact (MD5) or potential (phash) duplicates</p>
            <div id="dupList"><div class="spinner"></div></div>`;
        const data = await api('GET', '/duplicates');
        const div = document.getElementById('dupList');
        if (!data.success) { div.innerHTML = '<p style="color:#ff6b6b;">Failed to load duplicates</p>'; return; }
        const groups = data.data && data.data.groups ? data.data.groups : [];
        if (groups.length === 0) {
            div.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128257;</div><div class="empty-state-title">No duplicates found</div><p>Scan libraries to detect duplicates via MD5 and perceptual hashing</p></div>';
            return;
        }
        div.innerHTML = groups.map(g => renderDuplicateGroup(g)).join('');
    }

    function renderDuplicateGroup(g) {
        const item = g.item;
        const typeClass = g.dup_type === 'exact' ? 'dup-type-exact' : 'dup-type-potential';
        const typeLabel = g.dup_type === 'exact' ? 'Exact Duplicate' : 'Potential Duplicate';
        const matches = g.matches || [];
        const decisions = g.decisions || [];

        let decisionsHtml = '';
        if (decisions.length > 0) {
            decisionsHtml = `<div class="dup-decisions"><strong>Prior decisions:</strong> ` +
                decisions.map(d => `${d.action} by ${d.decided_by} on ${new Date(d.decided_at).toLocaleDateString()}`
                    + (d.notes ? ' - ' + d.notes : '')).join('; ') + '</div>';
        }

        let matchesHtml = '';
        if (matches.length > 0) {
            matchesHtml = `<div class="dup-compare">` + renderDupCard(item, 'Source') +
                matches.map(m => renderDupCard(m.item, m.match_type === 'md5' ?
                    `<span class="dup-match-badge dup-match-md5">MD5 Match</span>` :
                    `<span class="dup-match-badge dup-match-phash">${Math.round(m.similarity * 100)}% Similar</span>`
                )).join('') + `</div>`;
        }

        const bestMatch = matches.length > 0 ? matches[0] : null;
        const partnerId = bestMatch ? bestMatch.item.id : '';
        const partnerTitle = bestMatch ? bestMatch.item.title : '';

        return `<div class="dup-group">
            <div class="dup-group-header">
                <h3 style="color:#e5e5e5;">${item.title}${item.year ? ' (' + item.year + ')' : ''}</h3>
                <span class="dup-type-badge ${typeClass}">${typeLabel}</span>
            </div>
            ${matchesHtml}
            ${decisionsHtml}
            <div class="dup-actions">
                <button class="btn-edit btn-small" onclick="dupEdit('${item.id}','${partnerId}')">&#9998; Edit</button>
                <button class="btn-edition btn-small" onclick="dupMergeEdition('${item.id}','${partnerId}','${item.title.replace(/'/g,"\\'")}','${partnerTitle.replace(/'/g,"\\'")}')">&#128191; Merge as Edition</button>
                <button class="btn-danger btn-small" onclick="dupDelete('${item.id}','${partnerId}')">&#128465; Delete</button>
                <button class="btn-secondary btn-small" onclick="dupIgnore('${item.id}','${partnerId}')">&#128683; Ignore</button>
            </div>
        </div>`;
    }

    function renderDupCard(item, label) {
        const fileSize = item.file_size ? (item.file_size / (1024*1024*1024)).toFixed(2) + ' GB' : '';
        const res = item.resolution || '';
        const filePath = item.file_path || '';
        const shortPath = filePath.length > 60 ? '...' + filePath.slice(-57) : filePath;
        return `<div class="dup-card">
            <div class="dup-card-header">
                <div class="dup-card-poster">${item.poster_path ? '<img src="'+item.poster_path+'">' : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:2rem;color:#4a5568;">&#127910;</div>'}</div>
                <div class="dup-card-meta">
                    <h4>${item.title}</h4>
                    <p>${item.year || 'N/A'}${res ? ' &middot; ' + res : ''}${fileSize ? ' &middot; ' + fileSize : ''}</p>
                    <p title="${filePath}" style="word-break:break-all;">${shortPath}</p>
                    <div style="margin-top:6px;">${label}</div>
                </div>
            </div>
        </div>`;
    }

    async function dupEdit(itemId, partnerId) {
        // Open the edit modal, then mark as addressed on save
        openEditModal(itemId);
        // After save, mark both as addressed
        window._dupResolveAfterEdit = { itemId, partnerId };
    }

    async function dupIgnore(itemId, partnerId) {
        const d = await api('POST', '/duplicates/resolve', { media_id: itemId, partner_id: partnerId, action: 'ignored' });
        if (d.success) { toast('Marked as ignored'); loadDuplicatesView(); loadSidebarCounts(); } else toast(d.error, 'error');
    }

    async function dupDelete(itemId, partnerId) {
        if (!confirm('Delete this item from the database?')) return;
        const deleteFile = confirm('Also delete the file from disk? (Cannot be undone)');
        const d = await api('POST', '/duplicates/resolve', { media_id: itemId, partner_id: partnerId, action: 'deleted', delete_file: deleteFile });
        if (d.success) { toast('Item deleted'); loadDuplicatesView(); loadSidebarCounts(); } else toast(d.error, 'error');
    }

    function dupMergeEdition(itemA, itemB, titleA, titleB) {
        document.getElementById('mergeItemA').value = itemA;
        document.getElementById('mergeItemB').value = itemB;
        const opts = document.getElementById('mergePrimaryOptions');
        opts.innerHTML = `
            <div class="merge-option selected" onclick="selectMergePrimary(this,'${itemA}')">
                <label><input type="radio" name="mergePrimary" value="${itemA}" checked> ${titleA} (Source)</label>
            </div>
            <div class="merge-option" onclick="selectMergePrimary(this,'${itemB}')">
                <label><input type="radio" name="mergePrimary" value="${itemB}"> ${titleB} (Match)</label>
            </div>`;
        document.getElementById('mergeEditionOverlay').classList.add('active');
    }

    function selectMergePrimary(el, id) {
        document.querySelectorAll('.merge-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        el.querySelector('input[type="radio"]').checked = true;
    }

    function closeMergeModal() {
        document.getElementById('mergeEditionOverlay').classList.remove('active');
    }

    async function submitMergeEdition() {
        const itemA = document.getElementById('mergeItemA').value;
        const itemB = document.getElementById('mergeItemB').value;
        const label = document.getElementById('mergeEditionLabel').value;
        const primaryId = document.querySelector('input[name="mergePrimary"]:checked').value;
        const d = await api('POST', '/duplicates/resolve', {
            media_id: itemA, partner_id: itemB, action: 'edition',
            edition_label: label, primary_id: primaryId
        });
        if (d.success) { toast('Merged as edition!'); closeMergeModal(); loadDuplicatesView(); loadSidebarCounts(); }
        else toast(d.error, 'error');
    }

    // Close merge modal on overlay click
    document.getElementById('mergeEditionOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeMergeModal();
    });

    // ──── Metadata Identify ────
    let _identifyMatches = [];
    let _identifyMediaId = '';

    async function identifyMedia(id) {
        const mc=document.getElementById('mainContent');
        mc.innerHTML='<div class="section-header"><h2 class="section-title">Identify Media</h2></div><div id="matchList"><div class="spinner"></div> Searching external sources...</div>';
        const data=await api('POST','/media/'+id+'/identify');
        const div=document.getElementById('matchList');
        _identifyMediaId = id;
        _identifyMatches = (data.success && data.data) ? data.data : [];
        if(_identifyMatches.length>0){
            const esc = (s) => s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
            div.innerHTML=_identifyMatches.map((m,i)=>`<div class="group-card"><div style="display:flex;gap:16px;align-items:start;"><div style="width:80px;min-width:80px;aspect-ratio:2/3;border-radius:10px;overflow:hidden;background:rgba(0,0,0,0.3);">${m.poster_url?'<img src="'+m.poster_url+'" style="width:100%;height:100%;object-fit:cover;">':'&#128247;'}</div><div><h4>${esc(m.title)}${m.year?' ('+m.year+')':''}</h4><p>${m.description?esc(m.description.substring(0,200))+'...':''}</p><span class="tag tag-cyan">${m.source}</span><span class="tag tag-green">${Math.round(m.confidence*100)}% match</span><button class="btn-primary btn-small" style="margin-top:8px;" onclick="applyMatchByIndex(${i})">Apply</button></div></div></div>`).join('');
        } else div.innerHTML='<div class="empty-state"><div class="empty-state-title">No matches found</div></div>';
        div.innerHTML+='<button class="btn-secondary" style="margin-top:16px;" onclick="loadMediaDetail(\''+id+'\')">&#8592; Back</button>';
    }

    async function applyMatchByIndex(idx) {
        const match = _identifyMatches[idx];
        if (!match) { toast('Match not found','error'); return; }
        const d=await api('POST','/media/'+_identifyMediaId+'/apply-meta',match);
        if(d.success){toast('Metadata applied!');loadMediaDetail(_identifyMediaId);}else toast(d.error,'error');
    }

    // ──── Edit Media ────
    async function openEditModal(id) {
        const data = await api('GET', '/media/' + id);
        if (!data.success) { toast('Failed to load media', 'error'); return; }
        const m = data.data;
        document.getElementById('editMediaId').value = m.id;
        document.getElementById('editTitle').value = m.title || '';
        document.getElementById('editSortTitle').value = m.sort_title || '';
        document.getElementById('editOriginalTitle').value = m.original_title || '';
        document.getElementById('editDescription').value = m.description || '';
        document.getElementById('editYear').value = m.year || '';
        document.getElementById('editReleaseDate').value = m.release_date ? m.release_date.substring(0,10) : '';
        document.getElementById('editRating').value = m.rating != null ? m.rating : '';
        // Edition type (always shown)
        document.getElementById('editEditionType').value = m.edition_type || 'Theatrical';
        // Lock status
        const lockDiv = document.getElementById('editLockStatus');
        const resetBtn = document.getElementById('editResetBtn');
        if (m.metadata_locked) {
            lockDiv.innerHTML = '<span class="lock-badge locked">&#128274; Metadata locked — auto-match will not overwrite your edits</span>';
            resetBtn.style.display = 'inline-flex';
        } else {
            lockDiv.innerHTML = '<span class="lock-badge unlocked">&#128275; Metadata unlocked — auto-match may update fields</span>';
            resetBtn.style.display = 'none';
        }
        document.getElementById('editMediaOverlay').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editMediaOverlay').classList.remove('active');
    }

    async function saveMediaEdit() {
        const id = document.getElementById('editMediaId').value;
        const title = document.getElementById('editTitle').value.trim();
        if (!title) { toast('Title is required', 'error'); return; }
        const sortTitle = document.getElementById('editSortTitle').value.trim() || null;
        const originalTitle = document.getElementById('editOriginalTitle').value.trim() || null;
        const description = document.getElementById('editDescription').value.trim() || null;
        const yearVal = document.getElementById('editYear').value;
        const year = yearVal ? parseInt(yearVal) : null;
        const releaseDate = document.getElementById('editReleaseDate').value || null;
        const ratingVal = document.getElementById('editRating').value;
        const rating = ratingVal !== '' ? parseFloat(ratingVal) : null;

        const editionType = document.getElementById('editEditionType').value;

        const d = await api('PUT', '/media/' + id, {
            title, sort_title: sortTitle, original_title: originalTitle,
            description, year, release_date: releaseDate, rating,
            edition_type: editionType
        });
        if (d.success) {
            toast('Changes saved! Metadata locked.');
            closeEditModal();
            // If triggered from duplicate review, mark as addressed
            if (window._dupResolveAfterEdit) {
                const r = window._dupResolveAfterEdit;
                await api('POST', '/duplicates/resolve', { media_id: r.itemId, partner_id: r.partnerId, action: 'edit' });
                window._dupResolveAfterEdit = null;
                loadDuplicatesView();
                loadSidebarCounts();
            } else {
                loadMediaDetail(id);
            }
        } else {
            toast(d.error || 'Save failed', 'error');
        }
    }

    async function resetMediaMeta() {
        const id = document.getElementById('editMediaId').value;
        if (!confirm('Reset metadata lock? The next auto-match or scan will be able to overwrite your edits.')) return;
        const d = await api('POST', '/media/' + id + '/reset');
        if (d.success) {
            toast('Metadata lock removed');
            closeEditModal();
            loadMediaDetail(id);
        } else {
            toast(d.error || 'Reset failed', 'error');
        }
    }

    // Close edit modal on Escape
    document.getElementById('editMediaOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    // ──── Settings (moved to settings.html) ────

    // ──── Admin ────
    async function loadAdminView() {
        if(!currentUser||currentUser.role!=='admin'){document.getElementById('mainContent').innerHTML='<div class="empty-state"><div class="empty-state-title">Admin access required</div></div>';return;}
        const mc=document.getElementById('mainContent');
        mc.innerHTML=`<div class="section-header"><h2 class="section-title">Admin Panel</h2></div><div class="settings-grid"><div class="settings-card"><h3>System Status</h3><div id="sysStatus"><div class="spinner"></div></div></div><div class="settings-card"><h3>Users</h3><div id="userList"><div class="spinner"></div></div></div><div class="settings-card" style="grid-column:1/-1;"><h3>Job Queue</h3><div id="jobList"><div class="spinner"></div></div></div></div>`;

        // System status
        const status=await api('GET','/status');
        document.getElementById('sysStatus').innerHTML=status.success?`<p><span class="status-dot green"></span>Server Online</p><p style="color:#8a9bae;margin-top:8px;">Version: ${status.data?.version||'0.3.0'}</p><p style="color:#8a9bae;">WebSocket clients: <span id="wsCount">${status.data?.ws_clients||0}</span></p>`:'<p><span class="status-dot red"></span>Error</p>';

        // Users
        const users=await api('GET','/users');
        const ul=document.getElementById('userList');
        if(users.success&&users.data){ul.innerHTML=users.data.map(u=>`<div class="job-item"><span class="status-dot ${u.is_active?'green':'red'}"></span><strong>${u.username}</strong><span class="tag tag-cyan">${u.role}</span><span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${u.email}</span></div>`).join('');}

        // Jobs
        const jobs=await api('GET','/jobs');
        const jl=document.getElementById('jobList');
        if(jobs.success&&jobs.data&&jobs.data.length>0){
            jl.innerHTML=jobs.data.map(j=>{
                const statusColor=j.status==='completed'?'green':j.status==='failed'?'red':j.status==='running'?'yellow':'';
                return `<div class="job-item"><span class="status-dot ${statusColor}"></span><strong>${j.job_type}</strong><span class="tag tag-${j.status==='completed'?'green':j.status==='failed'?'red':'cyan'}">${j.status}</span><div class="job-progress-bar"><div class="job-progress-fill" style="width:${j.progress}%"></div></div><span style="color:#5a6a7f;font-size:0.78rem;">${new Date(j.started_at).toLocaleString()}</span></div>`;
            }).join('');
        } else jl.innerHTML='<p style="color:#5a6a7f;">No recent jobs</p>';
    }

    // ──── Video Player ────
    // Plex-style streaming:
    // - Native formats (MP4/WebM): served directly with range requests (native seeking)
    // - Non-native formats (MKV/AVI): remuxed to MPEG-TS on-the-fly via FFmpeg pipe
    //   Video copied as-is, audio transcoded to AAC if needed. mpegts.js handles playback.
    // - Seeking in MPEGTS streams: restart stream with ?start= parameter
    let currentStreamInfo = null;
    let currentPlayMode = null; // 'direct', 'mpegts', 'hls'
    let knownDuration = 0; // Total duration from DB
    let seekOffset = 0; // FFmpeg -ss offset for MPEGTS streams

    // Destroy all active players
    function destroyPlayers() {
        if (hlsPlayer) { hlsPlayer.destroy(); hlsPlayer = null; }
        if (mpegtsPlayer) {
            mpegtsPlayer.pause();
            mpegtsPlayer.unload();
            mpegtsPlayer.detachMediaElement();
            mpegtsPlayer.destroy();
            mpegtsPlayer = null;
        }
    }

    async function playMedia(mediaId, title) {
        currentMediaId = mediaId;
        const overlay = document.getElementById('playerOverlay');
        const video = document.getElementById('videoPlayer');
        document.getElementById('playerTitle').textContent = title;
        overlay.classList.add('active');
        const token = localStorage.getItem('token');

        // Fetch stream info
        const info = await api('GET', `/stream/${mediaId}/info`);
        currentStreamInfo = info.success ? info.data : null;
        knownDuration = currentStreamInfo ? (currentStreamInfo.duration_seconds || 0) : 0;
        seekOffset = 0;

        const sel = document.getElementById('qualitySelect');
        let options = '';

        if (currentStreamInfo) {
            const nativeLabel = currentStreamInfo.native_resolution
                ? `Original (${currentStreamInfo.native_resolution}${currentStreamInfo.needs_remux ? ' \u00b7 direct stream' : ''})`
                : 'Original';
            options += `<option value="direct" selected>${nativeLabel}</option>`;

            if (currentStreamInfo.transcode_qualities) {
                currentStreamInfo.transcode_qualities.forEach(q => {
                    options += `<option value="transcode:${q}">${q} (transcode)</option>`;
                });
            }
        } else {
            options = '<option value="direct" selected>Original</option>';
        }
        sel.innerHTML = options;

        // Start playback — MPEGTS for non-native formats, direct for native
        if (currentStreamInfo && currentStreamInfo.needs_remux) {
            startMpegtsPlay(mediaId, token, 0);
        } else {
            startDirectPlay(mediaId, token, 0);
        }
        video.addEventListener('timeupdate', updatePlayerUI);
    }

    function playDirect(mediaId, title) {
        currentMediaId = mediaId;
        const overlay = document.getElementById('playerOverlay');
        const video = document.getElementById('videoPlayer');
        document.getElementById('playerTitle').textContent = title;
        overlay.classList.add('active');
        const token = localStorage.getItem('token');

        const sel = document.getElementById('qualitySelect');
        sel.innerHTML = '<option value="direct" selected>Original</option>';

        startDirectPlay(mediaId, token, 0);
        video.addEventListener('timeupdate', updatePlayerUI);
    }

    // Direct play for native browser formats (MP4/WebM) — supports range requests & seeking
    function startDirectPlay(mediaId, token, startSec) {
        const video = document.getElementById('videoPlayer');
        destroyPlayers();
        currentPlayMode = 'direct';
        seekOffset = 0;

        const url = `/api/v1/stream/${mediaId}/direct?token=${encodeURIComponent(token)}`;
        video.src = url;
        if (startSec > 0) {
            video.currentTime = startSec;
        }
        video.play().catch(e => {
            console.warn('Direct play starting...', e);
            setTimeout(() => video.play().catch(() => {}), 1000);
        });
    }

    // MPEGTS play for non-native formats (MKV/AVI) — Plex-style direct stream
    function startMpegtsPlay(mediaId, token, startSec) {
        const video = document.getElementById('videoPlayer');
        destroyPlayers();
        currentPlayMode = 'mpegts';
        seekOffset = startSec || 0;

        let url = `/api/v1/stream/${mediaId}/direct?token=${encodeURIComponent(token)}`;
        if (seekOffset > 0) {
            url += `&start=${seekOffset.toFixed(1)}`;
        }

        mpegtsPlayer = mpegts.createPlayer({
            type: 'mpegts',
            isLive: true, // piped stream (no defined end)
            url: url,
            duration: knownDuration ? knownDuration * 1000 : undefined,
        }, {
            enableStashBuffer: true,
            stashInitialSize: 512 * 1024, // 512KB initial buffer
            fixAudioTimestampGap: true, // auto-fix A/V sync gaps
            lazyLoad: false,
            autoCleanupSourceBuffer: true,
            autoCleanupMaxBackwardDuration: 300,
            autoCleanupMinBackwardDuration: 120,
        });

        mpegtsPlayer.attachMediaElement(video);
        mpegtsPlayer.load();
        mpegtsPlayer.play();

        mpegtsPlayer.on(mpegts.Events.ERROR, (errorType, errorDetail, errorInfo) => {
            console.error('mpegts.js error:', errorType, errorDetail, errorInfo);
            if (errorType === mpegts.ErrorTypes.NETWORK_ERROR) {
                toast('Stream interrupted — retrying...', 'info');
            } else {
                toast('Playback error: ' + errorDetail, 'error');
            }
        });
    }

    // HLS play for quality-specific transcodes
    function startHLSPlay(mediaId, quality, token) {
        const video = document.getElementById('videoPlayer');
        destroyPlayers();
        currentPlayMode = 'hls';
        seekOffset = 0;

        const masterUrl = `/api/v1/stream/${mediaId}/master.m3u8?token=${encodeURIComponent(token)}`;
        hlsPlayer = new Hls({
            xhrSetup: (xhr, url) => {
                const sep = url.includes('?') ? '&' : '?';
                xhr.open('GET', url + sep + 'token=' + encodeURIComponent(token), true);
            }
        });
        hlsPlayer.loadSource(masterUrl);
        hlsPlayer.attachMedia(video);
        hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
            const levels = hlsPlayer.levels;
            for (let i = 0; i < levels.length; i++) {
                if (levels[i].height + 'p' === quality || levels[i].name === quality) {
                    hlsPlayer.currentLevel = i;
                    break;
                }
            }
            video.play().catch(() => {});
        });
        hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
            if (data.fatal) {
                console.error('HLS error:', data);
                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    toast('Transcoding starting... retrying in 3s', 'info');
                    setTimeout(() => hlsPlayer && hlsPlayer.startLoad(), 3000);
                } else {
                    toast('Playback error: ' + data.details, 'error');
                }
            }
        });
    }

    function changeQuality(value) {
        const token = localStorage.getItem('token');
        if (value === 'direct') {
            if (currentStreamInfo && currentStreamInfo.needs_remux) {
                startMpegtsPlay(currentMediaId, token, 0);
            } else {
                startDirectPlay(currentMediaId, token, 0);
            }
        } else if (value.startsWith('transcode:')) {
            const quality = value.replace('transcode:', '');
            startHLSPlay(currentMediaId, quality, token);
        }
    }

    function closePlayer() {
        const overlay = document.getElementById('playerOverlay');
        const video = document.getElementById('videoPlayer');
        overlay.classList.remove('active');
        video.pause();
        video.src = '';
        destroyPlayers();

        // Save watch progress
        if (currentMediaId && video.currentTime > 0) {
            const progress = Math.floor(video.currentTime + seekOffset);
            api('POST', '/watch/'+currentMediaId+'/progress', {
                progress_seconds: progress,
                duration_seconds: knownDuration || Math.floor(video.duration || 0)
            });
        }
        currentMediaId = null;
        currentStreamInfo = null;
        currentPlayMode = null;
        knownDuration = 0;
        seekOffset = 0;
    }

    function updatePlayerUI() {
        const video = document.getElementById('videoPlayer');
        const fill = document.getElementById('playerProgressFill');
        const timeEl = document.getElementById('playerTime');

        const totalDuration = (knownDuration > 0) ? knownDuration
            : (isFinite(video.duration) ? video.duration : 0);
        const currentTime = video.currentTime + seekOffset;

        if (totalDuration > 0) {
            fill.style.width = Math.min((currentTime / totalDuration * 100), 100) + '%';
            timeEl.textContent = formatTime(currentTime) + ' / ' + formatTime(totalDuration);
        }
    }

    function togglePlay() { const v=document.getElementById('videoPlayer'); v.paused?v.play():v.pause(); }

    function skipBack() {
        const video = document.getElementById('videoPlayer');
        if (currentPlayMode === 'mpegts') {
            // MPEGTS: restart stream from new position
            const target = Math.max(0, video.currentTime + seekOffset - 10);
            startMpegtsPlay(currentMediaId, localStorage.getItem('token'), target);
        } else {
            video.currentTime = Math.max(0, video.currentTime - 10);
        }
    }

    function skipForward() {
        const video = document.getElementById('videoPlayer');
        if (currentPlayMode === 'mpegts') {
            // MPEGTS: restart stream from new position
            const target = video.currentTime + seekOffset + 10;
            startMpegtsPlay(currentMediaId, localStorage.getItem('token'), target);
        } else {
            video.currentTime += 10;
        }
    }

    function toggleMute() { const v=document.getElementById('videoPlayer'); v.muted=!v.muted; }
    function toggleFullscreen() { const o=document.getElementById('playerOverlay'); document.fullscreenElement?document.exitFullscreen():o.requestFullscreen(); }

    function seekPlayer(e) {
        const video = document.getElementById('videoPlayer');
        const bar = document.getElementById('playerProgress');
        const pct = e.offsetX / bar.offsetWidth;

        const totalDuration = (knownDuration > 0) ? knownDuration
            : (isFinite(video.duration) ? video.duration : 0);
        if (totalDuration <= 0) return;

        const targetTime = pct * totalDuration;

        if (currentPlayMode === 'mpegts') {
            // MPEGTS: restart FFmpeg from seek position (Plex-style)
            startMpegtsPlay(currentMediaId, localStorage.getItem('token'), targetTime);
        } else {
            // Native MP4 or HLS: standard seeking
            video.currentTime = targetTime;
        }
    }

    // Keyboard shortcuts for player
    document.addEventListener('keydown', (e) => {
        if (!document.getElementById('playerOverlay').classList.contains('active')) return;
        switch(e.key) {
            case ' ': e.preventDefault(); togglePlay(); break;
            case 'ArrowLeft': skipBack(); break;
            case 'ArrowRight': skipForward(); break;
            case 'f': toggleFullscreen(); break;
            case 'm': toggleMute(); break;
            case 'Escape': closePlayer(); break;
        }
    });

    // ──── Init ────
    checkAuth();
    </script>
</body>
</html>
