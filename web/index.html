<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineVault</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="theme-color" content="#00d9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/previews/icon-192.png">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.8.0/dist/mpegts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dashjs@4/dist/dash.all.min.js"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1" async></script>
    <!-- Chart.js moved to settings.html with analytics -->
    <style>
        /* Page-specific overrides only — main styles in styles.css */
    </style>
</head>
<body>
    <!-- Sidebar Toggle (Mobile) -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">&#9776;</button>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <!-- Login Intro Video -->
    <div class="intro-overlay" id="introOverlay">
        <video id="introVideo" preload="auto" playsinline>
            <source src="/assets/intro.mp4" type="video/mp4">
        </video>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
            <div class="logo">CineVault</div>

            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-view="home"><span class="nav-icon">&#127968;</span><span>Home</span></div>
            </div>

            <div class="nav-section" id="librariesNav">
                <div class="nav-label">Libraries</div>
            </div>

            <div class="nav-section">
                <div class="nav-label">Discover</div>
                <div class="nav-item" data-view="collections"><span class="nav-icon">&#128218;</span><span>Collections</span></div>
                <div class="nav-item" data-view="livetv"><span class="nav-icon">&#128250;</span><span>Live TV</span></div>
                <div class="nav-item" data-view="requests"><span class="nav-icon">&#128172;</span><span>Requests</span></div>
                <div class="nav-item" data-view="stats"><span class="nav-icon">&#128202;</span><span>My Stats</span></div>
            </div>


            <div class="sidebar-footer" id="sidebarFooter"></div>
        </div>

        <!-- Main Content -->
        <div style="flex: 1; display: flex; flex-direction: column; min-width: 0;">
            <div class="top-bar">
                <div class="search-box">
                    <input type="text" placeholder="Search your media..." id="searchInput" aria-label="Search your media">
                </div>
                <div class="user-menu">
                    <div class="task-indicator" id="taskIndicator" style="display:none;">
                        <svg class="task-ring" viewBox="0 0 36 36">
                            <circle class="task-ring-bg" cx="18" cy="18" r="15.9155"/>
                            <circle class="task-ring-fill" id="taskRingFill" cx="18" cy="18" r="15.9155"
                                stroke-dasharray="100" stroke-dashoffset="100"
                                transform="rotate(-90 18 18)"/>
                        </svg>
                        <span class="task-count" id="taskCount"></span>
                        <div class="task-tooltip" id="taskTooltip"></div>
                    </div>
                    <span class="ws-status" id="wsStatus" style="display:none;"></span>
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-header">
                            <div class="user-dropdown-name" id="udName"></div>
                            <div class="user-dropdown-role" id="udRole"></div>
                        </div>
                        <div class="user-dropdown-item" onclick="openProfileSwitch()"><span class="ud-icon">&#128101;</span> Switch Profile</div>
                        <div class="user-dropdown-item" id="udManageProfilesItem" onclick="openManageProfiles()" style="display:none;"><span class="ud-icon">&#128100;</span> Manage Profiles</div>
                        <div class="user-dropdown-item" onclick="navigate('profile')"><span class="ud-icon">&#9998;</span> Edit Profile</div>
                        <div class="user-dropdown-item" onclick="navigate('stats')"><span class="ud-icon">&#128202;</span> My Stats</div>
                        <div class="user-dropdown-item" onclick="navigate('requests')"><span class="ud-icon">&#128269;</span> Content Requests</div>
                        <div class="user-dropdown-item" onclick="joinSyncSession()"><span class="ud-icon">&#128101;</span> Join Watch Party</div>
                        <div class="user-dropdown-item" onclick="navigate('livetv')"><span class="ud-icon">&#128250;</span> Live TV</div>
                        <div class="user-dropdown-item" id="udSettingsItem" onclick="window.location.href='settings.html'" style="display:none;"><span class="ud-icon">&#9881;</span> Settings</div>
                        <div class="user-dropdown-sep"></div>
                        <div class="user-dropdown-item logout" id="udLogoutBtn"><span class="ud-icon">&#128682;</span> Logout</div>
                    </div>
                </div>
            </div>
            <div class="main-content" id="mainContent" role="main" aria-label="Main content"></div>
        </div>
    </div>

    <!-- Setup Wizard (first run) -->
    <div class="setup-overlay" id="setupOverlay" role="dialog" aria-modal="true" aria-labelledby="setupOverlayTitle">
        <div class="setup-card">
            <div class="setup-logo" id="setupOverlayTitle">CineVault Setup</div>
            <div class="setup-subtitle">Create your admin account to get started</div>
            <div id="setupMessage"></div>
            <form id="setupForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="setupUsername" required autocomplete="username">
                </div>
                <div class="setup-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="setupFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="setupLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="setupEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="setupPassword" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label>PIN (for fast login)</label>
                    <input type="text" id="setupPin" inputmode="numeric" maxlength="10" autocomplete="off" placeholder="4-digit PIN">
                    <div class="setup-pin-note">Numeric only. Used for quick sign-in on shared devices.</div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%;margin-top:16px;">Create Admin Account</button>
            </form>
        </div>
    </div>

    <!-- Login Modal (standard) -->
    <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
        <div class="modal-content">
            <h2 class="modal-title" id="loginModalTitle">Welcome to CineVault</h2>
            <div id="authMessage"></div>
            <form id="loginForm">
                <div class="form-group"><label>Username</label><input type="text" id="loginUsername" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Login</button>
            </form>
        </div>
    </div>

    <!-- Fast Login Overlay -->
    <div class="fast-login-overlay" id="fastLoginOverlay">
        <div class="fast-login-back" id="fastLoginBack" style="display:none;" onclick="fastLoginShowUsers()">&#10094; Enter PIN</div>
        <div class="fast-login-title" id="fastLoginTitle">Select User</div>

        <!-- User Grid -->
        <div class="fast-login-grid" id="fastLoginGrid"></div>

        <!-- PIN Entry -->
        <div class="pin-entry-container" id="pinEntryContainer">
            <div class="pin-entry-user-info">
                <div class="pin-entry-user-card">
                    <div class="pin-entry-avatar" id="pinEntryAvatar"></div>
                    <div class="pin-entry-name" id="pinEntryName"></div>
                </div>
                <div>
                    <div class="pin-boxes" id="pinBoxes"></div>
                    <div class="pin-error" id="pinError"></div>
                </div>
            </div>
            <input type="text" class="pin-hidden-input" id="pinHiddenInput" inputmode="numeric" autocomplete="off" autofocus>
            <div class="pin-forgot" onclick="fastLoginShowStandard()">Use password instead</div>
        </div>

        <div class="fast-login-fallback" onclick="fastLoginShowStandard()">Use username &amp; password</div>
    </div>

    <!-- Profile Switch Overlay (post-login) -->
    <div class="profile-switch-overlay" id="profileSwitchOverlay">
        <div class="profile-switch-title">Switch Profile</div>
        <div class="profile-switch-grid" id="profileSwitchGrid"></div>
        <div class="profile-switch-close" onclick="closeProfileSwitch()">Cancel</div>
    </div>

    <!-- Household "Who's Watching?" Picker (shown after master login) -->
    <div class="household-picker-overlay" id="householdPickerOverlay">
        <div class="household-picker-title">Who's Watching?</div>
        <div class="household-picker-grid" id="householdPickerGrid"></div>
    </div>

    <!-- Shared hidden PIN input for profile switch / household picker (must be outside overlays so it's always focusable) -->
    <input type="text" id="hpPinHidden" inputmode="numeric" style="position:fixed;top:-9999px;left:-9999px;opacity:0;">

    <!-- Manage Profiles Modal -->
    <div class="manage-profiles-overlay" id="manageProfilesOverlay">
        <div class="manage-profiles-card">
            <div class="manage-profiles-close" onclick="closeManageProfiles()" role="button" tabindex="0" aria-label="Close">&times;</div>
            <div class="manage-profiles-title">Manage Profiles</div>
            <div id="mpProfileList"></div>
            <button class="mp-add-btn" id="mpAddBtn" onclick="mpShowAddForm()">+ Add Profile</button>
            <div id="mpFormArea"></div>
        </div>
    </div>

    <!-- Video Player Overlay -->
    <div class="video-player-overlay" id="playerOverlay" role="dialog" aria-modal="true" aria-label="Media player">
        <div class="player-top-bar">
            <span class="player-title" id="playerTitle"></span>
            <button class="player-close" onclick="closePlayer()" aria-label="Close player">&#10005;</button>
        </div>
        <video id="videoPlayer"></video>
        <div class="skip-segment-btn" id="skipSegmentBtn" onclick="skipCurrentSegment()" style="display:none;" aria-label="Skip segment">
            <span id="skipSegmentLabel">Skip Intro</span>
            <span class="skip-arrow">&#9654;&#9654;</span>
        </div>
        <div class="player-controls">
            <div class="player-progress" id="playerProgress" onclick="seekPlayer(event)">
                <div class="player-progress-fill" id="playerProgressFill"></div>
                <div class="player-chapters" id="playerChapters"></div>
            </div>
            <div class="player-btns">
                <button class="player-btn" id="playPauseBtn" onclick="togglePlay()" aria-label="Play / Pause"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="player-btn" onclick="skipBack()" aria-label="Skip back"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
                <button class="player-btn" onclick="skipForward()" aria-label="Skip forward"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
                <span class="player-time" id="playerTime">0:00 / 0:00</span>
                <button class="player-btn" id="muteBtn" onclick="toggleMute()" aria-label="Mute / Unmute"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
                <select class="player-quality-select" id="subtitleSelect" onchange="changeSubtitle(this.value)">
                    <option value="off">Subtitles Off</option>
                </select>
                <select class="player-quality-select" id="audioTrackSelect" onchange="changeAudioTrack(this.value)"></select>
                <select class="player-quality-select" id="qualitySelect" onchange="changeQuality(this.value)"></select>
                <select class="player-quality-select" id="chapterSelect" onchange="jumpToChapter(this.value)" style="display:none;">
                    <option value="">Chapters</option>
                </select>
                <button class="player-btn" id="addMarkerBtn" onclick="addMarkerFromPlayer()" title="Add Scene Marker" style="display:none;" aria-label="Add scene marker"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></button>
                <button class="player-btn" id="pipBtn" onclick="togglePiP()" title="Picture-in-Picture" aria-label="Picture-in-Picture"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/></svg></button>
                <button class="player-btn" id="castBtn" onclick="startCast(currentMediaId, document.getElementById('playerTitle').textContent)" title="Cast" style="display:none;" aria-label="Cast to device"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm20-7H3c-1.1 0-2 .9-2 2v3h2V5h18v14h-7v2h7c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg></button>
                <button class="player-btn" onclick="toggleFullscreen()" style="margin-left:auto;" aria-label="Fullscreen"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
            </div>
        </div>
    </div>

    <!-- Edit Media Modal -->
    <div class="edit-modal-overlay" id="editMediaOverlay" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="edit-modal">
            <div class="edit-modal-title" id="editModalTitle">Edit Media Item</div>
            <input type="hidden" id="editMediaId">
            <div class="form-group">
                <label>Title *</label>
                <input type="text" id="editTitle">
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Sort Title</label>
                    <input type="text" id="editSortTitle" placeholder="Leave blank to use title">
                </div>
                <div class="form-group">
                    <label>Original Title</label>
                    <input type="text" id="editOriginalTitle" placeholder="Original language title">
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="editDescription" rows="4" placeholder="Synopsis or description"></textarea>
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="editYear" min="1800" max="2100" placeholder="e.g. 2024">
                </div>
                <div class="form-group">
                    <label>Release Date</label>
                    <input type="date" id="editReleaseDate">
                </div>
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Rating</label>
                    <input type="number" id="editRating" min="0" max="10" step="0.1" placeholder="0.0 – 10.0">
                </div>
                <div class="form-group">
                    <label>Edition</label>
                    <select id="editEditionType">
                        <option value="Theatrical">Theatrical</option>
                        <option value="Director's Cut">Director's Cut</option>
                        <option value="Extended">Extended</option>
                        <option value="Extended Edition">Extended Edition</option>
                        <option value="Unrated">Unrated</option>
                        <option value="Remastered">Remastered</option>
                        <option value="IMAX">IMAX</option>
                        <option value="4K Remaster">4K Remaster</option>
                        <option value="Special Edition">Special Edition</option>
                        <option value="Alternate">Alternate</option>
                    </select>
                </div>
            </div>
            <div class="form-group" id="parentMovieGroup" style="display:none;">
                <label>Parent Movie</label>
                <div class="parent-search-wrap">
                    <input type="text" id="parentMovieSearch" placeholder="Search for parent movie..." autocomplete="off" oninput="searchParentMovie(this.value)">
                    <input type="hidden" id="parentMovieId">
                    <div class="parent-search-results" id="parentSearchResults"></div>
                </div>
                <div id="parentCurrentInfo" style="display:none;"></div>
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Content Rating</label>
                    <select id="editContentRating">
                        <option value="">Not Rated</option>
                        <option value="G">G</option>
                        <option value="PG">PG</option>
                        <option value="PG-13">PG-13</option>
                        <option value="R">R</option>
                        <option value="NC-17">NC-17</option>
                        <option value="TV-Y">TV-Y</option>
                        <option value="TV-Y7">TV-Y7</option>
                        <option value="TV-G">TV-G</option>
                        <option value="TV-PG">TV-PG</option>
                        <option value="TV-14">TV-14</option>
                        <option value="TV-MA">TV-MA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Original Language</label>
                    <input type="text" id="editOriginalLanguage" placeholder="e.g. en, ja, fr">
                </div>
            </div>
            <div class="form-group">
                <label>Tagline</label>
                <input type="text" id="editTagline" placeholder="Movie tagline">
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="editCountry" placeholder="e.g. US, GB, JP">
                </div>
                <div class="form-group">
                    <label>Trailer URL</label>
                    <input type="text" id="editTrailerUrl" placeholder="YouTube or direct URL">
                </div>
            </div>
            <div class="form-group">
                <label>Genres <span style="color:#6b7b8d;font-weight:400;font-size:0.78rem;">(comma-separated)</span></label>
                <input type="text" id="editGenres" placeholder="e.g. Action, Thriller, Drama">
            </div>
            <div class="form-group">
                <label>Studio</label>
                <input type="text" id="editStudio" placeholder="e.g. Warner Bros, A24">
            </div>
            <div class="edit-field-row">
                <div class="form-group">
                    <label>Poster URL</label>
                    <div class="input-with-btn">
                        <input type="text" id="editPosterPath" placeholder="URL or local path to poster image">
                        <button type="button" class="btn-browse" onclick="openArtworkPicker(document.getElementById('editMediaId').value,'poster')" title="Browse posters">&#128444;</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Backdrop URL</label>
                    <div class="input-with-btn">
                        <input type="text" id="editBackdropPath" placeholder="URL or local path to backdrop image">
                        <button type="button" class="btn-browse" onclick="openArtworkPicker(document.getElementById('editMediaId').value,'backdrop')" title="Browse backdrops">&#127756;</button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Custom Notes</label>
                <textarea id="editCustomNotes" rows="2" placeholder="Personal notes (e.g. Hybrid remux, AI upscale, etc.)"></textarea>
            </div>
            <div class="form-group">
                <label>Custom Tags <span style="color:#6b7b8d;font-weight:400;font-size:0.78rem;">(comma-separated)</span></label>
                <input type="text" id="editCustomTags" placeholder="e.g. reference, demo-disc, keeper">
            </div>
            <div id="editCastSection" style="margin-top:8px;">
                <span class="field-locks-toggle" id="editCastToggle" onclick="toggleEditCast()">
                    <span class="arrow">&#9656;</span> Cast &amp; Crew
                </span>
                <div id="editCastPanel" style="display:none;"></div>
            </div>
            <div id="editSeriesGroup" style="display:none; margin-top:8px;">
                <div id="editSeriesInfo"></div>
                <button class="btn-secondary" style="font-size:0.82rem; padding:8px 14px;" onclick="openSeriesModal()">&#127910; Add to Series</button>
            </div>
            <div id="editLockStatus" style="margin-top:8px;"></div>
            <div style="margin-top:4px;">
                <span class="field-locks-toggle" id="fieldLocksToggle" onclick="toggleFieldLocks()">
                    <span class="arrow">&#9656;</span> Per-Field Locks
                </span>
                <div id="fieldLocksPanel" style="display:none;">
                    <div class="field-locks-grid" id="fieldLocksGrid"></div>
                    <div style="font-size:0.72rem; color:#6b7b8d; margin-top:6px; padding:0 4px;">
                        Locked fields are protected from automatic updates during scans and auto-match.
                    </div>
                </div>
            </div>
            <div class="edit-modal-actions">
                <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-danger" id="editResetBtn" style="display:none;" onclick="resetMediaMeta()">&#8635; Reset Lock</button>
                <button class="btn-primary" onclick="saveMediaEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add to Series Modal -->
    <div class="series-modal-overlay" id="seriesModalOverlay">
        <div class="series-modal">
            <div class="series-modal-title">Add to Series</div>
            <input type="hidden" id="seriesMediaId">
            <div class="form-group">
                <label>Series Name</label>
                <div style="position:relative;">
                    <input type="text" id="seriesNameInput" placeholder="Select or type a new series name..." autocomplete="off" oninput="filterSeriesDropdown(this.value)" onfocus="showSeriesDropdown()">
                    <div id="seriesDropdown" style="position:absolute;top:100%;left:0;right:0;z-index:10;display:none;max-height:200px;overflow-y:auto;background:linear-gradient(135deg,#1a2332 0%,#0d1b2a 100%);border:1px solid rgba(0,217,255,0.25);border-radius:0 0 10px 10px;box-shadow:0 8px 32px rgba(0,0,0,0.5);"></div>
                </div>
                <input type="hidden" id="seriesSelectedId">
            </div>
            <div class="form-group">
                <label>Order in Series</label>
                <input type="number" id="seriesOrderInput" min="1" placeholder="e.g. 1, 2, 3..." value="1">
            </div>
            <div class="series-modal-actions">
                <button class="btn-secondary" onclick="closeSeriesModal()">Cancel</button>
                <button class="btn-primary" onclick="saveToSeries()">Save</button>
            </div>
        </div>
    </div>

    <!-- Merge as Edition Modal -->
    <div class="merge-modal-overlay" id="mergeEditionOverlay">
        <div class="merge-modal">
            <div class="merge-modal-title">Merge as Edition</div>
            <input type="hidden" id="mergeItemA">
            <input type="hidden" id="mergeItemB">
            <div class="form-group">
                <label>Edition Label</label>
                <select id="mergeEditionLabel">
                    <option value="Theatrical">Theatrical</option>
                    <option value="Director's Cut">Director's Cut</option>
                    <option value="Extended">Extended</option>
                    <option value="Unrated">Unrated</option>
                    <option value="IMAX">IMAX</option>
                    <option value="4K Remaster">4K Remaster</option>
                    <option value="Special Edition">Special Edition</option>
                    <option value="Alternate">Alternate</option>
                </select>
            </div>
            <div class="form-group">
                <label>Select Primary Item</label>
                <div id="mergePrimaryOptions"></div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                <button class="btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn-primary" onclick="submitMergeEdition()" style="background:linear-gradient(135deg,#a855f7,#7c3aed);">Merge</button>
            </div>
        </div>
    </div>

    <!-- Edition Picker Modal -->
    <div class="edition-picker-overlay" id="editionPickerOverlay" role="dialog" aria-modal="true" aria-labelledby="editionPickerTitle">
        <div class="edition-picker">
            <div class="edition-picker-title" id="editionPickerTitle">Select Edition to Play</div>
            <div id="editionPickerList"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:20px;">
                <button class="btn-secondary" onclick="closeEditionPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Library Context Menu (shared, fixed-position) -->
    <div class="lib-ctx-menu" id="libCtxMenu"></div>

    <!-- Bulk Action Bar -->
    <div class="bulk-action-bar" id="bulkActionBar">
        <div class="bulk-bar-left">
            <span class="bulk-count" id="bulkCount">0 selected</span>
            <button onclick="selectAllVisible()">Select All</button>
        </div>
        <div class="bulk-bar-actions">
            <button onclick="openBulkEditModal()">&#9998; Edit</button>
            <button onclick="bulkMarkPlayed()">&#9989; Played</button>
            <button onclick="bulkMarkUnplayed()">&#9711; Unplayed</button>
            <button onclick="bulkRefreshMetadata()">&#8635; Refresh</button>
            <button onclick="openBulkAddToCollection()">&#128218; Collection</button>
            <button class="bulk-btn-danger" onclick="bulkDelete()">&#128465; Delete</button>
        </div>
        <div class="bulk-bar-right">
            <button onclick="selectionState.clear()">&#10005; Cancel</button>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="bulk-edit-overlay" id="bulkEditOverlay">
        <div class="bulk-edit-modal">
            <div class="bulk-edit-title">Bulk Edit</div>
            <div class="bulk-edit-subtitle" id="bulkEditSubtitle">Editing 0 items — only checked fields will be applied</div>

            <div class="bulk-field-row" id="bfRating">
                <div class="bulk-field-check"><input type="checkbox" id="bfRatingCheck" onchange="toggleBulkField('bfRating')"></div>
                <div class="bulk-field-body">
                    <label>Rating</label>
                    <input type="number" id="bfRatingVal" min="0" max="10" step="0.1" placeholder="0.0 – 10.0" disabled>
                </div>
            </div>

            <div class="bulk-field-row" id="bfEdition">
                <div class="bulk-field-check"><input type="checkbox" id="bfEditionCheck" onchange="toggleBulkField('bfEdition')"></div>
                <div class="bulk-field-body">
                    <label>Edition Type</label>
                    <select id="bfEditionVal" disabled>
                        <option value="Theatrical">Theatrical</option>
                        <option value="Director's Cut">Director's Cut</option>
                        <option value="Extended">Extended</option>
                        <option value="Extended Edition">Extended Edition</option>
                        <option value="Unrated">Unrated</option>
                        <option value="Remastered">Remastered</option>
                        <option value="IMAX">IMAX</option>
                        <option value="4K Remaster">4K Remaster</option>
                        <option value="Special Edition">Special Edition</option>
                        <option value="Alternate">Alternate</option>
                    </select>
                </div>
            </div>

            <div class="bulk-field-row" id="bfTags">
                <div class="bulk-field-check"><input type="checkbox" id="bfTagsCheck" onchange="toggleBulkField('bfTags')"></div>
                <div class="bulk-field-body">
                    <label>Custom Tags</label>
                    <div class="bulk-tag-mode">
                        <button class="active" id="bfTagModeAdd" onclick="setBulkTagMode('add')">+ Add</button>
                        <button id="bfTagModeRemove" onclick="setBulkTagMode('remove')">- Remove</button>
                        <button id="bfTagModeReplace" onclick="setBulkTagMode('replace')">Replace</button>
                    </div>
                    <input type="text" id="bfTagsVal" placeholder="e.g. reference, demo-disc, keeper" disabled>
                </div>
            </div>

            <div class="bulk-field-row" id="bfNotes">
                <div class="bulk-field-check"><input type="checkbox" id="bfNotesCheck" onchange="toggleBulkField('bfNotes')"></div>
                <div class="bulk-field-body">
                    <label>Custom Notes</label>
                    <div class="bulk-tag-mode">
                        <button class="active" id="bfNotesModeAppend" onclick="setBulkNotesMode('append')">Append</button>
                        <button id="bfNotesModeReplace" onclick="setBulkNotesMode('replace')">Replace</button>
                    </div>
                    <textarea id="bfNotesVal" rows="2" placeholder="Notes to apply..." disabled></textarea>
                </div>
            </div>

            <div class="bulk-edit-actions">
                <button class="btn-secondary" onclick="closeBulkEditModal()">Cancel</button>
                <button class="btn-primary" onclick="saveBulkEdit()">Apply to All</button>
            </div>
        </div>
    </div>

    <!-- Collection Picker Modal -->
    <div class="collection-picker-overlay" id="collectionPickerOverlay">
        <div class="collection-picker-modal">
            <div class="collection-picker-title">Add to Collection</div>
            <div class="picker-create-row" id="pickerCreateRow">
                <input type="text" id="pickerNewCollName" placeholder="New collection name..." class="picker-create-input">
                <button class="btn-primary btn-small" onclick="pickerCreateCollection()">Create</button>
            </div>
            <div class="collection-picker-list" id="collectionPickerList">
                <div class="spinner"></div> Loading collections...
            </div>
            <div class="collection-picker-actions">
                <button class="btn-secondary" onclick="closeCollectionPicker()">Cancel</button>
                <button class="btn-primary" onclick="saveToCollections()">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>


    <!-- CineVault Application Scripts (modularized) -->
    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/views.js"></script>
    <script src="/js/sync.js"></script>
    <script src="/js/music.js"></script>
    <script src="/js/extras.js"></script>
    <script src="/js/player.js"></script>
    <script src="/js/profiles.js"></script>
    <script src="/js/engagement.js"></script>
    <script src="/js/init.js"></script>
</body>
</html>
