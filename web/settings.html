<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineVault ‚Äî Settings</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        /* Page-specific overrides only ‚Äî main styles in styles.css */
    </style>
</head>
<body>
    <div class="settings-container">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar" role="navigation" aria-label="Settings navigation">
            <a class="settings-back" href="index.html">
                <span class="settings-back-icon">&#8592;</span>
                <span>Back to CineVault</span>
            </a>
            <div class="settings-logo">Settings</div>

            <div class="settings-nav-label">Playback</div>
            <div class="settings-nav-item active" data-section="video">
                <span class="settings-nav-icon">&#127916;</span><span>Video</span>
            </div>
            <div class="settings-nav-item" data-section="skip">
                <span class="settings-nav-icon">&#9193;</span><span>Skip</span>
            </div>
            <div class="settings-nav-item" data-section="transcoder">
                <span class="settings-nav-icon">&#9881;</span><span>Transcoder</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="cinema">
                <span class="settings-nav-icon">&#127910;</span><span>Cinema Mode</span>
            </div>

            <div class="settings-nav-label">Access</div>
            <div class="settings-nav-item" data-section="users">
                <span class="settings-nav-icon">&#128101;</span><span>Users</span>
            </div>
            <div class="settings-nav-item" data-section="security">
                <span class="settings-nav-icon">&#128274;</span><span>Security</span>
            </div>
            <div class="settings-nav-item" data-section="experience">
                <span class="settings-nav-icon">&#127912;</span><span>Experience</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="admin">
                <span class="settings-nav-icon">&#9881;</span><span>Admin Panel</span>
            </div>

            <div class="settings-nav-label">Content</div>
            <div class="settings-nav-item" data-section="libraries">
                <span class="settings-nav-icon">&#128218;</span><span>Libraries</span>
            </div>
            <div class="settings-nav-item" data-section="metadata">
                <span class="settings-nav-icon">&#128196;</span><span>Metadata</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="duplicates">
                <span class="settings-nav-icon">&#128257;</span><span>Duplicates</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="analytics">
                <span class="settings-nav-icon">&#128202;</span><span>Analytics</span>
            </div>

            <div class="settings-nav-label admin-only-label">Advanced</div>
            <div class="settings-nav-item admin-only" data-section="dlna">
                <span class="settings-nav-icon">&#128225;</span><span>DLNA</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="livetv">
                <span class="settings-nav-icon">&#128250;</span><span>Live TV</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="webhooks">
                <span class="settings-nav-icon">&#128279;</span><span>Webhooks</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="apikeys">
                <span class="settings-nav-icon">&#128273;</span><span>API Keys</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="backup">
                <span class="settings-nav-icon">&#128190;</span><span>Backup</span>
            </div>
            <div class="settings-nav-item admin-only" data-section="import">
                <span class="settings-nav-icon">&#128229;</span><span>Import</span>
            </div>

            <div class="sidebar-footer" id="sidebarFooter"></div>
        </div>

        <!-- Main Content -->
        <div class="settings-main" id="settingsContent" role="main" aria-label="Settings content">
            <div class="spinner"></div> Loading...
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Delete Confirm Dialog -->
    <div class="dup-delete-overlay" id="dupDeleteOverlay" onclick="if(event.target===this)closeDupDeleteDialog()">
        <div class="dup-delete-dialog">
            <h3>Delete Duplicate</h3>
            <p>How would you like to remove this item?</p>
            <div class="dup-delete-options">
                <button class="btn-secondary" onclick="closeDupDeleteDialog()">Cancel</button>
                <button class="btn-primary" onclick="confirmDupDelete(false)">Remove from DB</button>
                <button class="btn-danger" onclick="confirmDupDelete(true)">Remove &amp; Delete from Disk</button>
            </div>
        </div>
    </div>

    <script>
    const API = '/api/v1';
    let currentUser = null;

    function headers() { return { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' }; }

    async function api(method, path, body) {
        const opts = { method, headers: headers() };
        if (body) opts.body = JSON.stringify(body);
        try { const res = await fetch(API + path, opts); return res.json(); } catch(e) { return { success: false, error: e.message }; }
    }

    function toast(msg, type='success') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast message ' + type;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    const MEDIA_ICONS = { movies:'&#127916;', adult_movies:'&#128274;', tv_shows:'&#128250;', music:'&#127925;', music_videos:'&#127911;', home_videos:'&#127909;', other_videos:'&#128253;', images:'&#128247;', audiobooks:'&#128214;' };
    const MEDIA_LABELS = { movies:'Movies', adult_movies:'Adult Movies', tv_shows:'TV Shows', music:'Music', music_videos:'Music Videos', home_videos:'Home Videos', other_videos:'Other Videos', images:'Photos', audiobooks:'Audiobooks' };

    // ‚îÄ‚îÄ‚îÄ‚îÄ Auth Check ‚îÄ‚îÄ‚îÄ‚îÄ
    function checkAuth() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
            currentUser = JSON.parse(user);
            // Show/hide admin-only nav items
            document.querySelectorAll('.settings-nav-item.admin-only, .admin-only-label').forEach(el => {
                el.style.display = (currentUser.role === 'admin') ? '' : 'none';
            });
            navigateSection(getInitialSection());
            loadSidebarVersion();
        } else {
            window.location.href = 'index.html';
        }
    }

    async function loadSidebarVersion() {
        try {
            const d = await api('GET', '/status');
            const ver = d.success && d.data ? d.data.version : '';
            const el = document.getElementById('sidebarFooter');
            if (el && ver) el.innerHTML = `<div class="sidebar-version">v${ver}</div><div class="sidebar-credit">Designed by 21 Mexican Jumping Llamas</div>`;
        } catch {}
    }

    function getInitialSection() {
        const hash = window.location.hash.replace('#', '');
        return hash || 'video';
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Section Navigation ‚îÄ‚îÄ‚îÄ‚îÄ
    function navigateSection(section) {
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        const navItem = document.querySelector(`.settings-nav-item[data-section="${section}"]`);
        if (navItem) navItem.classList.add('active');
        window.location.hash = section;

        switch(section) {
            case 'video': loadVideoSection(); break;
            case 'skip': loadSkipSection(); break;
            case 'transcoder': loadTranscoderSection(); break;
            case 'cinema': loadCinemaSection(); break;
            case 'users': loadUsersSection(); break;
            case 'security': loadSecuritySection(); break;
            case 'experience': loadExperienceSection(); break;
            case 'libraries': loadLibrariesSection(); break;
            case 'metadata': loadMetadataSection(); break;
            case 'duplicates': loadDuplicatesSection(); break;
            case 'analytics': loadAnalyticsSection(); break;
            case 'admin': loadAdminSection(); break;
            case 'dlna': loadDLNASection(); break;
            case 'livetv': loadLiveTVSection(); break;
            case 'webhooks': loadWebhooksSection(); break;
            case 'apikeys': loadAPIKeysSection(); break;
            case 'backup': loadBackupSection(); break;
            case 'import': loadImportSection(); break;
            default: loadVideoSection();
        }
    }

    document.querySelectorAll('.settings-nav-item[data-section]').forEach(item => {
        item.addEventListener('click', () => navigateSection(item.dataset.section));
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ Video Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadVideoSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Video</h2></div>
            <p class="section-desc">Configure playback preferences and video quality settings.</p>
            <div class="settings-grid" id="videoGrid"><div class="spinner"></div></div>`;

        const prefs = await api('GET', '/settings/playback');
        const p = prefs.success ? prefs.data : { playback_mode: 'always_ask', preferred_quality: '1080p', auto_play_next: true };

        document.getElementById('videoGrid').innerHTML = `
            <div class="settings-card">
                <h3>Playback Preferences</h3>
                <div class="form-group"><label>Edition Playback Mode</label>
                    <select id="setPbMode">
                        <option value="always_ask" ${p.playback_mode==='always_ask'?'selected':''}>Always Ask</option>
                        <option value="play_default" ${p.playback_mode==='play_default'?'selected':''}>Play Default</option>
                        <option value="highest_quality" ${p.playback_mode==='highest_quality'?'selected':''}>Highest Quality</option>
                        <option value="lowest_quality" ${p.playback_mode==='lowest_quality'?'selected':''}>Lowest Quality</option>
                        <option value="last_played" ${p.playback_mode==='last_played'?'selected':''}>Last Played</option>
                    </select>
                </div>
                <div class="form-group"><label>Preferred Quality</label>
                    <select id="setPbQuality">
                        <option value="360p" ${p.preferred_quality==='360p'?'selected':''}>360p</option>
                        <option value="480p" ${p.preferred_quality==='480p'?'selected':''}>480p</option>
                        <option value="720p" ${p.preferred_quality==='720p'?'selected':''}>720p</option>
                        <option value="1080p" ${p.preferred_quality==='1080p'?'selected':''}>1080p</option>
                        <option value="4K" ${p.preferred_quality==='4K'?'selected':''}>4K</option>
                    </select>
                </div>
                <div class="form-group"><label><input type="checkbox" id="setPbAutoPlay" ${p.auto_play_next?'checked':''}> Auto-play next episode</label></div>
                <button class="btn-primary" onclick="savePlaybackPrefs()">Save</button>
            </div>`;
    }

    async function savePlaybackPrefs() {
        const d = await api('PUT', '/settings/playback', {
            playback_mode: document.getElementById('setPbMode').value,
            preferred_quality: document.getElementById('setPbQuality').value,
            auto_play_next: document.getElementById('setPbAutoPlay').checked
        });
        if (d.success) toast('Playback settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Transcoder Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadTranscoderSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Transcoder</h2></div>
            <p class="section-desc">Configure hardware acceleration and transcoding quality preferences.</p>
            <div class="settings-grid" id="transcoderGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('transcoderGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure transcoder settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const hwAccel = sys.hw_accel || 'none';
        const maxTranscodes = sys.max_simultaneous_transcodes || '2';
        const defaultQuality = sys.transcode_default_quality || '1080p';
        const threadCount = sys.transcode_thread_count || '0';

        document.getElementById('transcoderGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Hardware Acceleration</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Select the hardware encoder to use for transcoding. Requires compatible GPU drivers.</p>
                <div class="form-group"><label>Hardware Encoder</label>
                    <select id="setHwAccel">
                        <option value="none" ${hwAccel==='none'?'selected':''}>None (Software / libx264)</option>
                        <option value="nvenc" ${hwAccel==='nvenc'?'selected':''}>NVIDIA NVENC</option>
                        <option value="qsv" ${hwAccel==='qsv'?'selected':''}>Intel Quick Sync (QSV)</option>
                        <option value="vaapi" ${hwAccel==='vaapi'?'selected':''}>VA-API (Linux)</option>
                    </select>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Transcode Defaults</h3>
                <div class="form-group"><label>Default Quality</label>
                    <select id="setTranscodeQuality">
                        <option value="360p" ${defaultQuality==='360p'?'selected':''}>360p</option>
                        <option value="480p" ${defaultQuality==='480p'?'selected':''}>480p</option>
                        <option value="720p" ${defaultQuality==='720p'?'selected':''}>720p</option>
                        <option value="1080p" ${defaultQuality==='1080p'?'selected':''}>1080p</option>
                        <option value="4K" ${defaultQuality==='4K'?'selected':''}>4K</option>
                    </select>
                </div>
                <div class="form-group"><label>Max Simultaneous Transcodes</label>
                    <select id="setMaxTranscodes">
                        <option value="1" ${maxTranscodes==='1'?'selected':''}>1</option>
                        <option value="2" ${maxTranscodes==='2'?'selected':''}>2</option>
                        <option value="3" ${maxTranscodes==='3'?'selected':''}>3</option>
                        <option value="4" ${maxTranscodes==='4'?'selected':''}>4</option>
                        <option value="6" ${maxTranscodes==='6'?'selected':''}>6</option>
                        <option value="8" ${maxTranscodes==='8'?'selected':''}>8</option>
                    </select>
                </div>
                <div class="form-group"><label>Thread Count</label>
                    <select id="setThreadCount">
                        <option value="0" ${threadCount==='0'?'selected':''}>Auto (recommended)</option>
                        <option value="2" ${threadCount==='2'?'selected':''}>2 threads</option>
                        <option value="4" ${threadCount==='4'?'selected':''}>4 threads</option>
                        <option value="6" ${threadCount==='6'?'selected':''}>6 threads</option>
                        <option value="8" ${threadCount==='8'?'selected':''}>8 threads</option>
                    </select>
                    <p class="settings-helper">0 = auto-detect CPU threads. Only applies to software encoding.</p>
                </div>
            </div>
            <div style="grid-column:1/-1;text-align:right;">
                <button class="btn-primary" onclick="saveTranscoderSettings()">Save</button>
            </div>`;
    }

    async function saveTranscoderSettings() {
        const settings = {
            hw_accel: document.getElementById('setHwAccel').value,
            max_simultaneous_transcodes: document.getElementById('setMaxTranscodes').value,
            transcode_default_quality: document.getElementById('setTranscodeQuality').value,
            transcode_thread_count: document.getElementById('setThreadCount').value
        };
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Transcoder settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Users Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadUsersSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Users</h2></div>
            <p class="section-desc">Manage user accounts and roles.</p>
            <div class="settings-grid" id="usersGrid"><div class="spinner"></div></div>`;

        const accountHtml = `
            <div class="settings-card">
                <h3>Current Account</h3>
                <p style="color:#8a9bae;margin-bottom:12px;">Logged in as <strong style="color:#00D9FF;">${currentUser?.username}</strong></p>
                <p style="color:#8a9bae;">Role: <span class="tag tag-cyan">${currentUser?.role}</span></p>
            </div>`;

        let usersHtml = '';
        if (currentUser?.role === 'admin') {
            const users = await api('GET', '/users');
            if (users.success && users.data) {
                // Separate master accounts and sub-profiles
                const masters = users.data.filter(u => !u.parent_user_id);
                const subs = users.data.filter(u => u.parent_user_id);
                const subsByParent = {};
                subs.forEach(u => {
                    if (!subsByParent[u.parent_user_id]) subsByParent[u.parent_user_id] = [];
                    subsByParent[u.parent_user_id].push(u);
                });

                function renderUserRow(u, isSub) {
                    const dot = `<span class="user-status-dot ${u.is_active!==false?'active':'inactive'}"></span>`;
                    const nameLabel = isSub ? (u.display_name || u.username) : u.username;
                    const isYou = u.id === currentUser.id;
                    const actions = isYou
                        ? '<span class="tag tag-green" style="font-size:0.72rem;">You</span>'
                        : `<select class="user-role-select" data-uid="${u.id}" onchange="changeUserRole('${u.id}', this.value)">
                                <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                                <option value="user" ${u.role==='user'?'selected':''}>User</option>
                                <option value="guest" ${u.role==='guest'?'selected':''}>Guest</option>
                            </select>
                            <button class="btn-secondary btn-small" onclick="toggleUserActive('${u.id}', ${u.is_active!==false?'false':'true'})" title="${u.is_active!==false?'Deactivate':'Activate'}">${u.is_active!==false?'&#128683; Disable':'&#9989; Enable'}</button>
                            <button class="btn-secondary btn-small" onclick="showStreamLimits('${u.id}','${u.username}')" title="Stream Limits">&#127916; Limits</button>
                            <button class="btn-secondary btn-small" onclick="adminSetPin('${u.id}','${u.username}')" title="Set PIN">&#128273; PIN</button>
                            <button class="btn-danger btn-small" onclick="deleteUser('${u.id}','${u.username}')" title="Delete user">&#128465;</button>`;
                    return `<div class="user-admin-row ${isSub?'user-sub-row':''}" id="user-row-${u.id}">
                        ${dot}
                        <strong class="user-admin-name">${nameLabel}</strong>
                        <span class="tag tag-cyan">${u.role}</span>
                        <span class="user-admin-email">${u.email||''}</span>
                        ${isSub ? '<span class="tag tag-purple" style="font-size:0.68rem;">Sub-profile</span>' : ''}
                        ${u.is_kids_profile ? '<span class="tag tag-green" style="font-size:0.68rem;">Kids</span>' : ''}
                        ${u.has_pin ? '<span class="tag tag-orange" style="font-size:0.68rem;">PIN</span>' : ''}
                        <span style="flex:1;"></span>
                        ${actions}
                    </div>`;
                }

                let rowsHtml = '';
                masters.forEach(m => {
                    rowsHtml += renderUserRow(m, false);
                    const children = subsByParent[m.id] || [];
                    children.forEach(sub => { rowsHtml += renderUserRow(sub, true); });
                });

                usersHtml = `<div class="settings-card full-width">
                    <h3>All Users</h3>
                    ${rowsHtml}
                </div>`;
            }
        }

        document.getElementById('usersGrid').innerHTML = accountHtml + usersHtml;
    }

    async function changeUserRole(userId, newRole) {
        const d = await api('PUT', '/users/' + userId, { role: newRole });
        if (d.success) toast('Role updated to ' + newRole);
        else toast(d.error || 'Failed to update role', 'error');
    }

    async function toggleUserActive(userId, setActive) {
        const active = setActive === 'true' || setActive === true;
        const d = await api('PUT', '/users/' + userId, { is_active: active });
        if (d.success) { toast(active ? 'User activated' : 'User deactivated'); loadUsersSection(); }
        else toast(d.error || 'Failed to update status', 'error');
    }

    async function adminSetPin(userId, username) {
        const pin = prompt('Set new PIN for ' + username + ':');
        if (!pin) return;
        const d = await api('PUT', '/users/' + userId + '/pin', { pin: pin });
        if (d.success) toast('PIN set for ' + username);
        else toast(d.error || 'Failed to set PIN', 'error');
    }

    async function deleteUser(userId, username) {
        if (!confirm('Delete user "' + username + '"? This cannot be undone.')) return;
        const d = await api('DELETE', '/users/' + userId);
        if (d.success) { toast('User deleted'); loadUsersSection(); }
        else toast(d.error || 'Failed to delete user', 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Security Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSecuritySection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Security</h2></div>
            <p class="section-desc">Configure PIN protection and security settings for your CineVault instance.</p>
            <div class="settings-grid" id="securityGrid"><div class="spinner"></div></div>`;

        let html = `
            <div class="settings-card">
                <h3>Fast Login PIN</h3>
                <p class="settings-helper" style="margin-bottom:14px;">Set a numeric PIN for quick login via the Fast Login screen.</p>
                <div class="form-group">
                    <label>PIN</label>
                    <div style="display:flex;gap:10px;">
                        <input type="password" id="setMyPin" placeholder="Enter PIN" style="flex:1;" inputmode="numeric" maxlength="10">
                        <button class="btn-primary btn-small" onclick="saveMyPin()">Set PIN</button>
                    </div>
                </div>
            </div>`;

        if (currentUser?.role === 'admin') {
            const sysSett = await api('GET', '/settings/system');
            const sys = sysSett.success ? sysSett.data : {};
            const fastLoginEnabled = sys.fast_login_enabled !== 'false';
            const fastLoginPinLen = sys.fast_login_pin_length || '4';
            html += `
            <div class="settings-card">
                <h3>Fast Login</h3>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setFastLoginEnabled" ${fastLoginEnabled?'checked':''}><span class="toggle-slider"></span></span>
                        Use Fast Login
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:16px;">Display user icons and have them enter a PIN instead of login name and password.</p>
                <div class="form-group">
                    <label>Fast Login PIN Length</label>
                    <select id="setFastLoginPinLen">
                        <option value="4" ${fastLoginPinLen==='4'?'selected':''}>4 digits</option>
                        <option value="5" ${fastLoginPinLen==='5'?'selected':''}>5 digits</option>
                        <option value="6" ${fastLoginPinLen==='6'?'selected':''}>6 digits</option>
                        <option value="8" ${fastLoginPinLen==='8'?'selected':''}>8 digits</option>
                    </select>
                    <p class="settings-helper">The length of the PIN number for the user if using Fast Login.</p>
                </div>
                <div style="text-align:right;margin-top:16px;">
                    <button class="btn-primary" onclick="saveSecuritySettings()">Save</button>
                </div>
            </div>`;
        }

        document.getElementById('securityGrid').innerHTML = html;
    }

    async function saveMyPin() {
        const pin = document.getElementById('setMyPin').value;
        if (!pin) { toast('Please enter a PIN', 'error'); return; }
        const d = await api('PUT', '/auth/pin', { pin: pin });
        if (d.success) { toast('PIN saved!'); document.getElementById('setMyPin').value = ''; }
        else toast(d.error, 'error');
    }

    async function saveSecuritySettings() {
        const settings = {};
        const flEnabledEl = document.getElementById('setFastLoginEnabled');
        if (flEnabledEl) settings.fast_login_enabled = flEnabledEl.checked ? 'true' : 'false';
        const flPinLenEl = document.getElementById('setFastLoginPinLen');
        if (flPinLenEl) settings.fast_login_pin_length = flPinLenEl.value;
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Security settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Experience Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadExperienceSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Experience</h2></div>
            <p class="section-desc">Customize login behavior and user experience preferences.</p>
            <div class="settings-grid" id="experienceGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('experienceGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure experience settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const introEnabled = sys.login_intro_enabled !== 'false';
        const introMuted = sys.login_intro_muted === 'true';

        document.getElementById('experienceGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Login Intro</h3>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setIntroSkip" ${introEnabled?'':'checked'}><span class="toggle-slider"></span></span>
                        Skip Intro on Login
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:16px;">When disabled, a cinematic intro plays after login on each new session.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setIntroMuted" ${introMuted?'checked':''}><span class="toggle-slider"></span></span>
                        No Audio on Intro
                    </label>
                </div>
                <p class="settings-helper">Mute the intro video audio. When disabled, audio plays with the intro.</p>
                <div style="text-align:right;margin-top:20px;">
                    <button class="btn-primary" onclick="saveExperienceSettings()">Save</button>
                </div>
            </div>`;
    }

    async function saveExperienceSettings() {
        const settings = {};
        const introSkipEl = document.getElementById('setIntroSkip');
        if (introSkipEl) settings.login_intro_enabled = introSkipEl.checked ? 'false' : 'true';
        const introMutedEl = document.getElementById('setIntroMuted');
        if (introMutedEl) settings.login_intro_muted = introMutedEl.checked ? 'true' : 'false';
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Experience settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Skip Preferences Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSkipSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Skip Detection</h2></div>
            <p class="section-desc">Configure automatic intro, credits, and recap skipping behavior.</p>
            <div class="settings-grid" id="skipGrid"><div class="spinner"></div></div>`;

        const res = await api('GET', '/settings/skip');
        const prefs = res.success ? res.data : { skip_intros: false, skip_credits: false, skip_recaps: false, show_skip_button: true };
        const isAdmin = currentUser && currentUser.role === 'admin';

        document.getElementById('skipGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Skip Button Behavior</h3>
                <p class="settings-helper" style="margin-bottom:16px;">When a skip segment is detected, a "Skip Intro / Credits / Recap" button appears on the player. Enable auto-skip to skip automatically without pressing the button.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setShowSkipBtn" ${prefs.show_skip_button?'checked':''}><span class="toggle-slider"></span></span>
                        Show Skip Button
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:20px;">Display the skip button overlay when intros, credits, or recaps are detected.</p>
                <h3 style="margin-top:24px;">Auto-Skip</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Automatically skip these segments without showing a button.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipIntros" ${prefs.skip_intros?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Intros
                    </label>
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipCredits" ${prefs.skip_credits?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Credits
                    </label>
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipRecaps" ${prefs.skip_recaps?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Recaps
                    </label>
                </div>
                <div style="text-align:right;margin-top:20px;">
                    <button class="btn-primary" onclick="saveSkipPrefs()">Save</button>
                </div>
            </div>
            ${isAdmin ? `<div class="settings-card full-width">
                <h3>Detect Skip Segments</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Run the skip detection engine on a library to identify intros, credits, recaps, and anime OP/ED sequences.</p>
                <div id="skipDetectLibList"><div class="spinner"></div></div>
            </div>` : ''}`;

        if (isAdmin) loadSkipDetectLibraries();
    }

    async function loadSkipDetectLibraries() {
        const libRes = await api('GET', '/libraries');
        const container = document.getElementById('skipDetectLibList');
        if (!libRes.success || !libRes.data || !libRes.data.length) {
            container.innerHTML = '<p style="color:#5a6a7f;">No libraries found.</p>';
            return;
        }
        container.innerHTML = libRes.data
            .filter(lib => lib.media_type === 'tv_shows' || lib.media_type === 'movies')
            .map(lib => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-subtle);">
                    <div>
                        <strong>${lib.name}</strong>
                        <span class="tag tag-cyan" style="margin-left:8px;">${lib.media_type === 'tv_shows' ? 'TV Shows' : 'Movies'}</span>
                    </div>
                    <button class="btn-secondary btn-small" onclick="runSegmentDetection('${lib.id}', this)">&#128269; Detect Segments</button>
                </div>
            `).join('');
    }

    async function runSegmentDetection(libId, btn) {
        btn.disabled = true;
        btn.textContent = 'Queued...';
        const res = await api('POST', '/libraries/' + libId + '/detect-segments');
        if (res.success) {
            toast('Segment detection queued!');
            btn.textContent = 'Running...';
        } else {
            toast(res.error || 'Failed to start detection', 'error');
            btn.disabled = false;
            btn.textContent = 'üîç Detect Segments';
        }
    }

    async function saveSkipPrefs() {
        const prefs = {
            skip_intros: document.getElementById('setSkipIntros').checked,
            skip_credits: document.getElementById('setSkipCredits').checked,
            skip_recaps: document.getElementById('setSkipRecaps').checked,
            show_skip_button: document.getElementById('setShowSkipBtn').checked,
        };
        const d = await api('PUT', '/settings/skip', prefs);
        if (d.success) toast('Skip preferences saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Libraries Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLibrariesSection() {
        const mc = document.getElementById('settingsContent');
        const isAdmin = currentUser && currentUser.role === 'admin';
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Libraries</h2>${isAdmin?'<button class="btn-primary" onclick="showCreateLibrary()">+ Add Library</button>':''}</div>
            <p class="section-desc">Manage your media libraries, folders, and scanning preferences.</p>
            <div id="libList"><div class="spinner"></div> Loading...</div>`;

        const data = await api('GET', '/libraries');
        const div = document.getElementById('libList');
        if (data.success && data.data && data.data.length > 0) {
            div.innerHTML = data.data.map(lib => {
                const accessLabel = {everyone:'Everyone',select_users:'Select People',admin_only:'Admin Only'}[lib.access_level]||'Everyone';
                const accessColor = {everyone:'tag-green',select_users:'tag-purple',admin_only:'tag-red'}[lib.access_level]||'tag-green';
                const folderPaths = (lib.folders && lib.folders.length > 0) ? lib.folders.map(f => f.folder_path).join(', ') : lib.path;
                const folderCount = (lib.folders && lib.folders.length > 1) ? `<span class="tag tag-orange" style="margin-left:6px;">${lib.folders.length} folders</span>` : '';
                let settingsTags = '';
                if (!lib.include_in_homepage) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Home</span>';
                if (!lib.include_in_search) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Search</span>';
                if (!lib.retrieve_metadata) settingsTags += '<span class="tag tag-orange" style="margin-left:4px;">No Metadata</span>';
                if (lib.media_type === 'adult_movies' && lib.adult_content_type) settingsTags += `<span class="tag tag-purple" style="margin-left:4px;">${lib.adult_content_type === 'clips' ? 'Clips' : 'Movies'}</span>`;
                return `<div class="library-card" id="lib-card-${lib.id}"><div style="flex:1;"><h3>${lib.name}</h3><p style="color:#8a9bae;font-size:0.85rem;"><span class="tag tag-cyan">${MEDIA_LABELS[lib.media_type]||lib.media_type}</span>${lib.season_grouping?'<span class="tag tag-purple" style="margin-left:6px;">Season Grouping</span>':''}<span class="tag ${accessColor}" style="margin-left:6px;">${accessLabel}</span>${folderCount}<span style="margin-left:8px;">${folderPaths}</span></p><div class="lib-settings-tags">${settingsTags}</div><p style="color:#5a6a7f;font-size:0.78rem;margin-top:6px;">${lib.last_scan_at?'Last scan: '+new Date(lib.last_scan_at).toLocaleString():'Never scanned'}</p><div class="scan-progress" id="scan-progress-${lib.id}"><div class="scan-progress-bar"><div class="scan-progress-fill" id="scan-fill-${lib.id}"></div></div><div class="scan-progress-text"><span class="filename" id="scan-file-${lib.id}"></span><span id="scan-count-${lib.id}"></span></div></div></div><div class="library-actions">${isAdmin?`<button class="btn-secondary btn-small" onclick="showEditLibraryForm('${lib.id}')">&#9998; Edit</button><button class="btn-secondary btn-small" id="scan-btn-${lib.id}" onclick="scanLibrary('${lib.id}',this)">&#128269; Scan</button><button class="btn-danger btn-small" onclick="deleteLibrary('${lib.id}')">Delete</button>`:''}</div></div>`;
            }).join('');
        } else {
            div.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#128218;</div><div class="empty-state-title">No libraries configured</div><p>Create your first library to start organizing media</p></div>`;
        }
    }

    async function scanLibrary(id, btn) {
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Scanning...';
        const prog = document.getElementById('scan-progress-' + id);
        if (prog) prog.classList.add('active');
        try {
            const data = await api('POST', '/libraries/' + id + '/scan');
            if (data.success) {
                if (data.data.job_id) { toast('Scan job started...'); }
                else {
                    const r = data.data;
                    toast(`Scan: ${r.files_added} added, ${r.files_found} total`);
                    loadLibrariesSection();
                }
            } else {
                toast('Scan failed: ' + (data.error||'Unknown'), 'error');
                btn.disabled = false; btn.innerHTML = '&#128269; Scan';
                if (prog) prog.classList.remove('active');
            }
        } catch(e) {
            toast('Scan error: ' + e.message, 'error');
            btn.disabled = false; btn.innerHTML = '&#128269; Scan';
            if (prog) prog.classList.remove('active');
        }
    }

    async function deleteLibrary(id) {
        if (!confirm('Delete this library and all its media?')) return;
        const d = await api('DELETE', '/libraries/' + id);
        if (d.success) { toast('Library deleted'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    async function showEditLibraryForm(libId) {
        const data = await api('GET', '/libraries/' + libId);
        if (!data.success) { toast('Failed to load library', 'error'); return; }
        const lib = data.data;
        const mc = document.getElementById('settingsContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}" ${k===lib.media_type?'selected':''}>${v}</option>`).join('');
        const folders = (lib.folders && lib.folders.length > 0) ? lib.folders : [{ folder_path: lib.path }];
        const folderRows = folders.map((f, i) => `<div class="folder-row" data-idx="${i}">
            <input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;" value="${f.folder_path || ''}">
            <button class="btn-secondary" onclick="openFolderBrowser(${i})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            ${i > 0 ? '<button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>' : ''}
        </div>`).join('');

        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Edit Library</h2></div>
        <div style="max-width:560px;">
            <input type="hidden" id="editLibId" value="${lib.id}">
            <div class="form-group"><label>Name</label><input type="text" id="libName" value="${lib.name}"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" disabled>${types}</select>
                <p style="color:#5a6a7f;font-size:0.75rem;margin-top:4px;">Media type cannot be changed after creation</p>
            </div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">${folderRows}</div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="${lib.media_type === 'tv_shows' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" ${lib.season_grouping?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no" ${!lib.season_grouping?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="${lib.media_type === 'adult_movies' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" ${(!lib.adult_content_type || lib.adult_content_type === 'movies')?'checked':''}><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips" ${lib.adult_content_type === 'clips'?'checked':''}><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone" ${lib.access_level==='everyone'?'selected':''}>Everyone</option>
                    <option value="select_users" ${lib.access_level==='select_users'?'selected':''}>Select People</option>
                    <option value="admin_only" ${lib.access_level==='admin_only'?'selected':''}>Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="${lib.access_level==='select_users'?'':'display:none;'}margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" ${lib.include_in_homepage?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no" ${!lib.include_in_homepage?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" ${lib.include_in_search?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no" ${!lib.include_in_search?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" ${lib.retrieve_metadata?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no" ${!lib.retrieve_metadata?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Import</div>
                        <div class="option-row-desc">Read Kodi-compatible .nfo sidecar files during scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoImport" value="yes" ${lib.nfo_import?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="nfoImport" value="no" ${!lib.nfo_import?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Export</div>
                        <div class="option-row-desc">Write Kodi-compatible .nfo files after metadata is resolved</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoExport" value="yes" ${lib.nfo_export?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="nfoExport" value="no" ${!lib.nfo_export?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="saveEditLibrary()">Save Changes</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesSection()">Cancel</button>
        </div>`;

        if (lib.access_level === 'select_users') {
            const usersData = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            const allowed = lib.allowed_users ? lib.allowed_users.map(u => u.toString()) : [];
            if (usersData.success && usersData.data && usersData.data.length > 0) {
                list.innerHTML = usersData.data.filter(u => u.role !== 'admin').map(u =>
                    `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}" ${allowed.includes(u.id)?'checked':''}>
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`
                ).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            }
        }
    }

    async function saveEditLibrary() {
        const id = document.getElementById('editLibId').value;
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const nfo_import = document.querySelector('input[name="nfoImport"]:checked')?.value === 'yes';
        const nfo_export = document.querySelector('input[name="nfoExport"]:checked')?.value === 'yes';

        const d = await api('PUT', '/libraries/' + id, {
            name, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type,
            nfo_import, nfo_export
        });
        if (d.success) { toast('Library updated!'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    function showCreateLibrary() {
        const mc = document.getElementById('settingsContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Create Library</h2></div>
        <div style="max-width:560px;">
            <div class="form-group"><label>Name</label><input type="text" id="libName" placeholder="My Movies"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" onchange="onLibTypeChange()">${types}</select></div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">
                    <div class="folder-row" data-idx="0">
                        <input type="text" class="lib-folder-input" placeholder="/media/movies" style="flex:1;">
                        <button class="btn-secondary" onclick="openFolderBrowser(0)" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
                    </div>
                </div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no"><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" checked><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips"><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone">Everyone</option>
                    <option value="select_users">Select People</option>
                    <option value="admin_only">Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Import</div>
                        <div class="option-row-desc">Read Kodi-compatible .nfo sidecar files during scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoImport" value="yes"><span>Yes</span></label>
                        <label><input type="radio" name="nfoImport" value="no" checked><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Export</div>
                        <div class="option-row-desc">Write Kodi-compatible .nfo files after metadata is resolved</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoExport" value="yes"><span>Yes</span></label>
                        <label><input type="radio" name="nfoExport" value="no" checked><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="createLibrary()">Create Library</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesSection()">Cancel</button>
        </div>`;
        onLibTypeChange();
    }

    let activeFolderIdx = null;

    function addFolderRow() {
        const list = document.getElementById('folderList');
        const idx = list.children.length;
        const row = document.createElement('div');
        row.className = 'folder-row';
        row.dataset.idx = idx;
        row.innerHTML = `<input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;">
            <button class="btn-secondary" onclick="openFolderBrowser(${idx})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            <button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>`;
        list.appendChild(row);
    }

    function removeFolderRow(btn) {
        const row = btn.closest('.folder-row');
        const list = document.getElementById('folderList');
        if (list.children.length <= 1) { toast('At least one folder is required', 'error'); return; }
        row.remove();
    }

    function openFolderBrowser(idx) {
        activeFolderIdx = idx;
        const inputs = document.querySelectorAll('.lib-folder-input');
        const currentPath = inputs[idx]?.value || '/media';
        openPathBrowser(currentPath);
    }

    function onLibTypeChange() {
        const type = document.getElementById('libType').value;
        const seasonOpt = document.getElementById('seasonGroupingOpt');
        const adultOpt = document.getElementById('adultContentOpt');
        if (seasonOpt) seasonOpt.style.display = (type === 'tv_shows') ? '' : 'none';
        if (adultOpt) adultOpt.style.display = (type === 'adult_movies') ? '' : 'none';
    }

    async function onAccessChange() {
        const val = document.getElementById('libAccess').value;
        const panel = document.getElementById('userSelectPanel');
        if (val === 'select_users') {
            panel.style.display = '';
            const data = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            if (data.success && data.data && data.data.length > 0) {
                list.innerHTML = data.data
                    .filter(u => u.role !== 'admin')
                    .map(u => `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}">
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            } else {
                list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No users found</p>';
            }
        } else {
            panel.style.display = 'none';
        }
    }

    async function openPathBrowser(path) {
        const browser = document.getElementById('pathBrowser');
        browser.style.display = 'block';
        await loadPathEntries(path || '/media');
    }

    async function loadPathEntries(path) {
        const browser = document.getElementById('pathBrowser');
        browser.innerHTML = '<div class="spinner" style="margin:10px auto;"></div>';
        const data = await api('GET', '/browse?path=' + encodeURIComponent(path));
        if (!data.success) { browser.innerHTML = '<p style="color:#ff5555;">Failed to browse</p>'; return; }
        const d = data.data;
        let html = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(0,217,255,0.1);">
            <span style="color:#00D9FF;font-size:0.8rem;font-weight:600;">&#128194; ${d.path}</span>
            <button class="btn-secondary" style="margin-left:auto;padding:4px 12px;font-size:0.75rem;" onclick="selectBrowsePath('${d.path}')">&#10003; Select This</button>
        </div>`;
        if (d.parent) {
            html += `<div onclick="loadPathEntries('${d.parent}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#8a9bae;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#11168; ..</div>`;
        }
        if (d.entries && d.entries.length > 0) {
            d.entries.forEach(e => {
                html += `<div onclick="loadPathEntries('${e.path}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#e5e5e5;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#128193; ${e.name}</div>`;
            });
        } else if (!d.parent) {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">No subdirectories</p>';
        } else {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">Empty folder</p>';
        }
        browser.innerHTML = html;
    }

    function selectBrowsePath(path) {
        if (activeFolderIdx !== null) {
            const inputs = document.querySelectorAll('.lib-folder-input');
            if (inputs[activeFolderIdx]) inputs[activeFolderIdx].value = path;
            activeFolderIdx = null;
        }
        document.getElementById('pathBrowser').style.display = 'none';
    }

    async function createLibrary() {
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const nfo_import = document.querySelector('input[name="nfoImport"]:checked')?.value === 'yes';
        const nfo_export = document.querySelector('input[name="nfoExport"]:checked')?.value === 'yes';

        const d = await api('POST', '/libraries', {
            name, media_type, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type,
            nfo_import, nfo_export
        });
        if (d.success) { toast('Library created!'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Metadata Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadMetadataSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Metadata</h2></div>
            <p class="section-desc">Configure metadata sources, cache server, and API keys.</p>
            <div class="settings-grid" id="metadataGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('metadataGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure metadata settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const cacheEnabled = sys.cache_server_enabled !== 'false';
        const cacheRegistered = sys.cache_server_api_key === 'registered';

        document.getElementById('metadataGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Metadata Cache Server</h3>
                <p style="color:#8a9bae;margin-bottom:16px;">Speed up metadata lookups by using the CineVault cache server. When enabled, cached results are used first; if the cache is unavailable, CineVault falls back to direct TMDB/OMDb API calls automatically.</p>
                <div class="form-group" style="display:flex;align-items:center;justify-content:space-between;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setCacheEnabled" ${cacheEnabled?'checked':''}><span class="toggle-slider"></span></span>
                        Enable Cache Server
                    </label>
                    <span style="font-size:0.8rem;color:${cacheRegistered?'#4caf50':'#5a6a7f'};">
                        <span class="status-dot ${cacheRegistered?'green':''}"></span>
                        ${cacheRegistered?'Registered':'Not yet registered'}
                    </span>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Metadata Enrichment</h3>
                <p style="color:#8a9bae;margin-bottom:16px;">Configure external API keys for additional metadata enrichment. An OMDb API key enables IMDB ratings, Rotten Tomatoes scores, and audience scores.</p>
                <div class="form-group">
                    <label>OMDb API Key</label>
                    <div style="display:flex;gap:10px;">
                        <input type="password" id="setOmdbKey" value="${sys.omdb_api_key||''}" placeholder="Enter your OMDb API key" style="flex:1;">
                        <button class="btn-secondary" onclick="document.getElementById('setOmdbKey').type=document.getElementById('setOmdbKey').type==='password'?'text':'password'">&#128065;</button>
                    </div>
                    <p style="color:#5a6a7f;font-size:0.78rem;margin-top:6px;">Get a free key at <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" style="color:#00D9FF;">omdbapi.com</a></p>
                </div>
            </div>
            <div style="grid-column:1/-1;text-align:right;">
                <button class="btn-primary" onclick="saveMetadataSettings()">Save Settings</button>
            </div>`;
    }

    async function saveMetadataSettings() {
        const settings = {};
        const omdbEl = document.getElementById('setOmdbKey');
        if (omdbEl) settings.omdb_api_key = omdbEl.value.trim();
        const cacheEnabledEl = document.getElementById('setCacheEnabled');
        if (cacheEnabledEl) settings.cache_server_enabled = cacheEnabledEl.checked ? 'true' : 'false';
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Metadata settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Duplicates Section ‚îÄ‚îÄ‚îÄ‚îÄ
    let dupSelectedItems = new Map(); // mediaId -> { groupIdx, partnerId }
    let dupGroupsData = [];
    let dupAllItemIds = []; // flat list of all item IDs for select-all

    async function loadDuplicatesSection() {
        dupSelectedItems = new Map();
        dupGroupsData = [];
        dupAllItemIds = [];

        const mc = document.getElementById('settingsContent');
        mc.innerHTML = '<div class="section-header"><h2 class="section-title">Duplicates</h2>' +
            '<button class="btn-secondary btn-small" onclick="clearStaleDuplicates(this)">Clear Resolved</button></div>' +
            '<p class="section-desc">Review media items flagged as potential duplicates via perceptual hash comparison.</p>' +
            '<div id="dupSelectBar" class="dup-select-bar">' +
                '<label class="dup-select-toggle"><input type="checkbox" id="dupSelectAll" onchange="dupToggleSelectAll(this.checked)"> Select All</label>' +
                '<span class="dup-select-count" id="dupSelectCount">0 selected</span>' +
            '</div>' +
            '<div id="dupList"><div class="spinner"></div></div>' +
            '<div class="dup-bulk-bar" id="dupBulkBar">' +
                '<span class="bulk-count" id="dupBulkCount">0 selected</span>' +
                '<div class="bulk-sep"></div>' +
                '<div class="bulk-actions">' +
                    '<button class="btn-secondary btn-small" onclick="dupBulkIgnore()">&#128683; Ignore Selected</button>' +
                    '<button class="btn-danger btn-small" onclick="dupBulkDelete()">&#128465; Delete Selected</button>' +
                    '<button class="btn-secondary btn-small" onclick="dupClearSelection()">Clear</button>' +
                '</div>' +
            '</div>';
        const data = await api('GET', '/duplicates');
        const div = document.getElementById('dupList');
        if (!data.success) { div.innerHTML = '<p style="color:#ff6b6b;">Failed to load duplicates</p>'; return; }
        const groups = data.data && data.data.groups ? data.data.groups : [];
        dupGroupsData = groups;
        if (groups.length === 0) {
            div.innerHTML = '<div style="padding:40px 0;text-align:center;">' +
                '<div style="font-size:3rem;margin-bottom:12px;">&#9989;</div>' +
                '<h3 style="color:#e5e5e5;margin-bottom:8px;">No duplicates found</h3>' +
                '<p style="color:#8a9bae;">Run pHash analysis from a library context menu to detect duplicates.</p></div>';
            document.getElementById('dupSelectBar').style.display = 'none';
            return;
        }
        // Build flat list of all item IDs for select-all
        groups.forEach((g, i) => {
            dupAllItemIds.push({ id: g.item.id, groupIdx: i, isSource: true });
            (g.matches || []).forEach(m => {
                dupAllItemIds.push({ id: m.item.id, groupIdx: i, isSource: false });
            });
        });
        div.innerHTML = groups.map((g, i) => renderDupGroup(g, i)).join('');
    }

    function fmtDupDur(sec) {
        if (!sec) return 'N/A';
        const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
        return h > 0 ? h + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0') : m + ':' + String(s).padStart(2,'0');
    }

    function fmtDupSize(bytes) {
        if (!bytes) return 'N/A';
        if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(2) + ' GB';
        if (bytes >= 1048576) return (bytes / 1048576).toFixed(0) + ' MB';
        return (bytes / 1024).toFixed(0) + ' KB';
    }

    function renderDupItemRow(item, similarity, groupIdx) {
        const dur = fmtDupDur(item.duration_seconds);
        const size = fmtDupSize(item.file_size);
        const res = item.resolution || (item.width && item.height ? item.width + 'x' + item.height : 'N/A');
        const codec = item.codec || 'N/A';
        const audio = item.audio_codec || 'N/A';
        const ext = item.file_name ? item.file_name.split('.').pop().toUpperCase() : 'N/A';
        const br = item.bitrate ? (item.bitrate / 1000).toFixed(0) + ' kbps' : 'N/A';
        const fp = item.file_path || item.file_name || '';
        const sp = fp.length > 80 ? '...' + fp.slice(-77) : fp;
        const posterUrl = item.poster_path ? item.poster_path + '?v=' + (item.updated_at ? new Date(item.updated_at).getTime() : Date.now()) : '';
        const poster = posterUrl
            ? '<img src="' + posterUrl + '">'
            : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1.5rem;color:#4a5568;">&#127910;</div>';
        const badge = similarity != null
            ? '<span class="dup-badge-match">' + Math.round(similarity * 100) + '% Similar</span>'
            : '<span class="dup-badge-source">Source</span>';

        return '<div class="dup-item-row" id="dupItem_' + item.id + '" data-media-id="' + item.id + '" data-group-idx="' + groupIdx + '">' +
            '<div class="dup-item-check">' +
                '<input type="checkbox" data-media-id="' + item.id + '" data-group-idx="' + groupIdx + '" onchange="dupToggleItem(\'' + item.id + '\', ' + groupIdx + ', this.checked)" onclick="event.stopPropagation()">' +
            '</div>' +
            '<div class="dup-item-poster">' + poster + '</div>' +
            '<div class="dup-item-details">' +
                '<div class="dup-item-title">' + (item.title || item.file_name) + (item.year ? ' <span style="color:#8a9bae;">(' + item.year + ')</span>' : '') + '</div>' +
                '<div class="dup-item-specs">' +
                    '<span title="Duration">&#128339; ' + dur + '</span>' +
                    '<span title="Resolution">&#128438; ' + res + '</span>' +
                    '<span title="Size">&#128190; ' + size + '</span>' +
                    '<span title="Video">&#127916; ' + codec + '</span>' +
                    '<span title="Audio">&#127911; ' + audio + '</span>' +
                    '<span title="Bitrate">&#9889; ' + br + '</span>' +
                    '<span title="Container">&#128230; ' + ext + '</span>' +
                '</div>' +
                '<div class="dup-item-path" title="' + fp + '">' + sp + '</div>' +
            '</div>' +
            '<div class="dup-item-label">' + badge + '</div>' +
        '</div>';
    }

    function renderDupGroup(g, idx) {
        const item = g.item;
        const matches = g.matches || [];
        const best = matches.length > 0 ? matches[0] : null;
        const pid = best ? best.item.id : '';
        const pt = best ? (best.item.title || '').replace(/'/g, "\\'") : '';
        const st = (item.title || '').replace(/'/g, "\\'");

        return '<div class="dup-group-card" id="dupGroup' + idx + '" data-idx="' + idx + '">' +
            '<div class="dup-group-items">' +
                renderDupItemRow(item, null, idx) +
                matches.map(m => renderDupItemRow(m.item, m.similarity, idx)).join('') +
            '</div>' +
            '<div class="dup-group-actions">' +
                '<button class="btn-secondary btn-small" onclick="settingsDupEdit(\'' + item.id + '\',\'' + pid + '\')">&#9998; Edit</button>' +
                '<button class="btn-secondary btn-small" onclick="settingsDupMerge(\'' + item.id + '\',\'' + pid + '\',\'' + st + '\',\'' + pt + '\')">&#128191; Merge as Edition</button>' +
                '<button class="btn-secondary btn-small" onclick="settingsDupIgnore(\'' + item.id + '\',\'' + pid + '\')">&#128683; Ignore</button>' +
            '</div>' +
        '</div>';
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Multi-Select Helpers (item-level) ‚îÄ‚îÄ‚îÄ‚îÄ
    function dupToggleItem(mediaId, groupIdx, checked) {
        const row = document.getElementById('dupItem_' + mediaId);
        if (checked) {
            dupSelectedItems.set(mediaId, { groupIdx });
            if (row) row.classList.add('selected');
        } else {
            dupSelectedItems.delete(mediaId);
            if (row) row.classList.remove('selected');
        }
        dupUpdateSelectionUI();
    }

    function dupToggleSelectAll(checked) {
        dupAllItemIds.forEach(entry => {
            const cb = document.querySelector('#dupItem_' + entry.id + ' .dup-item-check input');
            if (cb) cb.checked = checked;
            dupToggleItem(entry.id, entry.groupIdx, checked);
        });
    }

    function dupClearSelection() {
        dupSelectedItems.clear();
        document.querySelectorAll('.dup-item-row').forEach(row => row.classList.remove('selected'));
        document.querySelectorAll('.dup-item-check input').forEach(cb => cb.checked = false);
        const sa = document.getElementById('dupSelectAll');
        if (sa) sa.checked = false;
        dupUpdateSelectionUI();
    }

    function dupUpdateSelectionUI() {
        const count = dupSelectedItems.size;
        const countEl = document.getElementById('dupSelectCount');
        const bulkBar = document.getElementById('dupBulkBar');
        const bulkCount = document.getElementById('dupBulkCount');
        if (countEl) countEl.textContent = count + ' selected';
        if (bulkCount) bulkCount.textContent = count + ' selected';
        if (bulkBar) bulkBar.classList.toggle('visible', count > 0);
        // Update select-all checkbox state
        const sa = document.getElementById('dupSelectAll');
        if (sa) sa.checked = count > 0 && count === dupAllItemIds.length;
    }

    async function dupBulkIgnore() {
        if (dupSelectedItems.size === 0) return;
        const items = [];
        dupSelectedItems.forEach((v, mediaId) => items.push({ media_id: mediaId, partner_id: '' }));
        const d = await api('POST', '/duplicates/resolve-bulk', { items, action: 'ignored' });
        if (d.success) {
            toast('Ignored ' + (d.data.processed || 0) + ' items');
            loadDuplicatesSection();
        } else {
            toast(d.error || 'Failed', 'error');
        }
    }

    function dupBulkDelete() {
        if (dupSelectedItems.size === 0) return;
        const overlay = document.getElementById('dupDeleteOverlay');
        overlay.dataset.bulkMode = 'true';
        overlay.querySelector('h3').textContent = 'Delete ' + dupSelectedItems.size + ' Items';
        overlay.querySelector('p').textContent = 'How would you like to remove these ' + dupSelectedItems.size + ' selected items?';
        overlay.classList.add('active');
    }

    async function settingsDupIgnore(itemId, partnerId) {
        const d = await api('POST', '/duplicates/resolve', { media_id: itemId, partner_id: partnerId, action: 'ignored' });
        if (d.success) { toast('Marked as ignored'); loadDuplicatesSection(); } else toast(d.error, 'error');
    }

    function settingsDupDeleteOne(itemId) {
        const overlay = document.getElementById('dupDeleteOverlay');
        overlay.dataset.itemId = itemId;
        overlay.dataset.bulkMode = 'false';
        overlay.querySelector('h3').textContent = 'Delete Duplicate';
        overlay.querySelector('p').textContent = 'How would you like to remove this item?';
        overlay.classList.add('active');
    }

    function closeDupDeleteDialog() {
        const overlay = document.getElementById('dupDeleteOverlay');
        overlay.classList.remove('active');
        overlay.dataset.bulkMode = 'false';
    }

    async function confirmDupDelete(deleteFile) {
        const overlay = document.getElementById('dupDeleteOverlay');
        const bulkMode = overlay.dataset.bulkMode === 'true';
        closeDupDeleteDialog();

        if (bulkMode) {
            // Bulk delete selected items
            const items = [];
            dupSelectedItems.forEach((v, mediaId) => items.push({ media_id: mediaId, partner_id: '' }));
            const d = await api('POST', '/duplicates/resolve-bulk', { items, action: 'deleted', delete_file: deleteFile });
            if (d.success) {
                const msg = deleteFile ? 'Deleted ' + (d.data.processed || 0) + ' items from DB and disk' : 'Removed ' + (d.data.processed || 0) + ' items from DB';
                toast(msg);
                loadDuplicatesSection();
            } else {
                toast(d.error || 'Failed', 'error');
            }
        } else {
            // Single delete
            const itemId = overlay.dataset.itemId;
            const d = await api('POST', '/duplicates/resolve', { media_id: itemId, partner_id: '', action: 'deleted', delete_file: deleteFile });
            if (d.success) { toast(deleteFile ? 'Removed from DB and deleted from disk' : 'Removed from database'); loadDuplicatesSection(); }
            else toast(d.error, 'error');
        }
    }

    function settingsDupEdit(itemId, partnerId) {
        window.location.href = '/?edit=' + itemId + '&dupPartner=' + partnerId;
    }

    function settingsDupMerge(itemA, itemB, titleA, titleB) {
        window.location.href = '/?mergeA=' + itemA + '&mergeB=' + itemB;
    }

    async function clearStaleDuplicates(btn) {
        btn.disabled = true;
        btn.textContent = 'Clearing...';
        const d = await api('POST', '/duplicates/clear-stale');
        if (d.success) {
            toast('Cleared ' + (d.data.cleared || 0) + ' stale duplicate flags');
            loadDuplicatesSection();
        } else {
            toast(d.error || 'Failed', 'error');
            btn.disabled = false;
            btn.textContent = 'Clear Resolved';
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Analytics Section ‚îÄ‚îÄ‚îÄ‚îÄ
    let analyticsCharts = {};
    async function loadAnalyticsSection(tab) {
        const mc = document.getElementById('settingsContent');
        if (currentUser?.role !== 'admin') {
            mc.innerHTML = `<div class="section-header"><h2 class="section-title">Analytics</h2></div>
                <div class="settings-grid"><div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can view analytics.</p></div></div>`;
            return;
        }
        const activeTab = tab || 'overview';
        Object.values(analyticsCharts).forEach(c => { if(c && c.destroy) c.destroy(); });
        analyticsCharts = {};

        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Analytics</h2></div>
            <div class="analytics-tabs">
                <button class="analytics-tab ${activeTab==='overview'?'active':''}" onclick="loadAnalyticsSection('overview')">Overview</button>
                <button class="analytics-tab ${activeTab==='activity'?'active':''}" onclick="loadAnalyticsSection('activity')">Activity</button>
                <button class="analytics-tab ${activeTab==='streams'?'active':''}" onclick="loadAnalyticsSection('streams')">Streams</button>
                <button class="analytics-tab ${activeTab==='transcodes'?'active':''}" onclick="loadAnalyticsSection('transcodes')">Transcodes</button>
                <button class="analytics-tab ${activeTab==='system'?'active':''}" onclick="loadAnalyticsSection('system')">System</button>
                <button class="analytics-tab ${activeTab==='trends'?'active':''}" onclick="loadAnalyticsSection('trends')">Trends</button>
                <button class="analytics-tab ${activeTab==='health'?'active':''}" onclick="loadAnalyticsSection('health')">Library Health</button>
                <button class="analytics-tab ${activeTab==='alerts'?'active':''}" onclick="loadAnalyticsSection('alerts')">Alerts</button>
            </div>
            <div id="analyticsContent"><div class="spinner"></div></div>`;

        const ac = document.getElementById('analyticsContent');

        if (activeTab === 'overview') {
            const [ov, bd, sys] = await Promise.all([
                api('GET','/analytics/overview'),
                api('GET','/analytics/streams/breakdown?days=30'),
                api('GET','/analytics/system')
            ]);
            const o = ov.success ? ov.data : {};
            const b = bd.success ? bd.data : {};
            const sm = sys.success ? sys.data : {};
            ac.innerHTML = `<div class="analytics-grid">
                <div class="stat-card"><div class="stat-label">Active Streams</div><div class="stat-value">${o.active_streams||0}</div></div>
                <div class="stat-card"><div class="stat-label">Plays Today</div><div class="stat-value">${o.total_plays_today||0}</div></div>
                <div class="stat-card"><div class="stat-label">Plays This Week</div><div class="stat-value">${o.total_plays_week||0}</div></div>
                <div class="stat-card"><div class="stat-label">Unique Users Today</div><div class="stat-value">${o.unique_users_today||0}</div></div>
                <div class="stat-card"><div class="stat-label">Bandwidth Today</div><div class="stat-value">${formatBytes(o.bandwidth_today_bytes||0)}</div></div>
                <div class="stat-card"><div class="stat-label">Library Size</div><div class="stat-value">${(o.library_size||0).toLocaleString()}</div></div>
                <div class="stat-card"><div class="stat-label">Storage Used</div><div class="stat-value">${formatBytes(o.storage_used_bytes||0)}</div></div>
                <div class="stat-card"><div class="stat-label">Transcodes Today</div><div class="stat-value">${o.transcodes_today||0}</div></div>
                <div class="stat-card"><div class="stat-label">Direct Plays Today</div><div class="stat-value">${o.direct_plays_today||0}</div></div>
                <div class="stat-card"><div class="stat-label">Failures Today</div><div class="stat-value ${(o.failures_today||0)>0?'stat-danger':''}">${o.failures_today||0}</div></div>
                <div class="stat-card"><div class="stat-label">CPU</div><div class="stat-value">${(sm.cpu_percent||0).toFixed(1)}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.cpu_percent||0}%"></div></div></div>
                <div class="stat-card"><div class="stat-label">Memory</div><div class="stat-value">${(sm.memory_percent||0).toFixed(1)}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.memory_percent||0}%"></div></div></div>
            </div>
            <div class="analytics-grid" style="margin-top:24px;">
                <div class="settings-card" style="grid-column:1/-1;"><h3>Playback Type Breakdown (30 days)</h3>
                    <div class="chart-container"><canvas id="breakdownChart"></canvas></div>
                </div>
            </div>`;
            if (b.total > 0) {
                const ctx = document.getElementById('breakdownChart').getContext('2d');
                analyticsCharts.breakdown = new Chart(ctx, { type:'doughnut', data:{ labels:['Direct Play','Direct Stream','Transcode'], datasets:[{data:[b.direct_plays||0, b.direct_streams||0, b.transcodes||0], backgroundColor:['#00d9ff','#7c3aed','#f59e0b']}]}, options:{responsive:true,plugins:{legend:{labels:{color:'#8a9bae'}}}} });
            }
        } else if (activeTab === 'activity') {
            const data = await api('GET','/analytics/watch-activity?limit=100');
            const items = data.success ? (data.data||[]) : [];
            ac.innerHTML = `<div class="settings-card full-width"><h3>Who Watched What</h3>
                <table class="activity-table"><thead><tr><th>User</th><th>Title</th><th>Type</th><th>When</th><th>Duration</th><th>Completed</th></tr></thead>
                <tbody>${items.length?items.map(i=>`<tr><td>${i.username}</td><td>${i.media_title}</td><td><span class="tag tag-${i.playback_type==='transcode'?'orange':i.playback_type==='direct_stream'?'purple':'cyan'}">${i.playback_type.replace('_',' ')}</span></td><td>${new Date(i.watched_at).toLocaleString()}</td><td>${i.duration_minutes}m</td><td>${i.completed?'&#9989;':'&#9898;'}</td></tr>`).join(''):'<tr><td colspan="6" style="text-align:center;color:#5a6a7f;">No activity recorded yet</td></tr>'}</tbody></table></div>`;
        } else if (activeTab === 'streams') {
            const data = await api('GET','/analytics/streams');
            const active = data.success ? (data.data?.active||[]) : [];
            const recent = data.success ? (data.data?.recent||[]) : [];
            ac.innerHTML = `<div class="settings-card full-width"><h3>Active Streams (${active.length})</h3>
                ${active.length?active.map(s=>`<div class="job-item"><span class="status-dot green"></span><strong>${s.username}</strong> watching <strong>${s.media_title}</strong><span class="tag tag-${s.playback_type==='transcode'?'orange':'cyan'}">${(s.playback_type||'').replace('_',' ')}</span><span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">Started ${new Date(s.started_at).toLocaleTimeString()}</span></div>`).join(''):'<p style="color:#5a6a7f;">No active streams</p>'}</div>
                <div class="settings-card full-width" style="margin-top:16px;"><h3>Recent Sessions</h3>
                <table class="activity-table"><thead><tr><th>User</th><th>Title</th><th>Type</th><th>Quality</th><th>Started</th><th>Duration</th></tr></thead>
                <tbody>${recent.slice(0,30).map(s=>`<tr><td>${s.username}</td><td>${s.media_title}</td><td><span class="tag tag-${s.playback_type==='transcode'?'orange':'cyan'}">${(s.playback_type||'').replace('_',' ')}</span></td><td>${s.quality||s.resolution||'-'}</td><td>${new Date(s.started_at).toLocaleString()}</td><td>${s.duration_seconds?Math.round(s.duration_seconds/60)+'m':'-'}</td></tr>`).join('')}</tbody></table></div>`;
        } else if (activeTab === 'transcodes') {
            const data = await api('GET','/analytics/transcodes?days=30');
            const stats = data.success ? (data.data?.stats||{}) : {};
            const recent = data.success ? (data.data?.recent||[]) : [];
            ac.innerHTML = `<div class="analytics-grid">
                <div class="stat-card"><div class="stat-label">Total Transcodes</div><div class="stat-value">${stats.total_transcodes||0}</div></div>
                <div class="stat-card"><div class="stat-label">Success Rate</div><div class="stat-value">${(stats.success_rate||0).toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">HW Accel Usage</div><div class="stat-value">${(stats.hw_accel_percent||0).toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">Avg Duration</div><div class="stat-value">${Math.round(stats.avg_duration_seconds||0)}s</div></div>
            </div>
            <div class="settings-card full-width" style="margin-top:16px;">
                <h3>Codec Distribution</h3>
                <div class="chart-container"><canvas id="codecChart"></canvas></div>
            </div>
            <div class="settings-card full-width" style="margin-top:16px;"><h3>Recent Transcodes</h3>
                <table class="activity-table"><thead><tr><th>Title</th><th>Output</th><th>HW Accel</th><th>Duration</th><th>Status</th><th>When</th></tr></thead>
                <tbody>${recent.map(t=>`<tr><td>${t.media_title||'-'}</td><td>${t.output_resolution||'-'} ${t.output_codec||''}</td><td>${t.hw_accel||'software'}</td><td>${t.duration_seconds}s</td><td><span class="tag tag-${t.success?'green':'red'}">${t.success?'OK':'Failed'}</span></td><td>${new Date(t.started_at).toLocaleString()}</td></tr>`).join('')}</tbody></table></div>`;
            if (stats.codec_distribution && stats.codec_distribution.length) {
                const ctx = document.getElementById('codecChart').getContext('2d');
                analyticsCharts.codec = new Chart(ctx, { type:'bar', data:{ labels:stats.codec_distribution.map(c=>c.name), datasets:[{label:'Count',data:stats.codec_distribution.map(c=>c.count),backgroundColor:'#00d9ff'}]}, options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#8a9bae'}},y:{ticks:{color:'#8a9bae'}}}} });
            }
        } else if (activeTab === 'system') {
            const [cur, hist] = await Promise.all([
                api('GET','/analytics/system'),
                api('GET','/analytics/system/history?hours=24'),
                api('GET','/analytics/storage')
            ]);
            const sm = cur.success ? cur.data : {};
            const history = hist.success ? (hist.data||[]) : [];
            const stor = await api('GET','/analytics/storage');
            const storage = stor.success ? (stor.data||[]) : [];
            ac.innerHTML = `<div class="analytics-grid">
                <div class="stat-card"><div class="stat-label">CPU</div><div class="stat-value">${(sm.cpu_percent||0).toFixed(1)}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.cpu_percent||0}%"></div></div></div>
                <div class="stat-card"><div class="stat-label">Memory</div><div class="stat-value">${(sm.memory_percent||0).toFixed(1)}% (${sm.memory_used_mb||0} MB)</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.memory_percent||0}%"></div></div></div>
                <div class="stat-card"><div class="stat-label">GPU Encoder</div><div class="stat-value">${sm.gpu_encoder_percent!=null?(sm.gpu_encoder_percent).toFixed(1)+'%':'N/A'}</div>${sm.gpu_encoder_percent!=null?`<div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.gpu_encoder_percent}%"></div></div>`:''}</div>
                <div class="stat-card"><div class="stat-label">GPU Temp</div><div class="stat-value">${sm.gpu_temp_celsius!=null?sm.gpu_temp_celsius.toFixed(0)+'¬∞C':'N/A'}</div></div>
                <div class="stat-card"><div class="stat-label">Disk Total</div><div class="stat-value">${(sm.disk_total_gb||0).toFixed(1)} GB</div></div>
                <div class="stat-card"><div class="stat-label">Disk Free</div><div class="stat-value ${(sm.disk_free_gb||0)<50?'stat-danger':''}">${(sm.disk_free_gb||0).toFixed(1)} GB</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${sm.disk_total_gb?((sm.disk_used_gb||0)/sm.disk_total_gb*100):0}%"></div></div></div>
                <div class="stat-card"><div class="stat-label">Active Streams</div><div class="stat-value">${sm.active_streams||0}</div></div>
                <div class="stat-card"><div class="stat-label">Active Transcodes</div><div class="stat-value">${sm.active_transcodes||0}</div></div>
            </div>
            <div class="settings-card full-width" style="margin-top:16px;"><h3>CPU & Memory (24h)</h3><div class="chart-container"><canvas id="systemChart"></canvas></div></div>
            <div class="settings-card full-width" style="margin-top:16px;"><h3>Storage by Library</h3>
                ${storage.map(s=>`<div class="job-item"><strong>${s.library_name}</strong><span style="color:#8a9bae;margin-left:auto;">${s.file_count} files</span><span class="tag tag-cyan" style="margin-left:12px;">${formatBytes(s.total_bytes)}</span></div>`).join('')||'<p style="color:#5a6a7f;">No libraries</p>'}</div>`;
            if (history.length > 1) {
                const ctx = document.getElementById('systemChart').getContext('2d');
                analyticsCharts.system = new Chart(ctx, { type:'line', data:{ labels:history.map(h=>new Date(h.recorded_at).toLocaleTimeString()), datasets:[{label:'CPU %',data:history.map(h=>h.cpu_percent),borderColor:'#00d9ff',tension:0.3,fill:false},{label:'Memory %',data:history.map(h=>h.memory_percent),borderColor:'#7c3aed',tension:0.3,fill:false}]}, options:{responsive:true,plugins:{legend:{labels:{color:'#8a9bae'}}},scales:{x:{ticks:{color:'#5a6a7f',maxTicksLimit:12}},y:{min:0,max:100,ticks:{color:'#5a6a7f'}}}} });
            }
        } else if (activeTab === 'trends') {
            const data = await api('GET','/analytics/trends');
            const trends = data.success ? (data.data||[]) : [];
            ac.innerHTML = `<div class="settings-card full-width">
                <h3>Daily Activity (30 days)</h3>
                <div class="chart-container"><canvas id="trendsChart"></canvas></div>
            </div>
            <div class="analytics-grid" style="margin-top:16px;">
                <div class="settings-card full-width"><h3>Daily Breakdown</h3>
                    <div style="max-height:400px;overflow-y:auto;">
                    <table class="activity-table">
                        <thead><tr><th>Date</th><th>Plays</th><th>Users</th><th>Watch Time</th><th>Bandwidth</th><th>Transcodes</th><th>Direct</th><th>Failures</th><th>New Media</th></tr></thead>
                        <tbody>${trends.length ? trends.slice().reverse().map(d=>{
                            const mins = Math.round((d.total_watch_minutes||0));
                            const hrs = mins >= 60 ? Math.floor(mins/60)+'h '+mins%60+'m' : mins+'m';
                            return `<tr>
                                <td>${d.date}</td>
                                <td>${d.total_plays||0}</td>
                                <td>${d.unique_users||0}</td>
                                <td>${hrs}</td>
                                <td>${formatBytes(d.total_bytes_served||0)}</td>
                                <td>${d.transcodes||0}</td>
                                <td>${d.direct_plays||0}</td>
                                <td class="${(d.transcode_failures||0)>0?'stat-danger':''}">${d.transcode_failures||0}</td>
                                <td>${d.new_media_added||0}</td>
                            </tr>`;
                        }).join('') : '<tr><td colspan="9" style="text-align:center;color:#5a6a7f;">No trend data yet. Stats roll up nightly.</td></tr>'}</tbody>
                    </table></div>
                </div>
            </div>`;
            if (trends.length > 1) {
                const ctx = document.getElementById('trendsChart').getContext('2d');
                analyticsCharts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trends.map(d => d.date),
                        datasets: [
                            { label: 'Plays', data: trends.map(d => d.total_plays||0), borderColor: '#00d9ff', backgroundColor: 'rgba(0,217,255,0.1)', tension: 0.3, fill: true },
                            { label: 'Unique Users', data: trends.map(d => d.unique_users||0), borderColor: '#7c3aed', tension: 0.3, fill: false },
                            { label: 'Transcodes', data: trends.map(d => d.transcodes||0), borderColor: '#f59e0b', tension: 0.3, fill: false },
                            { label: 'Failures', data: trends.map(d => d.transcode_failures||0), borderColor: '#ff6b6b', tension: 0.3, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: '#8a9bae' } } },
                        scales: {
                            x: { ticks: { color: '#5a6a7f', maxTicksLimit: 15 } },
                            y: { beginAtZero: true, ticks: { color: '#5a6a7f' } }
                        }
                    }
                });
            }
        } else if (activeTab === 'health') {
            const data = await api('GET','/analytics/library-health');
            const libs = data.success ? (data.data||[]) : [];
            ac.innerHTML = libs.map(lib => `<div class="settings-card full-width" style="margin-bottom:16px;">
                <h3>${lib.library_name}</h3>
                <div class="analytics-grid" style="margin-top:12px;">
                    <div class="stat-card"><div class="stat-label">Total Items</div><div class="stat-value">${lib.total_items}</div></div>
                    <div class="stat-card"><div class="stat-label">Metadata Complete</div><div class="stat-value">${lib.metadata_percent.toFixed(1)}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${lib.metadata_percent}%"></div></div></div>
                    <div class="stat-card"><div class="stat-label">Missing Poster</div><div class="stat-value ${lib.missing_poster>0?'stat-danger':''}">${lib.missing_poster}</div></div>
                    <div class="stat-card"><div class="stat-label">HDR Content</div><div class="stat-value">${lib.hdr_count}</div></div>
                    <div class="stat-card"><div class="stat-label">Atmos Audio</div><div class="stat-value">${lib.atmos_count}</div></div>
                </div>
                <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap;">
                    <div style="flex:1;min-width:200px;"><h4 style="color:#8a9bae;margin-bottom:8px;">Codec Distribution</h4>
                        ${(lib.codec_distribution||[]).map(c=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span>${c.name}</span><span class="tag tag-cyan">${c.count}</span></div>`).join('')||'<span style="color:#5a6a7f;">No data</span>'}</div>
                    <div style="flex:1;min-width:200px;"><h4 style="color:#8a9bae;margin-bottom:8px;">Resolution Distribution</h4>
                        ${(lib.resolution_distribution||[]).map(r=>`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05);"><span>${r.name}</span><span class="tag tag-green">${r.count}</span></div>`).join('')||'<span style="color:#5a6a7f;">No data</span>'}</div>
                </div>
            </div>`).join('') || '<div class="empty-state"><div class="empty-state-title">No libraries</div></div>';
        } else if (activeTab === 'alerts') {
            const [chRes, arRes, logRes] = await Promise.all([
                api('GET','/notifications/channels'),
                api('GET','/notifications/alerts'),
                api('GET','/notifications/log')
            ]);
            const channels = chRes.success ? (chRes.data||[]) : [];
            const rules = arRes.success ? (arRes.data||[]) : [];
            const logs = logRes.success ? (logRes.data||[]) : [];
            ac.innerHTML = `<div class="settings-card full-width"><h3>Notification Channels</h3>
                <div id="channelList">${channels.length?channels.map(ch=>`<div class="job-item"><span class="status-dot ${ch.is_enabled?'green':'red'}"></span><strong>${ch.name}</strong><span class="tag tag-cyan">${ch.channel_type}</span><span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${ch.webhook_url.substring(0,40)}...</span><button class="btn-secondary btn-small" style="margin-left:12px;" onclick="testNotifChannel('${ch.id}')">Test</button><button class="btn-danger btn-small" style="margin-left:6px;" onclick="deleteNotifChannel('${ch.id}')">Delete</button></div>`).join(''):'<p style="color:#5a6a7f;">No channels configured</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
                    <input type="text" id="chName" placeholder="Channel name" style="flex:1;min-width:120px;">
                    <select id="chType"><option value="discord">Discord</option><option value="slack">Slack</option><option value="generic">Generic</option></select>
                    <input type="text" id="chUrl" placeholder="Webhook URL" style="flex:2;min-width:200px;">
                    <button class="btn-primary" onclick="createNotifChannel()">Add Channel</button>
                </div>
            </div>
            <div class="settings-card full-width" style="margin-top:16px;"><h3>Alert Rules</h3>
                <div id="ruleList">${rules.length?rules.map(r=>`<div class="job-item"><span class="status-dot ${r.is_enabled?'green':'red'}"></span><strong>${r.name}</strong><span class="tag tag-orange">${r.condition_type.replace(/_/g,' ')}</span><span style="color:#8a9bae;">Threshold: ${r.threshold}</span><span style="color:#5a6a7f;margin-left:auto;">${r.channel_name}</span><button class="btn-danger btn-small" style="margin-left:12px;" onclick="deleteAlertRule('${r.id}')">Delete</button></div>`).join(''):'<p style="color:#5a6a7f;">No alert rules configured</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:end;">
                    <input type="text" id="ruleName" placeholder="Rule name" style="flex:1;min-width:120px;">
                    <select id="ruleCondition"><option value="disk_space_low">Disk Space Low (GB)</option><option value="transcode_failure">Transcode Failures (/hr)</option><option value="stream_error">Stream Errors (/hr)</option><option value="gpu_temp_high">GPU Temp High (¬∞C)</option></select>
                    <input type="number" id="ruleThreshold" placeholder="Threshold" style="width:100px;">
                    <select id="ruleChannel">${channels.map(ch=>`<option value="${ch.id}">${ch.name}</option>`).join('')}</select>
                    <button class="btn-primary" onclick="createAlertRule()">Add Rule</button>
                </div>
            </div>
            <div class="settings-card full-width" style="margin-top:16px;"><h3>Alert Log</h3>
                <table class="activity-table"><thead><tr><th>Rule</th><th>Channel</th><th>Message</th><th>Status</th><th>Sent</th></tr></thead>
                <tbody>${logs.length?logs.map(l=>`<tr><td>${l.rule_name||'-'}</td><td>${l.channel_name||'-'}</td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;">${l.message}</td><td><span class="tag tag-${l.success?'green':'red'}">${l.success?'Sent':'Failed'}</span></td><td>${new Date(l.sent_at).toLocaleString()}</td></tr>`).join(''):'<tr><td colspan="5" style="text-align:center;color:#5a6a7f;">No alerts sent yet</td></tr>'}</tbody></table></div>`;
        }
    }

    function formatBytes(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B','KB','MB','GB','TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    async function createNotifChannel() {
        const name = document.getElementById('chName').value;
        const type = document.getElementById('chType').value;
        const url = document.getElementById('chUrl').value;
        if (!name || !url) { toast('Name and URL required', 'error'); return; }
        const d = await api('POST','/notifications/channels', { name, channel_type: type, webhook_url: url, is_enabled: true });
        if (d.success) { toast('Channel created!'); loadAnalyticsSection('alerts'); } else toast(d.error,'error');
    }
    async function deleteNotifChannel(id) {
        if (!confirm('Delete this channel?')) return;
        const d = await api('DELETE','/notifications/channels/' + id);
        if (d.success) { toast('Channel deleted'); loadAnalyticsSection('alerts'); } else toast(d.error,'error');
    }
    async function testNotifChannel(id) {
        toast('Sending test...');
        const d = await api('POST','/notifications/channels/' + id + '/test');
        if (d.success) toast('Test sent!'); else toast('Test failed: ' + (d.error||''), 'error');
    }
    async function createAlertRule() {
        const name = document.getElementById('ruleName').value;
        const condition_type = document.getElementById('ruleCondition').value;
        const threshold = parseFloat(document.getElementById('ruleThreshold').value);
        const channel_id = document.getElementById('ruleChannel').value;
        if (!name || !threshold || !channel_id) { toast('All fields required', 'error'); return; }
        const d = await api('POST','/notifications/alerts', { name, condition_type, threshold, channel_id, is_enabled: true, cooldown_minutes: 60 });
        if (d.success) { toast('Rule created!'); loadAnalyticsSection('alerts'); } else toast(d.error,'error');
    }
    async function deleteAlertRule(id) {
        if (!confirm('Delete this alert rule?')) return;
        const d = await api('DELETE','/notifications/alerts/' + id);
        if (d.success) { toast('Rule deleted'); loadAnalyticsSection('alerts'); } else toast(d.error,'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Admin Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadAdminSection() {
        const mc = document.getElementById('settingsContent');
        if (currentUser?.role !== 'admin') {
            mc.innerHTML = `<div class="section-header"><h2 class="section-title">Admin Panel</h2></div>
                <div class="settings-grid"><div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can access the admin panel.</p></div></div>`;
            return;
        }
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Admin Panel</h2></div>
            <div class="settings-grid">
                <div class="settings-card"><h3>System Status</h3><div id="sysStatus"><div class="spinner"></div></div></div>
                <div class="settings-card"><h3>Users</h3><div id="userList"><div class="spinner"></div></div></div>
                <div class="settings-card" style="grid-column:1/-1;"><h3>Job Queue</h3><div id="jobList"><div class="spinner"></div></div></div>
            </div>`;

        const status = await api('GET','/status');
        document.getElementById('sysStatus').innerHTML = status.success
            ? `<p><span class="status-dot green"></span>Server Online</p><p style="color:#8a9bae;margin-top:8px;">Version: ${status.data?.version||'?'}</p><p style="color:#8a9bae;">WebSocket clients: ${status.data?.ws_clients||0}</p>`
            : '<p><span class="status-dot red"></span>Error</p>';

        const users = await api('GET','/users');
        const ul = document.getElementById('userList');
        if (users.success && users.data) {
            ul.innerHTML = users.data.map(u =>
                `<div class="job-item"><span class="status-dot ${u.is_active?'green':'red'}"></span><strong>${u.username}</strong><span class="tag tag-cyan">${u.role}</span><span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${u.email}</span></div>`
            ).join('');
        }

        const jobs = await api('GET','/jobs');
        const jl = document.getElementById('jobList');
        if (jobs.success && jobs.data && jobs.data.length > 0) {
            jl.innerHTML = jobs.data.map(j => {
                const statusColor = j.status==='completed'?'green':j.status==='failed'?'red':j.status==='running'?'yellow':'';
                return `<div class="job-item"><span class="status-dot ${statusColor}"></span><strong>${j.job_type}</strong><span class="tag tag-${j.status==='completed'?'green':j.status==='failed'?'red':'cyan'}">${j.status}</span><div class="job-progress-bar"><div class="job-progress-fill" style="width:${j.progress}%"></div></div><span style="color:#5a6a7f;font-size:0.78rem;">${new Date(j.started_at).toLocaleString()}</span></div>`;
            }).join('');
        } else {
            jl.innerHTML = '<p style="color:#5a6a7f;">No recent jobs</p>';
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Cinema Mode Section (A2) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCinemaSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Cinema Mode</h2></div>
            <p class="section-desc">Configure pre-roll videos and trailer settings for the Cinema Mode experience.</p>
            <div class="settings-grid" id="cinemaGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('cinemaGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can configure cinema mode.</p></div>`;
            return;
        }

        const [sysSett, prRes] = await Promise.all([api('GET', '/settings/system'), api('GET', '/cinema/pre-rolls')]);
        const sys = sysSett.success ? sysSett.data : {};
        const prerolls = prRes.success ? (prRes.data || []) : [];
        const trailerCount = sys.cinema_trailer_count || '0';
        const randomize = sys.cinema_randomize === 'true';

        document.getElementById('cinemaGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Trailer Settings</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Configure how many trailers play before the feature and whether they are randomized.</p>
                <div class="form-group"><label>Trailer Count (before feature)</label>
                    <select id="setCinemaTrailers">
                        ${[0,1,2,3,4,5].map(n => `<option value="${n}" ${trailerCount==n?'selected':''}>${n === 0 ? 'None' : n}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setCinemaRandomize" ${randomize?'checked':''}><span class="toggle-slider"></span></span>
                        Randomize Trailers
                    </label>
                </div>
                <div style="text-align:right;margin-top:16px;">
                    <button class="btn-primary" onclick="saveCinemaSettings()">Save Settings</button>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Pre-Roll Videos</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Add custom bumpers or intros that play before the feature in Cinema Mode.</p>
                <div id="prerollList">${prerolls.length ? prerolls.map(pr => `
                    <div class="job-item">
                        <strong>${pr.name || pr.url || 'Pre-roll'}</strong>
                        <span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${pr.url ? pr.url.substring(0,50) : ''}</span>
                        <button class="btn-danger btn-small" style="margin-left:12px;" onclick="deletePreRoll('${pr.id}')">Delete</button>
                    </div>`).join('') : '<p style="color:#5a6a7f;">No pre-roll videos configured</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
                    <input type="text" id="prName" placeholder="Name (e.g. Studio Bumper)" style="flex:1;min-width:120px;">
                    <input type="text" id="prUrl" placeholder="URL or file path" style="flex:2;min-width:200px;">
                    <button class="btn-primary" onclick="createPreRoll()">Add Pre-Roll</button>
                </div>
            </div>`;
    }

    async function saveCinemaSettings() {
        const d = await api('PUT', '/settings/system', {
            cinema_trailer_count: document.getElementById('setCinemaTrailers').value,
            cinema_randomize: document.getElementById('setCinemaRandomize').checked ? 'true' : 'false'
        });
        if (d.success) toast('Cinema settings saved!'); else toast(d.error, 'error');
    }

    async function createPreRoll() {
        const name = document.getElementById('prName').value;
        const url = document.getElementById('prUrl').value;
        if (!url) { toast('URL is required', 'error'); return; }
        const d = await api('POST', '/cinema/pre-rolls', { name, url });
        if (d.success) { toast('Pre-roll added!'); loadCinemaSection(); } else toast(d.error, 'error');
    }

    async function deletePreRoll(id) {
        if (!confirm('Delete this pre-roll video?')) return;
        const d = await api('DELETE', '/cinema/pre-rolls/' + id);
        if (d.success) { toast('Pre-roll deleted'); loadCinemaSection(); } else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ DLNA Section (A1) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDLNASection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">DLNA / UPnP</h2></div>
            <p class="section-desc">Configure the built-in DLNA media server for network device streaming.</p>
            <div class="settings-grid" id="dlnaGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('dlnaGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can configure DLNA settings.</p></div>`;
            return;
        }

        const [cfgRes, libRes] = await Promise.all([api('GET', '/dlna/config'), api('GET', '/libraries')]);
        const cfg = cfgRes.success ? (cfgRes.data || {}) : {};
        const libs = libRes.success ? (libRes.data || []) : [];
        const enabledLibs = cfg.enabled_libraries || [];

        document.getElementById('dlnaGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>DLNA Server</h3>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="dlnaEnabled" ${cfg.enabled?'checked':''}><span class="toggle-slider"></span></span>
                        Enable DLNA Server
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:16px;">When enabled, CineVault acts as a DLNA media server visible to smart TVs, game consoles, and other UPnP devices on your network.</p>
                <div class="form-group"><label>Friendly Name</label>
                    <input type="text" id="dlnaFriendlyName" value="${cfg.friendly_name || 'CineVault'}" placeholder="CineVault">
                    <p class="settings-helper">The name that appears on other devices when they discover this server.</p>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Exposed Libraries</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Select which libraries are visible to DLNA clients. If none are selected, all libraries are exposed.</p>
                <div id="dlnaLibList">${libs.map(lib => `
                    <label style="display:flex;align-items:center;gap:8px;padding:8px 0;cursor:pointer;color:#e5e5e5;border-bottom:1px solid rgba(255,255,255,0.05);">
                        <input type="checkbox" class="dlna-lib-cb" value="${lib.id}" ${enabledLibs.includes(lib.id)?'checked':''}>
                        <span>${lib.name}</span>
                        <span class="tag tag-cyan" style="margin-left:auto;">${MEDIA_LABELS[lib.media_type]||lib.media_type}</span>
                    </label>`).join('') || '<p style="color:#5a6a7f;">No libraries found</p>'}</div>
            </div>
            <div style="grid-column:1/-1;text-align:right;">
                <button class="btn-primary" onclick="saveDLNAConfig()">Save DLNA Settings</button>
            </div>`;
    }

    async function saveDLNAConfig() {
        const enabled = document.getElementById('dlnaEnabled').checked;
        const friendly_name = document.getElementById('dlnaFriendlyName').value.trim() || 'CineVault';
        const enabled_libraries = [...document.querySelectorAll('.dlna-lib-cb:checked')].map(cb => cb.value);
        const d = await api('PUT', '/dlna/config', { enabled, friendly_name, enabled_libraries });
        if (d.success) toast('DLNA settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Live TV / Tuners Section (A3) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLiveTVSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Live TV / Tuners</h2></div>
            <p class="section-desc">Manage tuner devices for live TV and DVR recording.</p>
            <div class="settings-grid" id="livetvGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('livetvGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can manage tuner devices.</p></div>`;
            return;
        }

        const res = await api('GET', '/livetv/tuners');
        const tuners = res.success ? (res.data || []) : [];

        document.getElementById('livetvGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Tuner Devices</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Add HDHomeRun or other tuner devices to enable live TV and DVR recording.</p>
                <div id="tunerList">${tuners.length ? tuners.map(t => `
                    <div class="job-item">
                        <span class="status-dot ${t.is_active !== false ? 'green' : 'red'}"></span>
                        <strong>${t.name || t.device_type}</strong>
                        <span class="tag tag-cyan">${t.device_type || 'HDHomeRun'}</span>
                        <span style="color:#8a9bae;margin-left:8px;">${t.ip_address || ''}</span>
                        <span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${t.channels_available || 0} channels</span>
                        <button class="btn-danger btn-small" style="margin-left:12px;" onclick="deleteTuner('${t.id}')">Delete</button>
                    </div>`).join('') : '<p style="color:#5a6a7f;">No tuner devices configured</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;align-items:end;">
                    <div class="form-group" style="flex:1;min-width:120px;margin-bottom:0;">
                        <label>Device Name</label>
                        <input type="text" id="tunerName" placeholder="Living Room Tuner">
                    </div>
                    <div class="form-group" style="flex:1;min-width:120px;margin-bottom:0;">
                        <label>Device Type</label>
                        <select id="tunerType">
                            <option value="hdhomerun">HDHomeRun</option>
                            <option value="iptv">IPTV</option>
                            <option value="satip">SAT>IP</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;min-width:160px;margin-bottom:0;">
                        <label>IP Address / URL</label>
                        <input type="text" id="tunerIP" placeholder="192.168.1.100">
                    </div>
                    <button class="btn-primary" onclick="createTuner()">Add Tuner</button>
                </div>
            </div>`;
    }

    async function createTuner() {
        const name = document.getElementById('tunerName').value;
        const device_type = document.getElementById('tunerType').value;
        const ip_address = document.getElementById('tunerIP').value;
        if (!ip_address) { toast('IP address is required', 'error'); return; }
        const d = await api('POST', '/livetv/tuners', { name, device_type, ip_address });
        if (d.success) { toast('Tuner added!'); loadLiveTVSection(); } else toast(d.error, 'error');
    }

    async function deleteTuner(id) {
        if (!confirm('Remove this tuner device?')) return;
        const d = await api('DELETE', '/livetv/tuners/' + id);
        if (d.success) { toast('Tuner removed'); loadLiveTVSection(); } else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Webhooks Section (A4) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadWebhooksSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Webhook Secrets</h2></div>
            <p class="section-desc">Manage webhook signing secrets for secure third-party integrations.</p>
            <div class="settings-grid" id="webhooksGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('webhooksGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can manage webhook secrets.</p></div>`;
            return;
        }

        const res = await api('GET', '/admin/webhooks');
        const secrets = res.success ? (res.data || []) : [];

        document.getElementById('webhooksGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Signing Secrets</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Webhook secrets are used to sign outgoing payloads so receivers can verify authenticity.</p>
                <div id="webhookList">${secrets.length ? secrets.map(s => `
                    <div class="job-item">
                        <strong>${s.name}</strong>
                        <span style="color:#5a6a7f;margin-left:12px;font-family:monospace;font-size:0.78rem;">${s.key_prefix || s.key?.substring(0,8) || '****'}...</span>
                        <span style="color:#5a6a7f;margin-left:auto;font-size:0.78rem;">${s.created_at ? new Date(s.created_at).toLocaleDateString() : ''}</span>
                        <button class="btn-danger btn-small" style="margin-left:12px;" onclick="deleteWebhookSecret('${s.id}')">Revoke</button>
                    </div>`).join('') : '<p style="color:#5a6a7f;">No webhook secrets configured</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;">
                    <input type="text" id="whSecretName" placeholder="Secret name (e.g. Plex Webhook)" style="flex:1;">
                    <button class="btn-primary" onclick="createWebhookSecret()">Generate Secret</button>
                </div>
            </div>`;
    }

    async function createWebhookSecret() {
        const name = document.getElementById('whSecretName').value;
        if (!name) { toast('Name is required', 'error'); return; }
        const d = await api('POST', '/admin/webhooks', { name });
        if (d.success) {
            if (d.data && d.data.key) {
                const copied = await navigator.clipboard.writeText(d.data.key).then(() => true).catch(() => false);
                toast(copied ? 'Secret created and copied to clipboard!' : 'Secret created: ' + d.data.key);
            } else { toast('Secret created!'); }
            loadWebhooksSection();
        } else toast(d.error, 'error');
    }

    async function deleteWebhookSecret(id) {
        if (!confirm('Revoke this webhook secret? Integrations using it will stop working.')) return;
        const d = await api('DELETE', '/admin/webhooks/' + id);
        if (d.success) { toast('Secret revoked'); loadWebhooksSection(); } else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ API Keys Section (A5) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadAPIKeysSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">API Keys</h2></div>
            <p class="section-desc">Generate and manage API keys for external applications and automation.</p>
            <div class="settings-grid" id="apikeysGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('apikeysGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can manage API keys.</p></div>`;
            return;
        }

        const res = await api('GET', '/settings/api-keys');
        const keys = res.success ? (res.data || []) : [];

        document.getElementById('apikeysGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Active API Keys</h3>
                <p class="settings-helper" style="margin-bottom:16px;">API keys provide programmatic access to CineVault. Treat them like passwords.</p>
                <div id="apikeyList">${keys.length ? `
                    <table class="activity-table">
                        <thead><tr><th>Name</th><th>Key Prefix</th><th>Created</th><th>Last Used</th><th></th></tr></thead>
                        <tbody>${keys.map(k => `<tr>
                            <td><strong>${k.name}</strong></td>
                            <td><code style="color:#00D9FF;">${k.key_prefix || k.key?.substring(0,12) || '****'}...</code></td>
                            <td>${k.created_at ? new Date(k.created_at).toLocaleDateString() : '-'}</td>
                            <td>${k.last_used_at ? new Date(k.last_used_at).toLocaleDateString() : 'Never'}</td>
                            <td><button class="btn-danger btn-small" onclick="deleteAPIKey('${k.id}')">Revoke</button></td>
                        </tr>`).join('')}</tbody>
                    </table>` : '<p style="color:#5a6a7f;">No API keys generated</p>'}</div>
                <div style="margin-top:16px;display:flex;gap:12px;">
                    <input type="text" id="apikeyName" placeholder="Key name (e.g. Home Assistant)" style="flex:1;">
                    <button class="btn-primary" onclick="createAPIKey()">Generate Key</button>
                </div>
            </div>`;
    }

    async function createAPIKey() {
        const name = document.getElementById('apikeyName').value;
        if (!name) { toast('Name is required', 'error'); return; }
        const d = await api('POST', '/settings/api-keys', { name });
        if (d.success) {
            if (d.data && d.data.key) {
                const copied = await navigator.clipboard.writeText(d.data.key).then(() => true).catch(() => false);
                toast(copied ? 'API key created and copied to clipboard!' : 'API key: ' + d.data.key);
            } else { toast('API key created!'); }
            loadAPIKeysSection();
        } else toast(d.error, 'error');
    }

    async function deleteAPIKey(id) {
        if (!confirm('Revoke this API key? Applications using it will lose access.')) return;
        const d = await api('DELETE', '/settings/api-keys/' + id);
        if (d.success) { toast('API key revoked'); loadAPIKeysSection(); } else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Backup Section (A6) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadBackupSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Backup &amp; Restore</h2></div>
            <p class="section-desc">Create and manage database backups for your CineVault instance.</p>
            <div class="settings-grid" id="backupGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('backupGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can manage backups.</p></div>`;
            return;
        }

        const res = await api('GET', '/admin/backups');
        const backups = res.success ? (res.data || []) : [];

        document.getElementById('backupGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Create Backup</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Create a full backup of your CineVault database including settings, users, metadata, and watch history.</p>
                <button class="btn-primary" id="createBackupBtn" onclick="createBackup()">Create Backup Now</button>
            </div>
            <div class="settings-card full-width">
                <h3>Available Backups</h3>
                <div id="backupList">${backups.length ? `
                    <table class="activity-table">
                        <thead><tr><th>Date</th><th>Size</th><th>Status</th><th></th></tr></thead>
                        <tbody>${backups.map(b => `<tr>
                            <td>${new Date(b.created_at).toLocaleString()}</td>
                            <td>${b.size_bytes ? formatBytes(b.size_bytes) : '-'}</td>
                            <td><span class="tag tag-${b.status === 'completed' ? 'green' : b.status === 'failed' ? 'red' : 'cyan'}">${b.status || 'completed'}</span></td>
                            <td><a href="${API}/admin/backups/${b.id}/download" class="btn-secondary btn-small" style="text-decoration:none;">Download</a></td>
                        </tr>`).join('')}</tbody>
                    </table>` : '<p style="color:#5a6a7f;">No backups available</p>'}</div>
            </div>`;
    }

    async function createBackup() {
        const btn = document.getElementById('createBackupBtn');
        btn.disabled = true; btn.textContent = 'Creating...';
        const d = await api('POST', '/admin/backup');
        if (d.success) { toast('Backup created!'); loadBackupSection(); }
        else { toast(d.error || 'Backup failed', 'error'); btn.disabled = false; btn.textContent = 'Create Backup Now'; }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Import Section (A7) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadImportSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Import</h2></div>
            <p class="section-desc">Import libraries and metadata from Plex or Jellyfin.</p>
            <div class="settings-grid" id="importGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('importGrid').innerHTML = `<div class="settings-card"><h3>Access Restricted</h3><p style="color:#8a9bae;">Only administrators can import data.</p></div>`;
            return;
        }

        const histRes = await api('GET', '/admin/imports');
        const imports = histRes.success ? (histRes.data || []) : [];

        document.getElementById('importGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Import from External Server</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Import your libraries, watch history, and metadata from Plex or Jellyfin.</p>
                <div class="form-group"><label>Source</label>
                    <select id="importSource">
                        <option value="plex">Plex</option>
                        <option value="jellyfin">Jellyfin</option>
                    </select>
                </div>
                <div class="form-group"><label>Server URL</label>
                    <input type="text" id="importUrl" placeholder="http://192.168.1.100:32400">
                    <p class="settings-helper">Include the port number (Plex: 32400, Jellyfin: 8096).</p>
                </div>
                <div class="form-group"><label>API Token</label>
                    <div style="display:flex;gap:10px;">
                        <input type="password" id="importToken" placeholder="Enter API token" style="flex:1;">
                        <button class="btn-secondary" onclick="document.getElementById('importToken').type=document.getElementById('importToken').type==='password'?'text':'password'">&#128065;</button>
                    </div>
                </div>
                <button class="btn-primary" id="startImportBtn" onclick="startImport()">Start Import</button>
            </div>
            <div class="settings-card full-width">
                <h3>Import History</h3>
                <div id="importHistory">${imports.length ? `
                    <table class="activity-table">
                        <thead><tr><th>Source</th><th>Server</th><th>Status</th><th>Items</th><th>Date</th></tr></thead>
                        <tbody>${imports.map(i => `<tr>
                            <td><span class="tag tag-cyan">${i.source}</span></td>
                            <td>${i.server_url || '-'}</td>
                            <td><span class="tag tag-${i.status === 'completed' ? 'green' : i.status === 'failed' ? 'red' : 'orange'}">${i.status}</span></td>
                            <td>${i.items_imported || 0}</td>
                            <td>${i.created_at ? new Date(i.created_at).toLocaleString() : '-'}</td>
                        </tr>`).join('')}</tbody>
                    </table>` : '<p style="color:#5a6a7f;">No imports yet</p>'}</div>
            </div>`;
    }

    async function startImport() {
        const source = document.getElementById('importSource').value;
        const server_url = document.getElementById('importUrl').value;
        const api_token = document.getElementById('importToken').value;
        if (!server_url || !api_token) { toast('Server URL and API token are required', 'error'); return; }
        const btn = document.getElementById('startImportBtn');
        btn.disabled = true; btn.textContent = 'Importing...';
        const d = await api('POST', '/admin/import', { source, server_url, api_token });
        if (d.success) { toast('Import started!'); loadImportSection(); }
        else { toast(d.error || 'Import failed', 'error'); btn.disabled = false; btn.textContent = 'Start Import'; }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Per-User Streaming Limits (A8 - expand Users) ‚îÄ‚îÄ‚îÄ‚îÄ
    async function showStreamLimits(userId, username) {
        const res = await api('GET', '/admin/users/' + userId + '/stream-limits');
        const lim = res.success ? (res.data || {}) : {};
        const row = document.getElementById('user-row-' + userId);
        if (!row) return;
        // Remove any existing limit editor
        const existing = document.getElementById('stream-limits-' + userId);
        if (existing) { existing.remove(); return; }

        const editor = document.createElement('div');
        editor.id = 'stream-limits-' + userId;
        editor.className = 'stream-limits-editor';
        editor.innerHTML = `
            <div class="settings-card" style="margin:8px 0 8px 24px;padding:14px;">
                <h4 style="margin-bottom:12px;">Streaming Limits for ${username}</h4>
                <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:end;">
                    <div class="form-group" style="margin-bottom:0;flex:1;min-width:130px;">
                        <label>Max Simultaneous Streams</label>
                        <select id="slMaxStreams-${userId}">
                            <option value="0" ${(!lim.max_simultaneous_streams||lim.max_simultaneous_streams==0)?'selected':''}>Unlimited</option>
                            ${[1,2,3,4,5,8,10].map(n => `<option value="${n}" ${lim.max_simultaneous_streams==n?'selected':''}>${n}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;flex:1;min-width:130px;">
                        <label>Max Bitrate (Mbps)</label>
                        <select id="slMaxBitrate-${userId}">
                            <option value="0" ${(!lim.max_bitrate_mbps||lim.max_bitrate_mbps==0)?'selected':''}>Unlimited</option>
                            ${[2,4,8,10,15,20,40,60,80,100].map(n => `<option value="${n}" ${lim.max_bitrate_mbps==n?'selected':''}>${n} Mbps</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;flex:1;min-width:130px;">
                        <label>Remote Stream Cap (Mbps)</label>
                        <select id="slRemoteCap-${userId}">
                            <option value="0" ${(!lim.remote_bitrate_cap_mbps||lim.remote_bitrate_cap_mbps==0)?'selected':''}>Same as Max</option>
                            ${[1,2,4,8,10,15,20].map(n => `<option value="${n}" ${lim.remote_bitrate_cap_mbps==n?'selected':''}>${n} Mbps</option>`).join('')}
                        </select>
                    </div>
                    <button class="btn-primary btn-small" onclick="saveStreamLimits('${userId}')">Save</button>
                    <button class="btn-secondary btn-small" onclick="document.getElementById('stream-limits-${userId}').remove()">Cancel</button>
                </div>
            </div>`;
        row.after(editor);
    }

    async function saveStreamLimits(userId) {
        const d = await api('PUT', '/admin/users/' + userId + '/stream-limits', {
            max_simultaneous_streams: parseInt(document.getElementById('slMaxStreams-' + userId).value),
            max_bitrate_mbps: parseInt(document.getElementById('slMaxBitrate-' + userId).value),
            remote_bitrate_cap_mbps: parseInt(document.getElementById('slRemoteCap-' + userId).value)
        });
        if (d.success) {
            toast('Stream limits saved!');
            const el = document.getElementById('stream-limits-' + userId);
            if (el) el.remove();
        } else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ
    checkAuth();
    </script>
</body>
</html>
