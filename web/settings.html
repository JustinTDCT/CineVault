<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineVault ‚Äî Settings</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        /* Page-specific overrides only ‚Äî main styles in styles.css */
    </style>
</head>
<body>
    <div class="settings-container">
        <!-- Settings Sidebar -->
        <div class="settings-sidebar">
            <a class="settings-back" href="index.html">
                <span class="settings-back-icon">&#8592;</span>
                <span>Back to CineVault</span>
            </a>
            <div class="settings-logo">Settings</div>

            <div class="settings-nav-label">Playback</div>
            <div class="settings-nav-item active" data-section="video">
                <span class="settings-nav-icon">&#127916;</span><span>Video</span>
            </div>
            <div class="settings-nav-item" data-section="skip">
                <span class="settings-nav-icon">&#9193;</span><span>Skip</span>
            </div>
            <div class="settings-nav-item" data-section="transcoder">
                <span class="settings-nav-icon">&#9881;</span><span>Transcoder</span>
            </div>

            <div class="settings-nav-label">Access</div>
            <div class="settings-nav-item" data-section="users">
                <span class="settings-nav-icon">&#128101;</span><span>Users</span>
            </div>
            <div class="settings-nav-item" data-section="security">
                <span class="settings-nav-icon">&#128274;</span><span>Security</span>
            </div>
            <div class="settings-nav-item" data-section="experience">
                <span class="settings-nav-icon">&#127912;</span><span>Experience</span>
            </div>

            <div class="settings-nav-label">Content</div>
            <div class="settings-nav-item" data-section="libraries">
                <span class="settings-nav-icon">&#128218;</span><span>Libraries</span>
            </div>
            <div class="settings-nav-item" data-section="metadata">
                <span class="settings-nav-icon">&#128196;</span><span>Metadata</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="settings-main" id="settingsContent">
            <div class="spinner"></div> Loading...
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const API = '/api/v1';
    let currentUser = null;

    function headers() { return { 'Authorization': 'Bearer ' + localStorage.getItem('token'), 'Content-Type': 'application/json' }; }

    async function api(method, path, body) {
        const opts = { method, headers: headers() };
        if (body) opts.body = JSON.stringify(body);
        try { const res = await fetch(API + path, opts); return res.json(); } catch(e) { return { success: false, error: e.message }; }
    }

    function toast(msg, type='success') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast message ' + type;
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    const MEDIA_ICONS = { movies:'&#127916;', adult_movies:'&#128274;', tv_shows:'&#128250;', music:'&#127925;', music_videos:'&#127911;', home_videos:'&#127909;', other_videos:'&#128253;', images:'&#128247;', audiobooks:'&#128214;' };
    const MEDIA_LABELS = { movies:'Movies', adult_movies:'Adult Movies', tv_shows:'TV Shows', music:'Music', music_videos:'Music Videos', home_videos:'Home Videos', other_videos:'Other Videos', images:'Photos', audiobooks:'Audiobooks' };

    // ‚îÄ‚îÄ‚îÄ‚îÄ Auth Check ‚îÄ‚îÄ‚îÄ‚îÄ
    function checkAuth() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (token && user) {
            currentUser = JSON.parse(user);
            navigateSection(getInitialSection());
        } else {
            window.location.href = 'index.html';
        }
    }

    function getInitialSection() {
        const hash = window.location.hash.replace('#', '');
        return hash || 'video';
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Section Navigation ‚îÄ‚îÄ‚îÄ‚îÄ
    function navigateSection(section) {
        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        const navItem = document.querySelector(`.settings-nav-item[data-section="${section}"]`);
        if (navItem) navItem.classList.add('active');
        window.location.hash = section;

        switch(section) {
            case 'video': loadVideoSection(); break;
            case 'skip': loadSkipSection(); break;
            case 'transcoder': loadTranscoderSection(); break;
            case 'users': loadUsersSection(); break;
            case 'security': loadSecuritySection(); break;
            case 'experience': loadExperienceSection(); break;
            case 'libraries': loadLibrariesSection(); break;
            case 'metadata': loadMetadataSection(); break;
            default: loadVideoSection();
        }
    }

    document.querySelectorAll('.settings-nav-item[data-section]').forEach(item => {
        item.addEventListener('click', () => navigateSection(item.dataset.section));
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ Video Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadVideoSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Video</h2></div>
            <p class="section-desc">Configure playback preferences and video quality settings.</p>
            <div class="settings-grid" id="videoGrid"><div class="spinner"></div></div>`;

        const prefs = await api('GET', '/settings/playback');
        const p = prefs.success ? prefs.data : { playback_mode: 'always_ask', preferred_quality: '1080p', auto_play_next: true };

        document.getElementById('videoGrid').innerHTML = `
            <div class="settings-card">
                <h3>Playback Preferences</h3>
                <div class="form-group"><label>Edition Playback Mode</label>
                    <select id="setPbMode">
                        <option value="always_ask" ${p.playback_mode==='always_ask'?'selected':''}>Always Ask</option>
                        <option value="play_default" ${p.playback_mode==='play_default'?'selected':''}>Play Default</option>
                        <option value="highest_quality" ${p.playback_mode==='highest_quality'?'selected':''}>Highest Quality</option>
                        <option value="lowest_quality" ${p.playback_mode==='lowest_quality'?'selected':''}>Lowest Quality</option>
                        <option value="last_played" ${p.playback_mode==='last_played'?'selected':''}>Last Played</option>
                    </select>
                </div>
                <div class="form-group"><label>Preferred Quality</label>
                    <select id="setPbQuality">
                        <option value="360p" ${p.preferred_quality==='360p'?'selected':''}>360p</option>
                        <option value="480p" ${p.preferred_quality==='480p'?'selected':''}>480p</option>
                        <option value="720p" ${p.preferred_quality==='720p'?'selected':''}>720p</option>
                        <option value="1080p" ${p.preferred_quality==='1080p'?'selected':''}>1080p</option>
                        <option value="4K" ${p.preferred_quality==='4K'?'selected':''}>4K</option>
                    </select>
                </div>
                <div class="form-group"><label><input type="checkbox" id="setPbAutoPlay" ${p.auto_play_next?'checked':''}> Auto-play next episode</label></div>
                <button class="btn-primary" onclick="savePlaybackPrefs()">Save</button>
            </div>`;
    }

    async function savePlaybackPrefs() {
        const d = await api('PUT', '/settings/playback', {
            playback_mode: document.getElementById('setPbMode').value,
            preferred_quality: document.getElementById('setPbQuality').value,
            auto_play_next: document.getElementById('setPbAutoPlay').checked
        });
        if (d.success) toast('Playback settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Transcoder Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadTranscoderSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Transcoder</h2></div>
            <p class="section-desc">Configure hardware acceleration and transcoding quality preferences.</p>
            <div class="settings-grid" id="transcoderGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('transcoderGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure transcoder settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const hwAccel = sys.hw_accel || 'none';
        const maxTranscodes = sys.max_simultaneous_transcodes || '2';
        const defaultQuality = sys.transcode_default_quality || '1080p';
        const threadCount = sys.transcode_thread_count || '0';

        document.getElementById('transcoderGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Hardware Acceleration</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Select the hardware encoder to use for transcoding. Requires compatible GPU drivers.</p>
                <div class="form-group"><label>Hardware Encoder</label>
                    <select id="setHwAccel">
                        <option value="none" ${hwAccel==='none'?'selected':''}>None (Software / libx264)</option>
                        <option value="nvenc" ${hwAccel==='nvenc'?'selected':''}>NVIDIA NVENC</option>
                        <option value="qsv" ${hwAccel==='qsv'?'selected':''}>Intel Quick Sync (QSV)</option>
                        <option value="vaapi" ${hwAccel==='vaapi'?'selected':''}>VA-API (Linux)</option>
                    </select>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Transcode Defaults</h3>
                <div class="form-group"><label>Default Quality</label>
                    <select id="setTranscodeQuality">
                        <option value="360p" ${defaultQuality==='360p'?'selected':''}>360p</option>
                        <option value="480p" ${defaultQuality==='480p'?'selected':''}>480p</option>
                        <option value="720p" ${defaultQuality==='720p'?'selected':''}>720p</option>
                        <option value="1080p" ${defaultQuality==='1080p'?'selected':''}>1080p</option>
                        <option value="4K" ${defaultQuality==='4K'?'selected':''}>4K</option>
                    </select>
                </div>
                <div class="form-group"><label>Max Simultaneous Transcodes</label>
                    <select id="setMaxTranscodes">
                        <option value="1" ${maxTranscodes==='1'?'selected':''}>1</option>
                        <option value="2" ${maxTranscodes==='2'?'selected':''}>2</option>
                        <option value="3" ${maxTranscodes==='3'?'selected':''}>3</option>
                        <option value="4" ${maxTranscodes==='4'?'selected':''}>4</option>
                        <option value="6" ${maxTranscodes==='6'?'selected':''}>6</option>
                        <option value="8" ${maxTranscodes==='8'?'selected':''}>8</option>
                    </select>
                </div>
                <div class="form-group"><label>Thread Count</label>
                    <select id="setThreadCount">
                        <option value="0" ${threadCount==='0'?'selected':''}>Auto (recommended)</option>
                        <option value="2" ${threadCount==='2'?'selected':''}>2 threads</option>
                        <option value="4" ${threadCount==='4'?'selected':''}>4 threads</option>
                        <option value="6" ${threadCount==='6'?'selected':''}>6 threads</option>
                        <option value="8" ${threadCount==='8'?'selected':''}>8 threads</option>
                    </select>
                    <p class="settings-helper">0 = auto-detect CPU threads. Only applies to software encoding.</p>
                </div>
            </div>
            <div style="grid-column:1/-1;text-align:right;">
                <button class="btn-primary" onclick="saveTranscoderSettings()">Save</button>
            </div>`;
    }

    async function saveTranscoderSettings() {
        const settings = {
            hw_accel: document.getElementById('setHwAccel').value,
            max_simultaneous_transcodes: document.getElementById('setMaxTranscodes').value,
            transcode_default_quality: document.getElementById('setTranscodeQuality').value,
            transcode_thread_count: document.getElementById('setThreadCount').value
        };
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Transcoder settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Users Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadUsersSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Users</h2></div>
            <p class="section-desc">Manage user accounts and roles.</p>
            <div class="settings-grid" id="usersGrid"><div class="spinner"></div></div>`;

        const accountHtml = `
            <div class="settings-card">
                <h3>Current Account</h3>
                <p style="color:#8a9bae;margin-bottom:12px;">Logged in as <strong style="color:#00D9FF;">${currentUser?.username}</strong></p>
                <p style="color:#8a9bae;">Role: <span class="tag tag-cyan">${currentUser?.role}</span></p>
            </div>`;

        let usersHtml = '';
        if (currentUser?.role === 'admin') {
            const users = await api('GET', '/users');
            if (users.success && users.data) {
                // Separate master accounts and sub-profiles
                const masters = users.data.filter(u => !u.parent_user_id);
                const subs = users.data.filter(u => u.parent_user_id);
                const subsByParent = {};
                subs.forEach(u => {
                    if (!subsByParent[u.parent_user_id]) subsByParent[u.parent_user_id] = [];
                    subsByParent[u.parent_user_id].push(u);
                });

                function renderUserRow(u, isSub) {
                    const dot = `<span class="user-status-dot ${u.is_active!==false?'active':'inactive'}"></span>`;
                    const nameLabel = isSub ? (u.display_name || u.username) : u.username;
                    const isYou = u.id === currentUser.id;
                    const actions = isYou
                        ? '<span class="tag tag-green" style="font-size:0.72rem;">You</span>'
                        : `<select class="user-role-select" data-uid="${u.id}" onchange="changeUserRole('${u.id}', this.value)">
                                <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                                <option value="user" ${u.role==='user'?'selected':''}>User</option>
                                <option value="guest" ${u.role==='guest'?'selected':''}>Guest</option>
                            </select>
                            <button class="btn-secondary btn-small" onclick="toggleUserActive('${u.id}', ${u.is_active!==false?'false':'true'})" title="${u.is_active!==false?'Deactivate':'Activate'}">${u.is_active!==false?'&#128683; Disable':'&#9989; Enable'}</button>
                            <button class="btn-secondary btn-small" onclick="adminSetPin('${u.id}','${u.username}')" title="Set PIN">&#128273; PIN</button>
                            <button class="btn-danger btn-small" onclick="deleteUser('${u.id}','${u.username}')" title="Delete user">&#128465;</button>`;
                    return `<div class="user-admin-row ${isSub?'user-sub-row':''}" id="user-row-${u.id}">
                        ${dot}
                        <strong class="user-admin-name">${nameLabel}</strong>
                        <span class="tag tag-cyan">${u.role}</span>
                        <span class="user-admin-email">${u.email||''}</span>
                        ${isSub ? '<span class="tag tag-purple" style="font-size:0.68rem;">Sub-profile</span>' : ''}
                        ${u.is_kids_profile ? '<span class="tag tag-green" style="font-size:0.68rem;">Kids</span>' : ''}
                        ${u.has_pin ? '<span class="tag tag-orange" style="font-size:0.68rem;">PIN</span>' : ''}
                        <span style="flex:1;"></span>
                        ${actions}
                    </div>`;
                }

                let rowsHtml = '';
                masters.forEach(m => {
                    rowsHtml += renderUserRow(m, false);
                    const children = subsByParent[m.id] || [];
                    children.forEach(sub => { rowsHtml += renderUserRow(sub, true); });
                });

                usersHtml = `<div class="settings-card full-width">
                    <h3>All Users</h3>
                    ${rowsHtml}
                </div>`;
            }
        }

        document.getElementById('usersGrid').innerHTML = accountHtml + usersHtml;
    }

    async function changeUserRole(userId, newRole) {
        const d = await api('PUT', '/users/' + userId, { role: newRole });
        if (d.success) toast('Role updated to ' + newRole);
        else toast(d.error || 'Failed to update role', 'error');
    }

    async function toggleUserActive(userId, setActive) {
        const active = setActive === 'true' || setActive === true;
        const d = await api('PUT', '/users/' + userId, { is_active: active });
        if (d.success) { toast(active ? 'User activated' : 'User deactivated'); loadUsersSection(); }
        else toast(d.error || 'Failed to update status', 'error');
    }

    async function adminSetPin(userId, username) {
        const pin = prompt('Set new PIN for ' + username + ':');
        if (!pin) return;
        const d = await api('PUT', '/users/' + userId + '/pin', { pin: pin });
        if (d.success) toast('PIN set for ' + username);
        else toast(d.error || 'Failed to set PIN', 'error');
    }

    async function deleteUser(userId, username) {
        if (!confirm('Delete user "' + username + '"? This cannot be undone.')) return;
        const d = await api('DELETE', '/users/' + userId);
        if (d.success) { toast('User deleted'); loadUsersSection(); }
        else toast(d.error || 'Failed to delete user', 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Security Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSecuritySection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Security</h2></div>
            <p class="section-desc">Configure PIN protection and security settings for your CineVault instance.</p>
            <div class="settings-grid" id="securityGrid"><div class="spinner"></div></div>`;

        let html = `
            <div class="settings-card">
                <h3>Fast Login PIN</h3>
                <p class="settings-helper" style="margin-bottom:14px;">Set a numeric PIN for quick login via the Fast Login screen.</p>
                <div class="form-group">
                    <label>PIN</label>
                    <div style="display:flex;gap:10px;">
                        <input type="password" id="setMyPin" placeholder="Enter PIN" style="flex:1;" inputmode="numeric" maxlength="10">
                        <button class="btn-primary btn-small" onclick="saveMyPin()">Set PIN</button>
                    </div>
                </div>
            </div>`;

        if (currentUser?.role === 'admin') {
            const sysSett = await api('GET', '/settings/system');
            const sys = sysSett.success ? sysSett.data : {};
            const fastLoginEnabled = sys.fast_login_enabled !== 'false';
            const fastLoginPinLen = sys.fast_login_pin_length || '4';
            html += `
            <div class="settings-card">
                <h3>Fast Login</h3>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setFastLoginEnabled" ${fastLoginEnabled?'checked':''}><span class="toggle-slider"></span></span>
                        Use Fast Login
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:16px;">Display user icons and have them enter a PIN instead of login name and password.</p>
                <div class="form-group">
                    <label>Fast Login PIN Length</label>
                    <select id="setFastLoginPinLen">
                        <option value="4" ${fastLoginPinLen==='4'?'selected':''}>4 digits</option>
                        <option value="5" ${fastLoginPinLen==='5'?'selected':''}>5 digits</option>
                        <option value="6" ${fastLoginPinLen==='6'?'selected':''}>6 digits</option>
                        <option value="8" ${fastLoginPinLen==='8'?'selected':''}>8 digits</option>
                    </select>
                    <p class="settings-helper">The length of the PIN number for the user if using Fast Login.</p>
                </div>
                <div style="text-align:right;margin-top:16px;">
                    <button class="btn-primary" onclick="saveSecuritySettings()">Save</button>
                </div>
            </div>`;
        }

        document.getElementById('securityGrid').innerHTML = html;
    }

    async function saveMyPin() {
        const pin = document.getElementById('setMyPin').value;
        if (!pin) { toast('Please enter a PIN', 'error'); return; }
        const d = await api('PUT', '/auth/pin', { pin: pin });
        if (d.success) { toast('PIN saved!'); document.getElementById('setMyPin').value = ''; }
        else toast(d.error, 'error');
    }

    async function saveSecuritySettings() {
        const settings = {};
        const flEnabledEl = document.getElementById('setFastLoginEnabled');
        if (flEnabledEl) settings.fast_login_enabled = flEnabledEl.checked ? 'true' : 'false';
        const flPinLenEl = document.getElementById('setFastLoginPinLen');
        if (flPinLenEl) settings.fast_login_pin_length = flPinLenEl.value;
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Security settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Experience Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadExperienceSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Experience</h2></div>
            <p class="section-desc">Customize login behavior and user experience preferences.</p>
            <div class="settings-grid" id="experienceGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('experienceGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure experience settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const introEnabled = sys.login_intro_enabled !== 'false';
        const introMuted = sys.login_intro_muted === 'true';

        document.getElementById('experienceGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Login Intro</h3>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setIntroSkip" ${introEnabled?'':'checked'}><span class="toggle-slider"></span></span>
                        Skip Intro on Login
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:16px;">When disabled, a cinematic intro plays after login on each new session.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setIntroMuted" ${introMuted?'checked':''}><span class="toggle-slider"></span></span>
                        No Audio on Intro
                    </label>
                </div>
                <p class="settings-helper">Mute the intro video audio. When disabled, audio plays with the intro.</p>
                <div style="text-align:right;margin-top:20px;">
                    <button class="btn-primary" onclick="saveExperienceSettings()">Save</button>
                </div>
            </div>`;
    }

    async function saveExperienceSettings() {
        const settings = {};
        const introSkipEl = document.getElementById('setIntroSkip');
        if (introSkipEl) settings.login_intro_enabled = introSkipEl.checked ? 'false' : 'true';
        const introMutedEl = document.getElementById('setIntroMuted');
        if (introMutedEl) settings.login_intro_muted = introMutedEl.checked ? 'true' : 'false';
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Experience settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Skip Preferences Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSkipSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Skip Detection</h2></div>
            <p class="section-desc">Configure automatic intro, credits, and recap skipping behavior.</p>
            <div class="settings-grid" id="skipGrid"><div class="spinner"></div></div>`;

        const res = await api('GET', '/settings/skip');
        const prefs = res.success ? res.data : { skip_intros: false, skip_credits: false, skip_recaps: false, show_skip_button: true };
        const isAdmin = currentUser && currentUser.role === 'admin';

        document.getElementById('skipGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Skip Button Behavior</h3>
                <p class="settings-helper" style="margin-bottom:16px;">When a skip segment is detected, a "Skip Intro / Credits / Recap" button appears on the player. Enable auto-skip to skip automatically without pressing the button.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setShowSkipBtn" ${prefs.show_skip_button?'checked':''}><span class="toggle-slider"></span></span>
                        Show Skip Button
                    </label>
                </div>
                <p class="settings-helper" style="margin-bottom:20px;">Display the skip button overlay when intros, credits, or recaps are detected.</p>
                <h3 style="margin-top:24px;">Auto-Skip</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Automatically skip these segments without showing a button.</p>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipIntros" ${prefs.skip_intros?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Intros
                    </label>
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipCredits" ${prefs.skip_credits?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Credits
                    </label>
                </div>
                <div class="form-group" style="display:flex;align-items:center;gap:16px;margin-bottom:12px;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setSkipRecaps" ${prefs.skip_recaps?'checked':''}><span class="toggle-slider"></span></span>
                        Auto-skip Recaps
                    </label>
                </div>
                <div style="text-align:right;margin-top:20px;">
                    <button class="btn-primary" onclick="saveSkipPrefs()">Save</button>
                </div>
            </div>
            ${isAdmin ? `<div class="settings-card full-width">
                <h3>Detect Skip Segments</h3>
                <p class="settings-helper" style="margin-bottom:16px;">Run the skip detection engine on a library to identify intros, credits, recaps, and anime OP/ED sequences.</p>
                <div id="skipDetectLibList"><div class="spinner"></div></div>
            </div>` : ''}`;

        if (isAdmin) loadSkipDetectLibraries();
    }

    async function loadSkipDetectLibraries() {
        const libRes = await api('GET', '/libraries');
        const container = document.getElementById('skipDetectLibList');
        if (!libRes.success || !libRes.data || !libRes.data.length) {
            container.innerHTML = '<p style="color:#5a6a7f;">No libraries found.</p>';
            return;
        }
        container.innerHTML = libRes.data
            .filter(lib => lib.media_type === 'tv_shows' || lib.media_type === 'movies')
            .map(lib => `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-subtle);">
                    <div>
                        <strong>${lib.name}</strong>
                        <span class="tag tag-cyan" style="margin-left:8px;">${lib.media_type === 'tv_shows' ? 'TV Shows' : 'Movies'}</span>
                    </div>
                    <button class="btn-secondary btn-small" onclick="runSegmentDetection('${lib.id}', this)">&#128269; Detect Segments</button>
                </div>
            `).join('');
    }

    async function runSegmentDetection(libId, btn) {
        btn.disabled = true;
        btn.textContent = 'Queued...';
        const res = await api('POST', '/libraries/' + libId + '/detect-segments');
        if (res.success) {
            toast('Segment detection queued!');
            btn.textContent = 'Running...';
        } else {
            toast(res.error || 'Failed to start detection', 'error');
            btn.disabled = false;
            btn.textContent = 'üîç Detect Segments';
        }
    }

    async function saveSkipPrefs() {
        const prefs = {
            skip_intros: document.getElementById('setSkipIntros').checked,
            skip_credits: document.getElementById('setSkipCredits').checked,
            skip_recaps: document.getElementById('setSkipRecaps').checked,
            show_skip_button: document.getElementById('setShowSkipBtn').checked,
        };
        const d = await api('PUT', '/settings/skip', prefs);
        if (d.success) toast('Skip preferences saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Libraries Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadLibrariesSection() {
        const mc = document.getElementById('settingsContent');
        const isAdmin = currentUser && currentUser.role === 'admin';
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Libraries</h2>${isAdmin?'<button class="btn-primary" onclick="showCreateLibrary()">+ Add Library</button>':''}</div>
            <p class="section-desc">Manage your media libraries, folders, and scanning preferences.</p>
            <div id="libList"><div class="spinner"></div> Loading...</div>`;

        const data = await api('GET', '/libraries');
        const div = document.getElementById('libList');
        if (data.success && data.data && data.data.length > 0) {
            div.innerHTML = data.data.map(lib => {
                const accessLabel = {everyone:'Everyone',select_users:'Select People',admin_only:'Admin Only'}[lib.access_level]||'Everyone';
                const accessColor = {everyone:'tag-green',select_users:'tag-purple',admin_only:'tag-red'}[lib.access_level]||'tag-green';
                const folderPaths = (lib.folders && lib.folders.length > 0) ? lib.folders.map(f => f.folder_path).join(', ') : lib.path;
                const folderCount = (lib.folders && lib.folders.length > 1) ? `<span class="tag tag-orange" style="margin-left:6px;">${lib.folders.length} folders</span>` : '';
                let settingsTags = '';
                if (!lib.include_in_homepage) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Home</span>';
                if (!lib.include_in_search) settingsTags += '<span class="tag tag-red" style="margin-left:4px;">Hidden from Search</span>';
                if (!lib.retrieve_metadata) settingsTags += '<span class="tag tag-orange" style="margin-left:4px;">No Metadata</span>';
                if (lib.media_type === 'adult_movies' && lib.adult_content_type) settingsTags += `<span class="tag tag-purple" style="margin-left:4px;">${lib.adult_content_type === 'clips' ? 'Clips' : 'Movies'}</span>`;
                return `<div class="library-card" id="lib-card-${lib.id}"><div style="flex:1;"><h3>${lib.name}</h3><p style="color:#8a9bae;font-size:0.85rem;"><span class="tag tag-cyan">${MEDIA_LABELS[lib.media_type]||lib.media_type}</span>${lib.season_grouping?'<span class="tag tag-purple" style="margin-left:6px;">Season Grouping</span>':''}<span class="tag ${accessColor}" style="margin-left:6px;">${accessLabel}</span>${folderCount}<span style="margin-left:8px;">${folderPaths}</span></p><div class="lib-settings-tags">${settingsTags}</div><p style="color:#5a6a7f;font-size:0.78rem;margin-top:6px;">${lib.last_scan_at?'Last scan: '+new Date(lib.last_scan_at).toLocaleString():'Never scanned'}</p><div class="scan-progress" id="scan-progress-${lib.id}"><div class="scan-progress-bar"><div class="scan-progress-fill" id="scan-fill-${lib.id}"></div></div><div class="scan-progress-text"><span class="filename" id="scan-file-${lib.id}"></span><span id="scan-count-${lib.id}"></span></div></div></div><div class="library-actions">${isAdmin?`<button class="btn-secondary btn-small" onclick="showEditLibraryForm('${lib.id}')">&#9998; Edit</button><button class="btn-secondary btn-small" id="scan-btn-${lib.id}" onclick="scanLibrary('${lib.id}',this)">&#128269; Scan</button><button class="btn-danger btn-small" onclick="deleteLibrary('${lib.id}')">Delete</button>`:''}</div></div>`;
            }).join('');
        } else {
            div.innerHTML = `<div class="empty-state"><div class="empty-state-icon">&#128218;</div><div class="empty-state-title">No libraries configured</div><p>Create your first library to start organizing media</p></div>`;
        }
    }

    async function scanLibrary(id, btn) {
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Scanning...';
        const prog = document.getElementById('scan-progress-' + id);
        if (prog) prog.classList.add('active');
        try {
            const data = await api('POST', '/libraries/' + id + '/scan');
            if (data.success) {
                if (data.data.job_id) { toast('Scan job started...'); }
                else {
                    const r = data.data;
                    toast(`Scan: ${r.files_added} added, ${r.files_found} total`);
                    loadLibrariesSection();
                }
            } else {
                toast('Scan failed: ' + (data.error||'Unknown'), 'error');
                btn.disabled = false; btn.innerHTML = '&#128269; Scan';
                if (prog) prog.classList.remove('active');
            }
        } catch(e) {
            toast('Scan error: ' + e.message, 'error');
            btn.disabled = false; btn.innerHTML = '&#128269; Scan';
            if (prog) prog.classList.remove('active');
        }
    }

    async function deleteLibrary(id) {
        if (!confirm('Delete this library and all its media?')) return;
        const d = await api('DELETE', '/libraries/' + id);
        if (d.success) { toast('Library deleted'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    async function showEditLibraryForm(libId) {
        const data = await api('GET', '/libraries/' + libId);
        if (!data.success) { toast('Failed to load library', 'error'); return; }
        const lib = data.data;
        const mc = document.getElementById('settingsContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}" ${k===lib.media_type?'selected':''}>${v}</option>`).join('');
        const folders = (lib.folders && lib.folders.length > 0) ? lib.folders : [{ folder_path: lib.path }];
        const folderRows = folders.map((f, i) => `<div class="folder-row" data-idx="${i}">
            <input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;" value="${f.folder_path || ''}">
            <button class="btn-secondary" onclick="openFolderBrowser(${i})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            ${i > 0 ? '<button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>' : ''}
        </div>`).join('');

        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Edit Library</h2></div>
        <div style="max-width:560px;">
            <input type="hidden" id="editLibId" value="${lib.id}">
            <div class="form-group"><label>Name</label><input type="text" id="libName" value="${lib.name}"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" disabled>${types}</select>
                <p style="color:#5a6a7f;font-size:0.75rem;margin-top:4px;">Media type cannot be changed after creation</p>
            </div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">${folderRows}</div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="${lib.media_type === 'tv_shows' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" ${lib.season_grouping?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no" ${!lib.season_grouping?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="${lib.media_type === 'adult_movies' ? '' : 'display:none;'}">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" ${(!lib.adult_content_type || lib.adult_content_type === 'movies')?'checked':''}><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips" ${lib.adult_content_type === 'clips'?'checked':''}><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone" ${lib.access_level==='everyone'?'selected':''}>Everyone</option>
                    <option value="select_users" ${lib.access_level==='select_users'?'selected':''}>Select People</option>
                    <option value="admin_only" ${lib.access_level==='admin_only'?'selected':''}>Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="${lib.access_level==='select_users'?'':'display:none;'}margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" ${lib.include_in_homepage?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no" ${!lib.include_in_homepage?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" ${lib.include_in_search?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no" ${!lib.include_in_search?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" ${lib.retrieve_metadata?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no" ${!lib.retrieve_metadata?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Import</div>
                        <div class="option-row-desc">Read Kodi-compatible .nfo sidecar files during scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoImport" value="yes" ${lib.nfo_import?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="nfoImport" value="no" ${!lib.nfo_import?'checked':''}><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Export</div>
                        <div class="option-row-desc">Write Kodi-compatible .nfo files after metadata is resolved</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoExport" value="yes" ${lib.nfo_export?'checked':''}><span>Yes</span></label>
                        <label><input type="radio" name="nfoExport" value="no" ${!lib.nfo_export?'checked':''}><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="saveEditLibrary()">Save Changes</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesSection()">Cancel</button>
        </div>`;

        if (lib.access_level === 'select_users') {
            const usersData = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            const allowed = lib.allowed_users ? lib.allowed_users.map(u => u.toString()) : [];
            if (usersData.success && usersData.data && usersData.data.length > 0) {
                list.innerHTML = usersData.data.filter(u => u.role !== 'admin').map(u =>
                    `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}" ${allowed.includes(u.id)?'checked':''}>
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`
                ).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            }
        }
    }

    async function saveEditLibrary() {
        const id = document.getElementById('editLibId').value;
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const nfo_import = document.querySelector('input[name="nfoImport"]:checked')?.value === 'yes';
        const nfo_export = document.querySelector('input[name="nfoExport"]:checked')?.value === 'yes';

        const d = await api('PUT', '/libraries/' + id, {
            name, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type,
            nfo_import, nfo_export
        });
        if (d.success) { toast('Library updated!'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    function showCreateLibrary() {
        const mc = document.getElementById('settingsContent');
        const types = Object.entries(MEDIA_LABELS).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Create Library</h2></div>
        <div style="max-width:560px;">
            <div class="form-group"><label>Name</label><input type="text" id="libName" placeholder="My Movies"></div>
            <div class="form-group"><label>Media Type</label><select id="libType" onchange="onLibTypeChange()">${types}</select></div>

            <div class="form-group">
                <label>Folders</label>
                <p style="color:#8a9bae;font-size:0.78rem;margin-bottom:8px;">At least one folder is required. Add more to scan multiple locations.</p>
                <div class="folder-list" id="folderList">
                    <div class="folder-row" data-idx="0">
                        <input type="text" class="lib-folder-input" placeholder="/media/movies" style="flex:1;">
                        <button class="btn-secondary" onclick="openFolderBrowser(0)" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
                    </div>
                </div>
                <button class="folder-add-btn" onclick="addFolderRow()">+ Add Folder</button>
            </div>
            <div id="pathBrowser" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;max-height:350px;overflow-y:auto;"></div>

            <div id="seasonGroupingOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Group by Season</div>
                        <div class="option-row-desc">Parse SxxExx from filenames to group episodes by season</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="seasonGrouping" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="seasonGrouping" value="no"><span>No</span></label>
                    </div>
                </div>
            </div>

            <div id="adultContentOpt" style="display:none;">
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Content Type</div>
                        <div class="option-row-desc">Clips &amp; Scenes will not retrieve metadata. Movies will scrape from TMDB.</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="adultContentType" value="movies" checked><span>Movies</span></label>
                        <label><input type="radio" name="adultContentType" value="clips"><span>Clips</span></label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Library Permissions</label>
                <select id="libAccess" onchange="onAccessChange()">
                    <option value="everyone">Everyone</option>
                    <option value="select_users">Select People</option>
                    <option value="admin_only">Admin Only</option>
                </select>
            </div>
            <div id="userSelectPanel" style="display:none;margin-bottom:18px;background:rgba(0,0,0,0.3);border:1px solid rgba(0,217,255,0.15);border-radius:12px;padding:14px;">
                <p style="color:#8a9bae;font-size:0.8rem;margin-bottom:10px;">Select users who can access this library:</p>
                <div id="userCheckboxList"><div class="spinner"></div></div>
            </div>

            <div style="margin-bottom:18px;">
                <label style="display:block;margin-bottom:10px;font-weight:600;color:#e5e5e5;">Library Options</label>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Homepage</div>
                        <div class="option-row-desc">Show this library's media on the home screen</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeHomepage" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeHomepage" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">Include in Search</div>
                        <div class="option-row-desc">Allow this library's items to appear in search results</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="includeSearch" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="includeSearch" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row" id="metadataOpt">
                    <div class="option-row-info">
                        <div class="option-row-label">Retrieve Metadata</div>
                        <div class="option-row-desc">Auto-populate from TMDB/MusicBrainz/OpenLibrary on scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="retrieveMetadata" value="yes" checked><span>Yes</span></label>
                        <label><input type="radio" name="retrieveMetadata" value="no"><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Import</div>
                        <div class="option-row-desc">Read Kodi-compatible .nfo sidecar files during scan</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoImport" value="yes"><span>Yes</span></label>
                        <label><input type="radio" name="nfoImport" value="no" checked><span>No</span></label>
                    </div>
                </div>
                <div class="option-row">
                    <div class="option-row-info">
                        <div class="option-row-label">NFO Export</div>
                        <div class="option-row-desc">Write Kodi-compatible .nfo files after metadata is resolved</div>
                    </div>
                    <div class="toggle-btns">
                        <label><input type="radio" name="nfoExport" value="yes"><span>Yes</span></label>
                        <label><input type="radio" name="nfoExport" value="no" checked><span>No</span></label>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="createLibrary()">Create Library</button>
            <button class="btn-secondary" style="margin-left:12px;" onclick="loadLibrariesSection()">Cancel</button>
        </div>`;
        onLibTypeChange();
    }

    let activeFolderIdx = null;

    function addFolderRow() {
        const list = document.getElementById('folderList');
        const idx = list.children.length;
        const row = document.createElement('div');
        row.className = 'folder-row';
        row.dataset.idx = idx;
        row.innerHTML = `<input type="text" class="lib-folder-input" placeholder="/media/folder" style="flex:1;">
            <button class="btn-secondary" onclick="openFolderBrowser(${idx})" style="white-space:nowrap;padding:8px 12px;font-size:0.8rem;">&#128193; Browse</button>
            <button class="folder-remove" onclick="removeFolderRow(this)" title="Remove folder">&#10005;</button>`;
        list.appendChild(row);
    }

    function removeFolderRow(btn) {
        const row = btn.closest('.folder-row');
        const list = document.getElementById('folderList');
        if (list.children.length <= 1) { toast('At least one folder is required', 'error'); return; }
        row.remove();
    }

    function openFolderBrowser(idx) {
        activeFolderIdx = idx;
        const inputs = document.querySelectorAll('.lib-folder-input');
        const currentPath = inputs[idx]?.value || '/media';
        openPathBrowser(currentPath);
    }

    function onLibTypeChange() {
        const type = document.getElementById('libType').value;
        const seasonOpt = document.getElementById('seasonGroupingOpt');
        const adultOpt = document.getElementById('adultContentOpt');
        if (seasonOpt) seasonOpt.style.display = (type === 'tv_shows') ? '' : 'none';
        if (adultOpt) adultOpt.style.display = (type === 'adult_movies') ? '' : 'none';
    }

    async function onAccessChange() {
        const val = document.getElementById('libAccess').value;
        const panel = document.getElementById('userSelectPanel');
        if (val === 'select_users') {
            panel.style.display = '';
            const data = await api('GET', '/users');
            const list = document.getElementById('userCheckboxList');
            if (data.success && data.data && data.data.length > 0) {
                list.innerHTML = data.data
                    .filter(u => u.role !== 'admin')
                    .map(u => `<label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;color:#e5e5e5;">
                        <input type="checkbox" class="user-perm-cb" value="${u.id}">
                        <span>${u.username}</span>
                        <span style="color:#5a6a7f;font-size:0.75rem;margin-left:auto;">${u.role}</span>
                    </label>`).join('');
                if (list.innerHTML === '') list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No non-admin users found</p>';
            } else {
                list.innerHTML = '<p style="color:#5a6a7f;font-size:0.85rem;">No users found</p>';
            }
        } else {
            panel.style.display = 'none';
        }
    }

    async function openPathBrowser(path) {
        const browser = document.getElementById('pathBrowser');
        browser.style.display = 'block';
        await loadPathEntries(path || '/media');
    }

    async function loadPathEntries(path) {
        const browser = document.getElementById('pathBrowser');
        browser.innerHTML = '<div class="spinner" style="margin:10px auto;"></div>';
        const data = await api('GET', '/browse?path=' + encodeURIComponent(path));
        if (!data.success) { browser.innerHTML = '<p style="color:#ff5555;">Failed to browse</p>'; return; }
        const d = data.data;
        let html = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(0,217,255,0.1);">
            <span style="color:#00D9FF;font-size:0.8rem;font-weight:600;">&#128194; ${d.path}</span>
            <button class="btn-secondary" style="margin-left:auto;padding:4px 12px;font-size:0.75rem;" onclick="selectBrowsePath('${d.path}')">&#10003; Select This</button>
        </div>`;
        if (d.parent) {
            html += `<div onclick="loadPathEntries('${d.parent}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#8a9bae;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#11168; ..</div>`;
        }
        if (d.entries && d.entries.length > 0) {
            d.entries.forEach(e => {
                html += `<div onclick="loadPathEntries('${e.path}')" style="display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer;border-radius:8px;color:#e5e5e5;font-size:0.85rem;transition:background 0.2s;" onmouseover="this.style.background='rgba(0,217,255,0.08)'" onmouseout="this.style.background='transparent'">&#128193; ${e.name}</div>`;
            });
        } else if (!d.parent) {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">No subdirectories</p>';
        } else {
            html += '<p style="color:#5a6a7f;font-size:0.8rem;text-align:center;margin:12px 0;">Empty folder</p>';
        }
        browser.innerHTML = html;
    }

    function selectBrowsePath(path) {
        if (activeFolderIdx !== null) {
            const inputs = document.querySelectorAll('.lib-folder-input');
            if (inputs[activeFolderIdx]) inputs[activeFolderIdx].value = path;
            activeFolderIdx = null;
        }
        document.getElementById('pathBrowser').style.display = 'none';
    }

    async function createLibrary() {
        const name = document.getElementById('libName').value;
        const media_type = document.getElementById('libType').value;
        const folderInputs = document.querySelectorAll('.lib-folder-input');
        const folders = [...folderInputs].map(i => i.value.trim()).filter(Boolean);
        if (!name || folders.length === 0) { toast('Name and at least one folder required', 'error'); return; }

        const season_grouping = media_type === 'tv_shows' && document.querySelector('input[name="seasonGrouping"]:checked')?.value === 'yes';
        const access_level = document.getElementById('libAccess').value;
        const allowed_users = [...document.querySelectorAll('.user-perm-cb:checked')].map(cb => cb.value);
        const include_in_homepage = document.querySelector('input[name="includeHomepage"]:checked')?.value === 'yes';
        const include_in_search = document.querySelector('input[name="includeSearch"]:checked')?.value === 'yes';
        const retrieve_metadata = document.querySelector('input[name="retrieveMetadata"]:checked')?.value === 'yes';

        let adult_content_type = null;
        if (media_type === 'adult_movies') {
            adult_content_type = document.querySelector('input[name="adultContentType"]:checked')?.value || 'movies';
        }

        const nfo_import = document.querySelector('input[name="nfoImport"]:checked')?.value === 'yes';
        const nfo_export = document.querySelector('input[name="nfoExport"]:checked')?.value === 'yes';

        const d = await api('POST', '/libraries', {
            name, media_type, path: folders[0], folders, is_enabled: true,
            season_grouping, access_level, allowed_users,
            include_in_homepage, include_in_search, retrieve_metadata, adult_content_type,
            nfo_import, nfo_export
        });
        if (d.success) { toast('Library created!'); loadLibrariesSection(); }
        else toast('Failed: ' + d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Metadata Section ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadMetadataSection() {
        const mc = document.getElementById('settingsContent');
        mc.innerHTML = `<div class="section-header"><h2 class="section-title">Metadata</h2></div>
            <p class="section-desc">Configure metadata sources, cache server, and API keys.</p>
            <div class="settings-grid" id="metadataGrid"><div class="spinner"></div></div>`;

        if (currentUser?.role !== 'admin') {
            document.getElementById('metadataGrid').innerHTML = `<div class="settings-card">
                <h3>Access Restricted</h3>
                <p style="color:#8a9bae;">Only administrators can configure metadata settings.</p>
            </div>`;
            return;
        }

        const sysSett = await api('GET', '/settings/system');
        const sys = sysSett.success ? sysSett.data : {};
        const cacheEnabled = sys.cache_server_enabled !== 'false';
        const cacheRegistered = sys.cache_server_api_key === 'registered';

        document.getElementById('metadataGrid').innerHTML = `
            <div class="settings-card full-width">
                <h3>Metadata Cache Server</h3>
                <p style="color:#8a9bae;margin-bottom:16px;">Speed up metadata lookups by using the CineVault cache server. When enabled, cached results are used first; if the cache is unavailable, CineVault falls back to direct TMDB/OMDb API calls automatically.</p>
                <div class="form-group" style="display:flex;align-items:center;justify-content:space-between;">
                    <label class="toggle-label" style="margin-bottom:0;">
                        <span class="toggle-switch"><input type="checkbox" id="setCacheEnabled" ${cacheEnabled?'checked':''}><span class="toggle-slider"></span></span>
                        Enable Cache Server
                    </label>
                    <span style="font-size:0.8rem;color:${cacheRegistered?'#4caf50':'#5a6a7f'};">
                        <span class="status-dot ${cacheRegistered?'green':''}"></span>
                        ${cacheRegistered?'Registered':'Not yet registered'}
                    </span>
                </div>
            </div>
            <div class="settings-card full-width">
                <h3>Metadata Enrichment</h3>
                <p style="color:#8a9bae;margin-bottom:16px;">Configure external API keys for additional metadata enrichment. An OMDb API key enables IMDB ratings, Rotten Tomatoes scores, and audience scores.</p>
                <div class="form-group">
                    <label>OMDb API Key</label>
                    <div style="display:flex;gap:10px;">
                        <input type="password" id="setOmdbKey" value="${sys.omdb_api_key||''}" placeholder="Enter your OMDb API key" style="flex:1;">
                        <button class="btn-secondary" onclick="document.getElementById('setOmdbKey').type=document.getElementById('setOmdbKey').type==='password'?'text':'password'">&#128065;</button>
                    </div>
                    <p style="color:#5a6a7f;font-size:0.78rem;margin-top:6px;">Get a free key at <a href="https://www.omdbapi.com/apikey.aspx" target="_blank" style="color:#00D9FF;">omdbapi.com</a></p>
                </div>
            </div>
            <div style="grid-column:1/-1;text-align:right;">
                <button class="btn-primary" onclick="saveMetadataSettings()">Save Settings</button>
            </div>`;
    }

    async function saveMetadataSettings() {
        const settings = {};
        const omdbEl = document.getElementById('setOmdbKey');
        if (omdbEl) settings.omdb_api_key = omdbEl.value.trim();
        const cacheEnabledEl = document.getElementById('setCacheEnabled');
        if (cacheEnabledEl) settings.cache_server_enabled = cacheEnabledEl.checked ? 'true' : 'false';
        const d = await api('PUT', '/settings/system', settings);
        if (d.success) toast('Metadata settings saved!'); else toast(d.error, 'error');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ
    checkAuth();
    </script>
</body>
</html>
